{% extends "base.html" %}

{% block title %}CineOrg — Traitement{% endblock %}
{% block nav_workflow %}active{% endblock %}

{% block content %}
<section class="hero">
    <h1 class="hero-title">Traitement</h1>
    <p class="hero-subtitle">Lancer le scan, matching et auto-validation des fichiers</p>
</section>

{% if not running %}
{# ── Formulaire de lancement ── #}
<section class="workflow-launch" id="workflow-launch">
    <div class="workflow-launch-card">
        <div class="workflow-launch-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        </div>
        <div class="workflow-launch-content">
            <h2 class="workflow-launch-title">Lancer le traitement</h2>
            <p class="workflow-launch-desc">
                Scanne les téléchargements, recherche les correspondances via TMDB/TVDB
                et auto-valide les fichiers avec un score suffisant.
            </p>
            <form class="workflow-form"
                  hx-post="/workflow/start"
                  hx-target="#workflow-zone"
                  hx-swap="innerHTML">
                <div class="workflow-form-row">
                    <label class="workflow-label" for="filter_type">Filtrer par type</label>
                    <select name="filter_type" id="filter_type" class="workflow-select">
                        <option value="all">Tous</option>
                        <option value="movies">Films uniquement</option>
                        <option value="series">Séries uniquement</option>
                    </select>
                </div>
                <button type="submit" class="workflow-start-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Lancer le traitement
                </button>
            </form>
        </div>
    </div>
</section>
{% endif %}

{# ── Zone dynamique (progression / résultats) ── #}
<section id="workflow-zone">
    {% if running and progress %}
        {% include "workflow/_progress.html" %}
    {% elif progress and progress.complete and not progress.error %}
        {% include "workflow/_results.html" %}
    {% endif %}
</section>

{# ── Contexte actuel ── #}
{% if not running %}
<section class="workflow-status">
    <h2 class="section-title">État actuel</h2>
    <div class="workflow-status-grid">
        <div class="workflow-status-item">
            <span class="workflow-status-value {% if pending_count > 0 %}has-pending{% endif %}">{{ pending_count }}</span>
            <span class="workflow-status-label">En attente de validation</span>
            {% if pending_count > 0 %}
            <a href="/validation" class="workflow-status-link">Voir →</a>
            {% endif %}
        </div>
        <div class="workflow-status-item">
            <span class="workflow-status-value">{{ validated_count }}</span>
            <span class="workflow-status-label">Validé(s), en attente de transfert</span>
        </div>
    </div>
</section>
{% endif %}

{# ── Pipeline visuel ── #}
<section class="workflow-pipeline">
    <h2 class="section-title">Pipeline de traitement</h2>
    <div class="pipeline-steps">
        <div class="pipeline-step">
            <div class="pipeline-step-num">1</div>
            <div class="pipeline-step-info">
                <span class="pipeline-step-name">Scan</span>
                <span class="pipeline-step-desc">Détection des fichiers vidéo</span>
            </div>
        </div>
        <div class="pipeline-arrow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="pipeline-step">
            <div class="pipeline-step-num">2</div>
            <div class="pipeline-step-info">
                <span class="pipeline-step-name">Matching</span>
                <span class="pipeline-step-desc">Recherche TMDB/TVDB</span>
            </div>
        </div>
        <div class="pipeline-arrow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="pipeline-step">
            <div class="pipeline-step-num">3</div>
            <div class="pipeline-step-info">
                <span class="pipeline-step-name">Auto-validation</span>
                <span class="pipeline-step-desc">Score ≥ 85% → validé</span>
            </div>
        </div>
        <div class="pipeline-arrow">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
        <div class="pipeline-step">
            <div class="pipeline-step-num">4</div>
            <div class="pipeline-step-info">
                <span class="pipeline-step-name">Validation manuelle</span>
                <span class="pipeline-step-desc">Via la page Validation</span>
            </div>
        </div>
    </div>
</section>
{% endblock %}
