{% extends "base.html" %}

{% block title %}{{ movie.title }} — CineOrg{% endblock %}
{% block nav_library %}active{% endblock %}

{% block content %}
<div class="library-detail-page">
    <div class="back-links">
        <a href="javascript:history.back()" class="back-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            Retour
        </a>
        <a href="/library" class="back-link back-link-home">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Bibliothèque
        </a>
    </div>

    <div class="lib-detail-header">
        <div class="lib-detail-poster poster-zoomable" {% if poster_url %}onclick="openPosterLightbox('{{ poster_url }}')"{% endif %}>
            {% if poster_url %}
            <img src="{{ poster_url.replace('/w300', '/w500') }}" alt="{{ movie.title }}">
            <div class="poster-zoom-hint">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
            </div>
            {% else %}
            <div class="lib-card-no-poster lib-detail-no-poster">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/><line x1="17" y1="17" x2="22" y2="17"/></svg>
            </div>
            {% endif %}
        </div>

        <div class="lib-detail-info">
            <div class="lib-detail-badges">
                <span class="type-badge badge-film">Film</span>
                {% if movie.imdb_rating %}
                <span class="lib-rating-badge lib-rating-imdb">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    {{ movie.imdb_rating }} IMDb
                </span>
                {% endif %}
                {% if movie.vote_average %}
                <span class="lib-rating-badge {% if movie.vote_average >= 7 %}score-high{% elif movie.vote_average >= 5 %}score-medium{% else %}score-low{% endif %}">
                    {{ '%.1f'|format(movie.vote_average) }} TMDB
                </span>
                {% endif %}
                {% if movie.imdb_id %}
                <a href="https://www.imdb.com/title/{{ movie.imdb_id }}/" target="_blank" rel="noopener" class="lib-external-link lib-external-imdb">IMDb</a>
                {% endif %}
                {% if movie.tmdb_id %}
                <a href="https://www.themoviedb.org/movie/{{ movie.tmdb_id }}" target="_blank" rel="noopener" class="lib-external-link lib-external-tmdb">TMDB</a>
                {% endif %}
                <button class="reassociate-btn" hx-get="/library/movies/{{ movie.id }}/reassociate" hx-target="#reassociate-container" hx-swap="innerHTML" title="Corriger l'association TMDB">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Corriger
                </button>
                <button class="play-btn"
                    hx-post="/library/movies/{{ movie.id }}/play"
                    hx-swap="outerHTML"
                    title="Ouvrir dans mpv">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Visionner
                </button>
            </div>

            <h1 class="lib-detail-title">{{ movie.title }}</h1>
            {% if movie.original_title and movie.original_title != movie.title %}
            <p class="lib-detail-original-title">{{ movie.original_title }}</p>
            {% endif %}

            <div class="lib-detail-meta-row">
                {% if movie.year %}<span class="lib-detail-meta-item">{{ movie.year }}</span>{% endif %}
                {% if duration %}<span class="lib-detail-meta-item">{{ duration }}</span>{% endif %}
            </div>

            {% if genres %}
            <div class="lib-detail-genres">
                {% for g in genres %}
                <a href="/library/?genre={{ g | urlencode }}" class="genre-tag {% if storage_genre and g == storage_genre %}genre-tag-storage{% endif %}">{{ g }}{% if storage_genre and g == storage_genre %} <span class="genre-storage-indicator" title="Genre de rangement">&#9679;</span>{% endif %}</a>
                {% endfor %}
                {% if storage_folder and storage_folder not in genres %}
                <span class="genre-tag genre-tag-storage genre-tag-mapped" title="Rangé dans ce dossier">{{ storage_folder }}</span>
                {% endif %}
            </div>
            {% endif %}

            {% if resolution_label or movie.codec_video or movie.codec_audio or languages %}
            <div class="lib-detail-tech-badges">
                {% if resolution_label %}
                <a href="/library/?resolution={{ resolution_label }}" class="tech-badge tech-badge-resolution">{{ resolution_label }}</a>
                {% endif %}
                {% if movie.codec_video %}
                <a href="/library/?codec_video={{ movie.codec_video }}" class="tech-badge tech-badge-codec">{{ movie.codec_video }}</a>
                {% endif %}
                {% if movie.codec_audio %}
                <a href="/library/?codec_audio={{ movie.codec_audio }}" class="tech-badge tech-badge-codec">{{ movie.codec_audio }}</a>
                {% endif %}
                {% if languages|length > 1 %}
                <span class="tech-badge tech-badge-lang tech-badge-multi">Multi</span>
                {% endif %}
                {% for lang in languages %}
                <span class="tech-badge tech-badge-lang {% if languages|length > 1 %}tech-badge-lang-mini{% endif %}">{{ lang }}</span>
                {% endfor %}
            </div>
            {% endif %}

            {% if movie.director or movie.cast %}
            <div class="lib-detail-credits">
                {% if movie.director %}
                <div class="lib-detail-credit-row">
                    <span class="lib-credit-label">Réalisateur</span>
                    <span class="lib-credit-value"><a href="/library/?person={{ movie.director | urlencode }}&person_role=director" class="lib-credit-link">{{ movie.director }}</a></span>
                </div>
                {% endif %}
                {% if movie.cast %}
                <div class="lib-detail-credit-row">
                    <span class="lib-credit-label">Acteurs</span>
                    <span class="lib-credit-value">{% for actor in movie.cast %}<a href="/library/?person={{ actor | urlencode }}&person_role=actor" class="lib-credit-link">{{ actor }}</a>{% if not loop.last %}, {% endif %}{% endfor %}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if movie.overview %}
            <div class="lib-detail-synopsis">
                <h3 class="lib-detail-section-title">Synopsis</h3>
                <p>{{ movie.overview }}</p>
            </div>
            {% endif %}

            {% if movie.file_path or video_file or file_info or movie.tmdb_id %}
            <details class="lib-detail-file-toggle">
                <summary class="lib-file-toggle-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Informations fichier
                    <svg class="lib-file-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </summary>
                <div class="lib-file-details">
                    {# Cas 1 : file_path en DB #}
                    {% if movie.file_path %}
                    <div class="lib-file-row">
                        <span class="lib-file-label">Fichier storage</span>
                        <code class="lib-file-path">{{ movie.file_path }}</code>
                    </div>
                    {% endif %}
                    {% if video_file and video_file.symlink_path %}
                    <div class="lib-file-row">
                        <span class="lib-file-label">Symlink video</span>
                        <code class="lib-file-path">{{ video_file.symlink_path }}</code>
                    </div>
                    {% endif %}
                    {# Cas 2 : fichier trouve dans video/ par titre #}
                    {% if file_info %}
                    <div class="lib-file-row">
                        <span class="lib-file-label">Symlink video</span>
                        <code class="lib-file-path">{{ file_info.symlink_path }}</code>
                    </div>
                    {% if file_info.storage_path %}
                    <div class="lib-file-row">
                        <span class="lib-file-label">Fichier storage</span>
                        <code class="lib-file-path">{{ file_info.storage_path }}</code>
                    </div>
                    {% endif %}
                    {% endif %}
                    {# Infos techniques #}
                    {% if video_file %}
                    <div class="lib-file-row lib-file-tech">
                        {% if video_file.codec_video %}<span>{{ video_file.codec_video }}</span>{% endif %}
                        {% if video_file.codec_audio %}<span>{{ video_file.codec_audio }}</span>{% endif %}
                        {% if video_file.resolution_width %}<span>{{ video_file.resolution_width }}x{{ video_file.resolution_height }}</span>{% endif %}
                        {% if video_file.size_bytes %}<span>{{ '%.1f'|format(video_file.size_bytes / 1073741824) }} Go</span>{% endif %}
                    </div>
                    {% elif movie.codec_video or movie.resolution %}
                    <div class="lib-file-row lib-file-tech">
                        {% if movie.codec_video %}<span>{{ movie.codec_video }}</span>{% endif %}
                        {% if movie.codec_audio %}<span>{{ movie.codec_audio }}</span>{% endif %}
                        {% if movie.resolution %}<span>{{ movie.resolution }}</span>{% endif %}
                        {% if movie.file_size_bytes %}<span>{{ '%.1f'|format(movie.file_size_bytes / 1073741824) }} Go</span>{% endif %}
                    </div>
                    {% endif %}
                    {# IDs externes #}
                    {% if movie.tmdb_id %}
                    <div class="lib-file-row">
                        <span class="lib-file-label">IDs</span>
                        <span class="lib-file-ids">
                            TMDB: {{ movie.tmdb_id }}
                            {% if movie.imdb_id %} · IMDb: {{ movie.imdb_id }}{% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endif %}
        </div>
    </div>
</div>

<!-- Container pour l'overlay de re-association -->
<div id="reassociate-container"></div>

<!-- Lightbox zoom jaquette -->
<div class="poster-lightbox" id="poster-lightbox" onclick="this.classList.remove('active')">
    <img id="poster-lightbox-img" src="" alt="">
</div>
<script>
function openPosterLightbox(src) {
    var lb = document.getElementById('poster-lightbox');
    document.getElementById('poster-lightbox-img').src = src.replace('/w300', '/w500');
    lb.classList.add('active');
}
/* Navigation prev/next */
(function() {
    var list = JSON.parse(sessionStorage.getItem('lib_nav_list') || '[]');
    var current = window.location.pathname;
    var idx = list.indexOf(current);
    if (idx < 0 || list.length < 2) return;
    var prev = idx > 0 ? list[idx - 1] : null;
    var next = idx < list.length - 1 ? list[idx + 1] : null;
    var nav = document.createElement('div');
    nav.className = 'lib-detail-nav';
    nav.innerHTML =
        (prev ? '<a href="' + prev + '" class="lib-detail-nav-btn lib-detail-nav-prev" title="Précédent (←)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></a>' : '<span></span>') +
        '<span class="lib-detail-nav-pos">' + (idx + 1) + ' / ' + list.length + '</span>' +
        (next ? '<a href="' + next + '" class="lib-detail-nav-btn lib-detail-nav-next" title="Suivant (→)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 6 15 12 9 18"/></svg></a>' : '<span></span>');
    var header = document.querySelector('.lib-detail-header');
    if (header) header.parentNode.insertBefore(nav, header);
    /* Prefetch pages adjacentes */
    [prev, next].forEach(function(url) {
        if (url) {
            var link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url;
            document.head.appendChild(link);
        }
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { document.getElementById('poster-lightbox').classList.remove('active'); return; }
        if (document.querySelector('.reassociate-overlay')) return;
        if (e.key === 'ArrowLeft' && prev) window.location.href = prev;
        if (e.key === 'ArrowRight' && next) window.location.href = next;
    });
})();
</script>
{% endblock %}
