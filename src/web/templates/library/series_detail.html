{% extends "base.html" %}

{% block title %}{{ series.title }} — CineOrg{% endblock %}
{% block nav_library %}active{% endblock %}

{% block content %}
<div class="library-detail-page">
    <div class="back-links">
        <a href="javascript:history.back()" class="back-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            Retour
        </a>
        <a href="/library" class="back-link back-link-home">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Bibliothèque
        </a>
    </div>

    <div class="lib-detail-header">
        <div class="lib-detail-poster poster-zoomable" {% if poster_url %}onclick="openPosterLightbox('{{ poster_url }}')"{% endif %}>
            {% if poster_url %}
            <img src="{{ poster_url.replace('/w300', '/w500') }}" alt="{{ series.title }}">
            <div class="poster-zoom-hint">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
            </div>
            {% else %}
            <div class="lib-card-no-poster lib-detail-no-poster">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/><line x1="17" y1="17" x2="22" y2="17"/></svg>
            </div>
            {% endif %}
        </div>

        <div class="lib-detail-info">
            <div class="lib-detail-badges">
                <span class="type-badge badge-series">Serie</span>
                {% if series.imdb_rating %}
                <span class="lib-rating-badge lib-rating-imdb">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    {{ series.imdb_rating }} IMDb
                </span>
                {% endif %}
                {% if series.vote_average %}
                <span class="lib-rating-badge {% if series.vote_average >= 7 %}score-high{% elif series.vote_average >= 5 %}score-medium{% else %}score-low{% endif %}">
                    {{ '%.1f'|format(series.vote_average) }} TMDB
                </span>
                {% endif %}
                {% if series.imdb_id %}
                <a href="https://www.imdb.com/title/{{ series.imdb_id }}/" target="_blank" rel="noopener" class="lib-external-link lib-external-imdb">IMDb</a>
                {% endif %}
                {% if series.tmdb_id %}
                <a href="https://www.themoviedb.org/tv/{{ series.tmdb_id }}" target="_blank" rel="noopener" class="lib-external-link lib-external-tmdb">TMDB</a>
                {% endif %}
                <button class="reassociate-btn" hx-get="/library/series/{{ series.id }}/reassociate" hx-target="#reassociate-container" hx-swap="innerHTML" title="Corriger l'association TMDB">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Corriger
                </button>
            </div>

            <h1 class="lib-detail-title">{{ series.title }}</h1>
            {% if series.original_title and series.original_title != series.title %}
            <p class="lib-detail-original-title">{{ series.original_title }}</p>
            {% endif %}

            <div class="lib-detail-meta-row">
                {% if series.year %}<span class="lib-detail-meta-item">{{ series.year }}</span>{% endif %}
                <span class="lib-detail-meta-item">{{ seasons|length }} saison{{ 's' if seasons|length != 1 else '' }}</span>
                <span class="lib-detail-meta-item">{{ total_episodes }} épisode{{ 's' if total_episodes != 1 else '' }}</span>
            </div>

            {% if genres %}
            <div class="lib-detail-genres">
                {% for g in genres %}
                <a href="/library/?genre={{ g | urlencode }}" class="genre-tag">{{ g }}</a>
                {% endfor %}
            </div>
            {% endif %}

            {% if ep_resolutions or ep_codecs_video or ep_codecs_audio or ep_languages %}
            <div class="lib-detail-tech-badges">
                {% for r in ep_resolutions %}
                <span class="tech-badge tech-badge-resolution">{{ r }}</span>
                {% endfor %}
                {% for c in ep_codecs_video %}
                <span class="tech-badge tech-badge-codec">{{ c }}</span>
                {% endfor %}
                {% for c in ep_codecs_audio %}
                <span class="tech-badge tech-badge-codec">{{ c }}</span>
                {% endfor %}
                {% if ep_languages|length > 1 %}
                <span class="tech-badge tech-badge-lang tech-badge-multi">Multi</span>
                {% endif %}
                {% for lang in ep_languages %}
                <span class="tech-badge tech-badge-lang {% if ep_languages|length > 1 %}tech-badge-lang-mini{% endif %}">{{ lang }}</span>
                {% endfor %}
            </div>
            {% endif %}

            {% if series.director or series.cast %}
            <div class="lib-detail-credits">
                {% if series.director %}
                <div class="lib-detail-credit-row">
                    <span class="lib-credit-label">Créateur{{ 's' if ', ' in (series.director or '') else '' }}</span>
                    <span class="lib-credit-value"><a href="/library/?person={{ series.director | urlencode }}&person_role=director" class="lib-credit-link">{{ series.director }}</a></span>
                </div>
                {% endif %}
                {% if series.cast %}
                <div class="lib-detail-credit-row">
                    <span class="lib-credit-label">Acteurs</span>
                    <span class="lib-credit-value">{% for actor in series.cast %}<a href="/library/?person={{ actor | urlencode }}&person_role=actor" class="lib-credit-link">{{ actor }}</a>{% if not loop.last %}, {% endif %}{% endfor %}</span>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if series.overview %}
            <div class="lib-detail-synopsis">
                <h3 class="lib-detail-section-title">Synopsis</h3>
                <p>{{ series.overview }}</p>
            </div>
            {% endif %}

            {% if series.tvdb_id or series.tmdb_id or series.imdb_id %}
            <details class="lib-detail-file-toggle">
                <summary class="lib-file-toggle-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    Informations techniques
                    <svg class="lib-file-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </summary>
                <div class="lib-file-details">
                    <div class="lib-file-row">
                        <span class="lib-file-label">IDs</span>
                        <span class="lib-file-ids">
                            {% if series.tmdb_id %}TMDB: {{ series.tmdb_id }}{% endif %}
                            {% if series.tvdb_id %}{% if series.tmdb_id %} · {% endif %}TVDB: {{ series.tvdb_id }}{% endif %}
                            {% if series.imdb_id %}{% if series.tmdb_id or series.tvdb_id %} · {% endif %}IMDb: {{ series.imdb_id }}{% endif %}
                        </span>
                    </div>
                </div>
            </details>
            {% endif %}
        </div>
    </div>

    <!-- Saisons et episodes -->
    <div class="lib-seasons">
        {% for season_num, episodes in seasons.items() %}
        <details class="lib-season-group" {{ 'open' if loop.first else '' }}>
            <summary class="lib-season-header">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                <span class="lib-season-title">Saison {{ season_num }}</span>
                <span class="lib-season-count">{{ episodes|length }} épisode{{ 's' if episodes|length != 1 else '' }}</span>
            </summary>
            <div class="lib-episode-list">
                {% for ep in episodes %}
                <div class="lib-episode-row">
                    <span class="lib-episode-num">E{{ '%02d'|format(ep.episode_number) }}</span>
                    <span class="lib-episode-title">{{ ep.title or 'Épisode ' ~ ep.episode_number }}</span>
                    {% if ep.file_path %}
                    <button class="lib-episode-play-btn"
                        hx-post="/library/episodes/{{ ep.id }}/play"
                        hx-swap="outerHTML"
                        title="Ouvrir dans mpv">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    </button>
                    <button class="lib-episode-file-btn" onclick="this.nextElementSibling.classList.toggle('visible')" title="Afficher le fichier">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    </button>
                    <div class="lib-episode-file-path">
                        <code>{{ ep.file_path }}</code>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
    </div>
</div>

<!-- Container pour l'overlay de re-association -->
<div id="reassociate-container"></div>

<!-- Lightbox zoom jaquette -->
<div class="poster-lightbox" id="poster-lightbox" onclick="this.classList.remove('active')">
    <img id="poster-lightbox-img" src="" alt="">
</div>
<script>
function openPosterLightbox(src) {
    var lb = document.getElementById('poster-lightbox');
    document.getElementById('poster-lightbox-img').src = src.replace('/w300', '/w500');
    lb.classList.add('active');
}
/* Navigation prev/next */
(function() {
    var list = JSON.parse(sessionStorage.getItem('lib_nav_list') || '[]');
    var current = window.location.pathname;
    var idx = list.indexOf(current);
    if (idx < 0 || list.length < 2) return;
    var prev = idx > 0 ? list[idx - 1] : null;
    var next = idx < list.length - 1 ? list[idx + 1] : null;
    var nav = document.createElement('div');
    nav.className = 'lib-detail-nav';
    nav.innerHTML =
        (prev ? '<a href="' + prev + '" class="lib-detail-nav-btn lib-detail-nav-prev" title="Précédent (←)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></a>' : '<span></span>') +
        '<span class="lib-detail-nav-pos">' + (idx + 1) + ' / ' + list.length + '</span>' +
        (next ? '<a href="' + next + '" class="lib-detail-nav-btn lib-detail-nav-next" title="Suivant (→)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 6 15 12 9 18"/></svg></a>' : '<span></span>');
    var header = document.querySelector('.lib-detail-header');
    if (header) header.parentNode.insertBefore(nav, header);
    /* Prefetch pages adjacentes */
    [prev, next].forEach(function(url) {
        if (url) {
            var link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = url;
            document.head.appendChild(link);
        }
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { document.getElementById('poster-lightbox').classList.remove('active'); return; }
        if (document.querySelector('.reassociate-overlay')) return;
        if (e.key === 'ArrowLeft' && prev) window.location.href = prev;
        if (e.key === 'ArrowRight' && next) window.location.href = next;
    });
})();
</script>
{% endblock %}
