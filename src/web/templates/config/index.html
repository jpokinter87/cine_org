{% extends "base.html" %}

{% block title %}Configuration — CineOrg{% endblock %}
{% block nav_config %}active{% endblock %}

{% block content %}
<div class="config-page">
    <div class="hero">
        <h1 class="hero-title">Configuration</h1>
        <p class="hero-subtitle">Paramètres de l'application CineOrg</p>
    </div>

    {% if saved %}
    <div class="config-toast config-toast-success" id="config-toast">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Configuration enregistrée avec succès
        <button class="config-toast-close" onclick="this.parentElement.remove()">&times;</button>
    </div>
    {% endif %}

    <div class="config-restart-notice">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Les modifications seront prises en compte au prochain redémarrage du serveur
    </div>

    <form method="post" action="/config" class="config-form">
        {% for section in sections %}
        <fieldset class="config-section" id="section-{{ section.id }}">
            <legend class="config-section-legend">
                {% if section.icon == 'folder' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                {% elif section.icon == 'database' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                {% elif section.icon == 'key' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                {% elif section.icon == 'sliders' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
                {% elif section.icon == 'file-text' %}
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                {% endif %}
                {{ section.title }}
            </legend>

            {% for field in section.fields %}
            <div class="config-field {% if errors and errors[field.key] %}config-field-error{% endif %}">
                <div class="config-field-header">
                    <label class="config-label" for="field-{{ field.key }}">{{ field.label }}</label>
                    <span class="config-desc">{{ field.desc }}</span>
                </div>
                <div class="config-field-input">
                    {% if field.type == 'path' %}
                    <div class="config-path-wrap">
                        <input type="text"
                               id="field-{{ field.key }}"
                               name="{{ field.key }}"
                               class="config-input config-input-path"
                               value="{{ form_data[field.key] if form_data else field.value }}">
                        {% if field.status %}
                        <span class="config-path-status {% if field.status.exists and field.status.is_dir %}status-ok{% else %}status-missing{% endif %}"
                              title="{{ 'Répertoire existant' if field.status.exists and field.status.is_dir else 'Répertoire introuvable' }}">
                            {% if field.status.exists and field.status.is_dir %}
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                            {% else %}
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            {% endif %}
                        </span>
                        {% endif %}
                    </div>

                    {% elif field.type == 'readonly' %}
                    <input type="text"
                           id="field-{{ field.key }}"
                           class="config-input config-input-readonly"
                           value="{{ field.value }}"
                           readonly>

                    {% elif field.type == 'secret' %}
                    <div class="config-secret-wrap">
                        <input type="password"
                               id="field-{{ field.key }}"
                               name="{{ field.key }}"
                               class="config-input config-input-secret"
                               value="{{ form_data[field.key] if form_data else (field.value if field.is_set else '') }}"
                               placeholder="Non configurée"
                               autocomplete="off">
                        <button type="button" class="config-secret-toggle" onclick="toggleSecret(this)" title="Afficher/masquer">
                            <svg class="eye-open" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="eye-closed" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                        </button>
                        <span class="config-api-badge {% if field.is_set %}api-set{% else %}api-unset{% endif %}">
                            {{ 'Configurée' if field.is_set else 'Absente' }}
                        </span>
                    </div>

                    {% elif field.type == 'number' %}
                    <input type="number"
                           id="field-{{ field.key }}"
                           name="{{ field.key }}"
                           class="config-input config-input-number"
                           value="{{ form_data[field.key] if form_data else field.value }}"
                           {% if field.min is defined %}min="{{ field.min }}"{% endif %}
                           {% if field.max is defined %}max="{{ field.max }}"{% endif %}>

                    {% elif field.type == 'select' %}
                    <select id="field-{{ field.key }}"
                            name="{{ field.key }}"
                            class="config-input config-select">
                        {% for opt in field.options %}
                        <option value="{{ opt }}" {{ 'selected' if (form_data[field.key] if form_data else field.value) == opt }}>{{ opt }}</option>
                        {% endfor %}
                    </select>

                    {% else %}
                    <input type="text"
                           id="field-{{ field.key }}"
                           name="{{ field.key }}"
                           class="config-input"
                           value="{{ form_data[field.key] if form_data else field.value }}">
                    {% endif %}

                    {% if errors and errors[field.key] %}
                    <span class="config-error-msg">{{ errors[field.key] }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </fieldset>
        {% endfor %}

        <div class="config-actions">
            <button type="submit" class="config-save-btn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                Enregistrer
            </button>
        </div>
    </form>
</div>

<script>
function toggleSecret(btn) {
    var input = btn.previousElementSibling;
    var eyeOpen = btn.querySelector('.eye-open');
    var eyeClosed = btn.querySelector('.eye-closed');
    if (input.type === 'password') {
        input.type = 'text';
        eyeOpen.style.display = 'none';
        eyeClosed.style.display = 'block';
    } else {
        input.type = 'password';
        eyeOpen.style.display = 'block';
        eyeClosed.style.display = 'none';
    }
}

// Auto-dismiss toast after 4s
var toast = document.getElementById('config-toast');
if (toast) {
    setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-10px)';
        setTimeout(function() { toast.remove(); }, 300);
    }, 4000);
}
</script>
{% endblock %}
