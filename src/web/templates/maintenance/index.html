{% extends "base.html" %}

{% block title %}Maintenance — CineOrg{% endblock %}
{% block nav_maintenance %}active{% endblock %}

{% block content %}
<div class="maintenance-page">
    <div class="hero">
        <h1 class="hero-title">Maintenance</h1>
        <p class="hero-subtitle">Diagnostics de la vidéothèque (Films &amp; Séries)</p>
    </div>

    <div class="maint-cards">
        <!-- Intégrité -->
        <div class="maint-card">
            <div class="maint-card-header">
                <div class="maint-card-icon maint-icon-check">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                </div>
                <div>
                    <h2 class="maint-card-title">Intégrité</h2>
                    <p class="maint-card-desc">Vérifie la cohérence entre la base de données et le système de fichiers : entrées fantômes, fichiers orphelins, symlinks cassés.</p>
                </div>
            </div>
            <button class="maint-analyze-btn" id="btn-check" onclick="startAnalysis('check')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Lancer l'analyse
            </button>
            <div class="maint-progress" id="check-progress" style="display: none;">
                <div class="maint-progress-bar-track">
                    <div class="maint-progress-bar-fill" id="check-bar"></div>
                </div>
                <div class="maint-progress-phase" id="check-phase"></div>
            </div>
            <div id="check-results"></div>
        </div>

        <!-- Nettoyage -->
        <div class="maint-card">
            <div class="maint-card-header">
                <div class="maint-card-icon maint-icon-cleanup">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </div>
                <div>
                    <h2 class="maint-card-title">Nettoyage</h2>
                    <p class="maint-card-desc">Analyse le répertoire vidéo : symlinks cassés, mal placés, doublons, répertoires surdimensionnés et vides.</p>
                </div>
            </div>
            <button class="maint-analyze-btn" id="btn-cleanup" onclick="startAnalysis('cleanup')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Lancer l'analyse
            </button>
            <div class="maint-progress" id="cleanup-progress" style="display: none;">
                <div class="maint-progress-bar-track">
                    <div class="maint-progress-bar-fill" id="cleanup-bar"></div>
                </div>
                <div class="maint-progress-phase" id="cleanup-phase"></div>
            </div>
            <div id="cleanup-results"></div>
        </div>
    </div>
</div>

<script>
function startAnalysis(type) {
    var btn = document.getElementById('btn-' + type);
    var progress = document.getElementById(type + '-progress');
    var bar = document.getElementById(type + '-bar');
    var phase = document.getElementById(type + '-phase');
    var results = document.getElementById(type + '-results');

    // Masquer le bouton, afficher la progression, vider les anciens résultats
    btn.style.display = 'none';
    progress.style.display = 'block';
    results.innerHTML = '';
    bar.style.width = '0%';
    phase.textContent = 'Démarrage...';

    var es = new EventSource('/maintenance/' + type);

    es.addEventListener('progress', function(e) {
        var d = JSON.parse(e.data);
        // Calculer le pourcentage (phase en cours = phase - 1 complètes)
        var pct = ((d.phase - 1) / d.total) * 100;
        bar.style.width = Math.max(pct, 5) + '%';
        phase.innerHTML = '<span class="maint-phase-counter">Étape ' + d.phase + '/' + d.total + '</span> ' + d.label;
    });

    es.addEventListener('complete', function(e) {
        es.close();
        bar.style.width = '100%';
        bar.classList.add('complete');
        phase.textContent = 'Analyse terminée';

        // Injecter le HTML résultat après un court délai
        setTimeout(function() {
            var d = JSON.parse(e.data);
            results.innerHTML = d.html;
            progress.style.display = 'none';
            bar.classList.remove('complete');
            btn.style.display = '';
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Relancer l\'analyse';
        }, 400);
    });

    es.addEventListener('error', function(e) {
        es.close();
        bar.classList.add('error');
        phase.textContent = 'Erreur lors de l\'analyse';
        setTimeout(function() {
            progress.style.display = 'none';
            bar.classList.remove('error');
            btn.style.display = '';
        }, 2000);
    });
}
</script>
{% endblock %}
