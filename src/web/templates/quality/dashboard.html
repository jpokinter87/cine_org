{% extends "base.html" %}

{% block title %}Qualité — Tableau de bord — CineOrg{% endblock %}
{% block nav_quality %}active{% endblock %}

{% block content %}
<div class="quality-dashboard">
    <!-- Hero header -->
    <div class="qdash-hero">
        <div class="qdash-hero-text">
            <h1 class="qdash-title">Qualité</h1>
            <p class="qdash-subtitle">Couverture des métadonnées et suivi des corrections</p>
        </div>
        <!-- Score global rapide -->
        <div class="qdash-global-stats">
            <div class="qdash-gstat">
                <span class="qdash-gstat-value">{{ movie_coverage.total }}</span>
                <span class="qdash-gstat-label">Films</span>
            </div>
            <div class="qdash-gstat-sep"></div>
            <div class="qdash-gstat">
                <span class="qdash-gstat-value">{{ series_coverage.total }}</span>
                <span class="qdash-gstat-label">Séries</span>
            </div>
            <div class="qdash-gstat-sep"></div>
            <div class="qdash-gstat">
                <span class="qdash-gstat-value">{{ episode_coverage.total }}</span>
                <span class="qdash-gstat-label">Épisodes</span>
            </div>
        </div>
    </div>

    <!-- Grille principale : couverture à gauche, sidebar à droite -->
    <div class="qdash-body">
        <div class="qdash-main">
            <!-- Couverture Films -->
            <section class="qdash-section qdash-section-films">
                <div class="qdash-section-header">
                    <div class="qdash-section-icon qdash-icon-films">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                            <line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/>
                            <line x1="17" y1="7" x2="22" y2="7"/><line x1="17" y1="17" x2="22" y2="17"/>
                        </svg>
                    </div>
                    <h2 class="qdash-section-title">Films</h2>
                    <span class="qdash-section-count">{{ movie_coverage.total }} titres</span>
                </div>
                <div class="qdash-coverage-list">
                    {% for m in movie_coverage.metrics %}
                    <div class="qdash-cov-row" style="--anim-delay: {{ loop.index0 * 60 }}ms">
                        <div class="qdash-cov-header">
                            <span class="qdash-cov-name">{{ m.label }}</span>
                            <span class="qdash-cov-ratio">{{ m.count }}<span class="qdash-cov-ratio-sep">/</span>{{ m.total }}</span>
                        </div>
                        <div class="qdash-cov-track">
                            <div class="qdash-cov-fill qdash-cov-fill-films {% if m.pct >= 90 %}cov-excellent{% elif m.pct >= 70 %}cov-good{% elif m.pct >= 50 %}cov-medium{% else %}cov-poor{% endif %}"
                                 style="--fill-width: {{ m.pct }}%" data-pct="{{ m.pct }}"></div>
                        </div>
                        <span class="qdash-cov-pct {% if m.pct >= 90 %}cov-pct-excellent{% elif m.pct >= 70 %}cov-pct-good{% elif m.pct >= 50 %}cov-pct-medium{% else %}cov-pct-poor{% endif %}">{{ m.pct }}%</span>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Couverture Séries -->
            <section class="qdash-section qdash-section-series">
                <div class="qdash-section-header">
                    <div class="qdash-section-icon qdash-icon-series">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="7" width="20" height="15" rx="2" ry="2"/>
                            <polyline points="17 2 12 7 7 2"/>
                        </svg>
                    </div>
                    <h2 class="qdash-section-title">Séries</h2>
                    <span class="qdash-section-count">{{ series_coverage.total }} titres</span>
                </div>
                <div class="qdash-coverage-list">
                    {% for m in series_coverage.metrics %}
                    <div class="qdash-cov-row" style="--anim-delay: {{ loop.index0 * 60 }}ms">
                        <div class="qdash-cov-header">
                            <span class="qdash-cov-name">{{ m.label }}</span>
                            <span class="qdash-cov-ratio">{{ m.count }}<span class="qdash-cov-ratio-sep">/</span>{{ m.total }}</span>
                        </div>
                        <div class="qdash-cov-track">
                            <div class="qdash-cov-fill qdash-cov-fill-series {% if m.pct >= 90 %}cov-excellent{% elif m.pct >= 70 %}cov-good{% elif m.pct >= 50 %}cov-medium{% else %}cov-poor{% endif %}"
                                 style="--fill-width: {{ m.pct }}%" data-pct="{{ m.pct }}"></div>
                        </div>
                        <span class="qdash-cov-pct {% if m.pct >= 90 %}cov-pct-excellent{% elif m.pct >= 70 %}cov-pct-good{% elif m.pct >= 50 %}cov-pct-medium{% else %}cov-pct-poor{% endif %}">{{ m.pct }}%</span>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Couverture Épisodes -->
            <section class="qdash-section qdash-section-episodes">
                <div class="qdash-section-header">
                    <div class="qdash-section-icon qdash-icon-episodes">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/>
                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                    </div>
                    <h2 class="qdash-section-title">Épisodes</h2>
                    <span class="qdash-section-count">{{ episode_coverage.total }} épisodes</span>
                </div>
                <div class="qdash-coverage-list">
                    {% for m in episode_coverage.metrics %}
                    <div class="qdash-cov-row" style="--anim-delay: {{ loop.index0 * 60 }}ms">
                        <div class="qdash-cov-header">
                            <span class="qdash-cov-name">{{ m.label }}</span>
                            <span class="qdash-cov-ratio">{{ m.count }}<span class="qdash-cov-ratio-sep">/</span>{{ m.total }}</span>
                        </div>
                        <div class="qdash-cov-track">
                            <div class="qdash-cov-fill qdash-cov-fill-episodes {% if m.pct >= 90 %}cov-excellent{% elif m.pct >= 70 %}cov-good{% elif m.pct >= 50 %}cov-medium{% else %}cov-poor{% endif %}"
                                 style="--fill-width: {{ m.pct }}%" data-pct="{{ m.pct }}"></div>
                        </div>
                        <span class="qdash-cov-pct {% if m.pct >= 90 %}cov-pct-excellent{% elif m.pct >= 70 %}cov-pct-good{% elif m.pct >= 50 %}cov-pct-medium{% else %}cov-pct-poor{% endif %}">{{ m.pct }}%</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <!-- Sidebar -->
        <aside class="qdash-aside">
            <!-- Associations suspectes -->
            <div class="qdash-card qdash-card-suspects">
                <div class="qdash-card-header">
                    <div class="qdash-card-icon qdash-card-icon-warn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <h3 class="qdash-card-title">Associations suspectes</h3>
                </div>
                {% if suspect_summary %}
                <div class="qdash-suspect-grid">
                    <div class="qdash-suspect-cell qdash-suspect-total">
                        <span class="qdash-suspect-num">{{ suspect_summary.total }}</span>
                        <span class="qdash-suspect-lbl">suspectes</span>
                    </div>
                    <div class="qdash-suspect-cell">
                        <span class="qdash-suspect-num">{{ suspect_summary.movies }}</span>
                        <span class="qdash-suspect-lbl">films</span>
                    </div>
                    <div class="qdash-suspect-cell">
                        <span class="qdash-suspect-num">{{ suspect_summary.series }}</span>
                        <span class="qdash-suspect-lbl">séries</span>
                    </div>
                </div>
                <a href="/quality/suspicious" class="qdash-card-link">
                    Voir le détail
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                </a>
                {% else %}
                <p class="qdash-card-empty">Aucun scan récent</p>
                <a href="/quality/suspicious" class="qdash-card-link">
                    Lancer un scan
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                </a>
                {% endif %}
            </div>

            <!-- Historique des corrections -->
            <div class="qdash-card qdash-card-corrections">
                <div class="qdash-card-header">
                    <div class="qdash-card-icon qdash-card-icon-ok">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="qdash-card-title">Corrections</h3>
                    <span class="qdash-card-badge">{{ correction_history|length }}</span>
                </div>
                {% if correction_history %}
                <div class="qdash-correction-list">
                    {% for entry in correction_history[:15] %}
                    <div class="qdash-correction-row">
                        <span class="qdash-corr-type qdash-corr-type-{{ entry.entity_type }}">
                            {{ "Film" if entry.entity_type == "movie" else "Série" }}
                        </span>
                        <span class="qdash-corr-title">{{ entry.title or "ID " ~ entry.entity_id }}</span>
                        {% if entry.confirmed_at %}
                        <span class="qdash-corr-date">{{ entry.confirmed_at.strftime('%d/%m') }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% if correction_history|length > 15 %}
                    <p class="qdash-corr-more">+ {{ correction_history|length - 15 }} autres</p>
                    {% endif %}
                </div>
                {% else %}
                <p class="qdash-card-empty">Aucune correction enregistrée</p>
                {% endif %}
            </div>
        </aside>
    </div>
</div>

<script>
/* Animation des barres de couverture au chargement */
document.addEventListener('DOMContentLoaded', function() {
    var fills = document.querySelectorAll('.qdash-cov-fill');
    var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                var el = entry.target;
                var delay = parseInt(getComputedStyle(el.closest('.qdash-cov-row')).getPropertyValue('--anim-delay')) || 0;
                setTimeout(function() {
                    el.style.width = el.style.getPropertyValue('--fill-width');
                }, 80 + delay);
                observer.unobserve(el);
            }
        });
    }, { threshold: 0.1 });
    fills.forEach(function(el) { observer.observe(el); });
});
</script>
{% endblock %}
