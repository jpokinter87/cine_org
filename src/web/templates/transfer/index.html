{% extends "base.html" %}

{% block title %}Transfert — CineOrg{% endblock %}
{% block nav_transfer %}active{% endblock %}

{% block content %}
<div class="hero">
    <h1 class="hero-title">Transfert</h1>
    <p class="hero-subtitle">Déplacer les fichiers validés vers la vidéothèque</p>
</div>

{% if not has_transfers %}
{# ── État vide ── #}
<div class="empty-state">
    <div class="empty-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
             stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
    </div>
    <h2 class="empty-title">Aucun fichier à transférer</h2>
    <p class="empty-text">
        Les fichiers validés apparaîtront ici, prêts à être transférés vers la vidéothèque.
    </p>
    <div class="actions-row">
        {% if pending_count > 0 %}
        <a href="/validation" class="action-btn action-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                <polyline points="9 11 12 14 22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            Valider les {{ pending_count }} fichier(s) en attente
        </a>
        {% endif %}
        <a href="/workflow" class="action-btn action-secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            Lancer un traitement
        </a>
    </div>
</div>
{% else %}
{# ── Résumé batch ── #}
<div id="transfer-area">
    <div class="transfer-summary">
        <div class="transfer-counter">
            <span class="transfer-counter-value">{{ tree_data.total }}</span>
            <span class="transfer-counter-label">fichier(s) prêt(s) à transférer</span>
        </div>
        <div class="transfer-counter-detail">
            {% if tree_data.movie_count > 0 %}
            <span class="type-badge badge-film">{{ tree_data.movie_count }} film{{ 's' if tree_data.movie_count > 1 }}</span>
            {% endif %}
            {% if tree_data.series_count > 0 %}
            <span class="type-badge badge-series">{{ tree_data.series_count }} épisode{{ 's' if tree_data.series_count > 1 }}</span>
            {% endif %}
        </div>
    </div>

    {# Arborescence #}
    {% include "transfer/_batch_tree.html" %}

    {# Actions #}
    <div class="transfer-actions">
        <button class="action-btn action-secondary transfer-start-btn"
                hx-post="/transfer/start?dry_run=1"
                hx-target="#transfer-area"
                hx-swap="innerHTML">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            Simuler le transfert
        </button>
        <button class="action-btn action-primary transfer-start-btn"
                onclick="showTransferDialog()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Lancer le transfert
        </button>
    </div>
</div>
{% endif %}

<!-- Dialogue custom de renvoi en validation -->
<div class="reject-overlay" id="sendback-overlay" onclick="if(event.target===this)hideSendbackDialog()">
    <div class="reject-dialog">
        <h3 class="reject-dialog-title">Renvoyer en validation ?</h3>
        <p class="reject-dialog-text">
            Le fichier <strong id="sendback-filename"></strong> sera remis en attente de validation.
        </p>
        <p class="reject-dialog-note">
            S'il s'agit d'un épisode de série, tous les épisodes de la même série seront également renvoyés.
        </p>
        <div class="reject-dialog-actions">
            <button class="reject-dialog-cancel" onclick="hideSendbackDialog()">Annuler</button>
            <button class="reject-dialog-confirm" id="sendback-confirm-btn"
                    hx-swap="innerHTML"
                    hx-target="#transfer-area"
                    onclick="hideSendbackDialog()">
                Oui, renvoyer
            </button>
        </div>
    </div>
</div>

<!-- Dialogue custom de confirmation transfert -->
<div class="reject-overlay" id="transfer-overlay" onclick="if(event.target===this)hideTransferDialog()">
    <div class="reject-dialog">
        <h3 class="reject-dialog-title">Lancer le transfert ?</h3>
        <p class="reject-dialog-text">
            <strong>{{ tree_data.total if tree_data else 0 }} fichier(s)</strong> seront déplacés vers la vidéothèque
            et les symlinks créés dans le répertoire de lecture.
        </p>
        <p class="reject-dialog-note">
            Les conflits éventuels (doublons, collisions de noms) seront signalés au fur et à mesure.
        </p>
        <div class="reject-dialog-actions">
            <button class="reject-dialog-cancel" onclick="hideTransferDialog()">Annuler</button>
            <button class="action-btn action-primary"
                    hx-post="/transfer/start"
                    hx-target="#transfer-area"
                    hx-swap="innerHTML"
                    onclick="hideTransferDialog()"
                    style="font-size: 0.875rem;">
                Oui, transférer
            </button>
        </div>
    </div>
</div>

<script>
function showSendbackDialog(pendingId, filename) {
    document.getElementById('sendback-filename').textContent = filename;
    var btn = document.getElementById('sendback-confirm-btn');
    btn.setAttribute('hx-post', '/transfer/send-back/' + pendingId);
    htmx.process(btn);
    document.getElementById('sendback-overlay').classList.add('active');
}
function hideSendbackDialog() {
    document.getElementById('sendback-overlay').classList.remove('active');
}
function showTransferDialog() {
    document.getElementById('transfer-overlay').classList.add('active');
}
function hideTransferDialog() {
    document.getElementById('transfer-overlay').classList.remove('active');
}
</script>
{% endblock %}
