---
phase: 03-clients-api
plan: 03
type: tdd
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/adapters/api/tvdb_client.py
  - tests/unit/adapters/api/test_tvdb_client.py
  - tests/fixtures/tvdb_responses.py
autonomous: true
user_setup:
  - service: tvdb
    why: "API de metadonnees series TV"
    env_vars:
      - name: CINEORG_TVDB_API_KEY
        source: "TVDB -> Subscribe -> API Access -> Project API Key"

must_haves:
  truths:
    - "Le client TVDB recherche des series par titre"
    - "Le client TVDB recupere les metadonnees completes d'une serie"
    - "L'authentification JWT est geree automatiquement"
    - "Le token JWT est rafraichi avant expiration"
    - "Les resultats sont caches (recherches 24h, details 7j)"
    - "Les erreurs 429 sont gerees avec retry automatique"
  artifacts:
    - path: "src/adapters/api/tvdb_client.py"
      provides: "TVDB API client implementing IMediaAPIClient"
      exports: ["TVDBClient"]
      contains: "class TVDBClient(IMediaAPIClient)"
    - path: "tests/fixtures/tvdb_responses.py"
      provides: "Mock API responses for testing"
      exports: ["TVDB_LOGIN_RESPONSE", "TVDB_SEARCH_RESPONSE", "TVDB_SERIES_DETAILS_RESPONSE"]
  key_links:
    - from: "src/adapters/api/tvdb_client.py"
      to: "src/core/ports/api_clients.py"
      via: "implements interface"
      pattern: "class TVDBClient\\(IMediaAPIClient\\)"
    - from: "src/adapters/api/tvdb_client.py"
      to: "src/adapters/api/cache.py"
      via: "constructor injection"
      pattern: "def __init__.*cache.*APICache"
    - from: "src/adapters/api/tvdb_client.py"
      to: "src/adapters/api/retry.py"
      via: "import and use"
      pattern: "request_with_retry"
---

<objective>
Implementer le client TVDB pour la recherche et recuperation des metadonnees series TV, avec authentification JWT, caching et gestion du rate limiting.

Purpose: TVDB est la source de metadonnees pour les series TV. Le client doit gerer l'authentification JWT (token valide 1 mois) en plus du caching et retry standards.

Output: TVDBClient fonctionnel avec tests complets utilisant respx pour mocker les appels API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-clients-api/03-RESEARCH.md
@.planning/phases/03-clients-api/03-CONTEXT.md
@src/core/ports/api_clients.py
@src/adapters/api/cache.py
@src/adapters/api/retry.py
</context>

<feature>
  <name>TVDBClient - TVDB API v4 Client</name>
  <files>
    - src/adapters/api/tvdb_client.py
    - tests/unit/adapters/api/test_tvdb_client.py
    - tests/fixtures/tvdb_responses.py
  </files>
  <behavior>
    TVDBClient implements IMediaAPIClient for TV series metadata retrieval.

    Authentication:
      - JWT token obtained via POST /login with API key
      - Token stored with expiry timestamp (29 days, refresh 1 day early)
      - Token refreshed automatically if expired or missing
      - Token included in Authorization: Bearer header

    search(query, year=None) -> list[SearchResult]:
      - "Breaking Bad" -> [SearchResult(id="81189", title="Breaking Bad", year=2008, source="tvdb"), ...]
      - Cache key: "tvdb:search:{query}:{year}"
      - Returns empty list if no results
      - TVDB uses query param "q" for search

    get_details(series_id) -> MediaDetails | None:
      - "81189" -> MediaDetails(id="81189", title="Breaking Bad", year=2008, genres=("Crime", "Drame", "Thriller"), ...)
      - Cache key: "tvdb:details:{series_id}"
      - Returns None if series not found (404)
      - duration_seconds is None for series (no single runtime)

    source property:
      - Returns "tvdb"

    Caching behavior:
      - Search results cached for 24 hours
      - Details cached for 7 days
      - Cache checked before API call
      - JWT token NOT cached (stored in memory)

    Rate limiting:
      - 429 responses trigger retry with exponential backoff
      - Max 5 retries before failure
  </behavior>
  <implementation>
    TDD approach - write tests first, then implement.

    RED phase:
    1. Create tests/fixtures/tvdb_responses.py with mock API responses:
       - TVDB_LOGIN_RESPONSE (JWT token)
       - TVDB_SEARCH_RESPONSE (series search results)
       - TVDB_SERIES_DETAILS_RESPONSE (series details)
    2. Write test_login_obtains_jwt_token
    3. Write test_search_includes_auth_header
    4. Write test_search_returns_search_results
    5. Write test_search_caches_results
    6. Write test_search_checks_cache_before_api_call (verify cache.get called BEFORE any HTTP request)
    7. Write test_get_details_returns_media_details
    8. Write test_get_details_returns_none_on_404
    9. Write test_get_details_caches_results
    10. Write test_details_checks_cache_before_api_call (verify cache.get called BEFORE any HTTP request)
    11. Write test_token_refresh_on_expiry
    12. Write test_source_property_returns_tvdb
    13. Write test_retries_on_429
    Run tests - all should FAIL

    GREEN phase:
    1. Implement TVDBClient class:
       - Constructor takes api_key and APICache
       - Store _token: Optional[str] and _token_expiry: Optional[datetime]
       - Implement _ensure_token() to get/refresh JWT
       - Lazy-initialize httpx.AsyncClient with base_url
       - Implement search() with auth header
       - Implement get_details() with auth header
       - Implement source property
       - Implement close() for cleanup
    Run tests - all should PASS

    REFACTOR phase:
    - Extract auth header logic to _get_auth_headers()
    - Ensure proper token refresh timing (29 days validity, refresh at 28)
  </implementation>
</feature>

<verification>
1. Tests: `pytest tests/unit/adapters/api/test_tvdb_client.py -v` - tous passent
2. Import: `from src.adapters.api.tvdb_client import TVDBClient`
3. Interface: `isinstance(TVDBClient(...), IMediaAPIClient)` returns True
4. Coverage: `pytest tests/unit/adapters/api/test_tvdb_client.py --cov=src/adapters/api/tvdb_client --cov-report=term-missing` >= 90%
</verification>

<success_criteria>
- TVDBClient implemente IMediaAPIClient (search, get_details, source)
- L'authentification JWT fonctionne (login -> token -> header)
- Le token est rafraichi automatiquement avant expiration
- La recherche retourne des SearchResult avec id, title, year, source="tvdb"
- get_details retourne MediaDetails avec genres, sans duration_seconds
- Le cache est consulte AVANT tout appel API (tests explicites le verifient)
- Les 429 sont retries automatiquement
- Tous les tests passent avec respx mockant les appels HTTP
</success_criteria>

<output>
After completion, create `.planning/phases/03-clients-api/03-03-SUMMARY.md`
</output>
