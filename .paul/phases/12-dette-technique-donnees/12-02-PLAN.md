---
phase: 12-dette-technique-donnees
plan: 02
type: execute
wave: 1
depends_on: ["12-01"]
files_modified:
  - src/adapters/cli/commands/import_commands.py
  - src/adapters/cli/commands/__init__.py
  - src/main.py
autonomous: true
---

<objective>
## Goal
Combler les 3 lacunes de données restantes : films sans file_path (1306), films sans métadonnées techniques (444), titres épisodes manquants (2706 enrichissables via TVDB).

## Purpose
Ces données manquantes dégradent l'expérience utilisateur : impossible de lancer un fichier depuis la fiche, filtres techniques vides pour certains films, épisodes sans titre lisible dans la bibliothèque.

## Output
- 3 nouvelles commandes CLI d'enrichissement batch
- Données comblées après exécution
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/12-dette-technique-donnees/12-01-SUMMARY.md (nettoyage titres + helpers)

## Source Files
@src/adapters/cli/commands/import_commands.py (link_movies existant comme modèle)
@src/adapters/api/tvdb_client.py (get_episode_details pour enrichissement épisodes)
@src/adapters/parsing/mediainfo_extractor.py (extraction métadonnées techniques)
</context>

<acceptance_criteria>

## AC-1: Films associés à leurs fichiers physiques
```gherkin
Given 1306 films en base n'ont pas de file_path
When la commande link-movies est exécutée (recherche étendue via storage/)
Then le nombre de films sans file_path diminue significativement
And les films associés ont un file_path pointant vers un fichier existant
```

## AC-2: Métadonnées techniques extraites
```gherkin
Given 444 films ont un file_path mais pas de résolution/codecs
When la commande enrich-tech est exécutée
Then les champs resolution, codec_video, codec_audio, languages, file_size_bytes sont remplis
And les valeurs proviennent de pymediainfo sur le fichier physique
```

## AC-3: Titres épisodes enrichis
```gherkin
Given 2706 épisodes sans titre ont une série avec tvdb_id
When la commande enrich-episode-titles est exécutée
Then les titres sont récupérés depuis l'API TVDB (FR avec fallback EN)
And le nombre d'épisodes sans titre diminue significativement
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Améliorer link-movies avec recherche dans storage/</name>
  <files>src/adapters/cli/commands/import_commands.py</files>
  <action>
    Améliorer la commande `link_movies` existante pour couvrir les films sans symlink :

    1. **Après la boucle symlinks existante**, ajouter une 2e passe :
       - Lister les films en base SANS file_path : `MovieModel.file_path.is_(None)`
       - Construire un index des fichiers vidéo dans `storage/Films/` (rglob + VIDEO_EXTENSIONS)
       - Pour chaque fichier storage, parser le titre/année avec `_FILM_NAME_RE`
       - Matcher contre les films sans file_path (titre exact + année)
       - Mettre à jour le file_path si trouvé

    2. **Affichage** : ajouter une section au résumé existant pour la passe storage
       - "X film(s) associé(s) via storage"

    3. **Gestion des erreurs** : skip si storage_dir n'existe pas (warn, ne pas crash)

    Note : garder la 1ère passe (symlinks) intacte — la 2ème passe s'ajoute en complément.
    Note : utiliser `config.storage_dir` pour le chemin storage.
  </action>
  <verify>
    uv run python -m src.main link-movies --dry-run 2>&1 | tail -20
    # Doit montrer des films trouvés via storage en plus des symlinks
  </verify>
  <done>AC-1 satisfait : films sans file_path associés via recherche storage</done>
</task>

<task type="auto">
  <name>Task 2: Commande enrich-tech pour métadonnées techniques</name>
  <files>src/adapters/cli/commands/import_commands.py, src/adapters/cli/commands/__init__.py, src/main.py</files>
  <action>
    Créer une commande CLI `enrich_tech` :

    1. **Sélection** : films avec `file_path IS NOT NULL` ET `resolution IS NULL`
    2. **Pour chaque film** :
       - Vérifier que le fichier existe (`Path(file_path).exists()` ou `resolve()` si symlink)
       - Appeler `MediaInfoExtractor().extract(file_path)` pour obtenir les métadonnées
       - Mettre à jour : `resolution` (WxH), `codec_video`, `codec_audio`, `languages_json`, `file_size_bytes`
       - Commit par batch de 50 pour limiter la mémoire
    3. **Affichage** : Progress bar Rich + résumé (enrichis, skippés, erreurs)
    4. **Option --dry-run** : afficher sans modifier
    5. **Option --limit N** : limiter le nombre de films traités (défaut: tous)

    Enregistrer la commande dans `__init__.py` et `main.py` comme `enrich-tech`.

    Réutiliser `MediaInfoExtractor` depuis `src/adapters/parsing/mediainfo_extractor.py`.
    Pour la résolution, stocker au format "WIDTHxHEIGHT" (ex: "1920x1080") comme le fait le pipeline existant.
  </action>
  <verify>
    uv run python -m src.main enrich-tech --dry-run --limit 5 2>&1
    # Doit lister les films à enrichir avec les métadonnées trouvées
  </verify>
  <done>AC-2 satisfait : métadonnées techniques extraites pour les films avec fichier</done>
</task>

<task type="auto">
  <name>Task 3: Commande enrich-episode-titles via TVDB</name>
  <files>src/adapters/cli/commands/import_commands.py, src/adapters/cli/commands/__init__.py, src/main.py</files>
  <action>
    Créer une commande CLI `enrich_episode_titles` :

    1. **Sélection** : épisodes avec `(title IS NULL OR title == '')` + jointure série `tvdb_id IS NOT NULL`
       - Requête SQL : `select(EpisodeModel).join(SeriesModel).where(...)`
    2. **Grouper par série** pour optimiser les appels API (éviter de réauthentifier à chaque épisode)
    3. **Pour chaque épisode** :
       - Appeler `tvdb_client.get_episode_details(series.tvdb_id, season, episode)`
       - Si titre obtenu, mettre à jour `episode.title`
       - Si overview obtenu, mettre à jour `episode.overview` aussi
       - Respecter le rate limiting TVDB (le client gère déjà le retry)
    4. **Commit par série** (tous les épisodes d'une série en un commit)
    5. **Affichage** : Progress bar Rich par série + résumé (enrichis, non trouvés, erreurs)
    6. **Option --dry-run** : afficher sans modifier
    7. **Option --limit N** : limiter le nombre de séries traitées (défaut: toutes)

    Pattern async : `def enrich_episode_titles()` → `asyncio.run(_enrich_episode_titles_async())`
    Utiliser le container DI pour obtenir le tvdb_client : `container.tvdb_client()`
    Décorateur `@with_container()` comme les autres commandes async.

    Enregistrer comme `enrich-episode-titles` dans `__init__.py` et `main.py`.
  </action>
  <verify>
    uv run python -m src.main enrich-episode-titles --dry-run --limit 2 2>&1
    # Doit lister les épisodes enrichis pour 2 séries
  </verify>
  <done>AC-3 satisfait : titres épisodes enrichis via TVDB</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/adapters/api/tvdb_client.py (client TVDB stable, réutiliser tel quel)
- src/adapters/parsing/mediainfo_extractor.py (extracteur stable)
- src/services/ (pas de modification des services)
- src/web/ (pas de changement web)
- src/utils/helpers.py (stable depuis Plan 01)

## SCOPE LIMITS
- Pas de modification des entités domaine (Movie, Episode)
- Pas de nouvelle route web
- Pas de refactoring de import_commands.py (réservé Phase 13)
- Les commandes sont des outils one-shot CLI, pas des services

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest tests/ -x` passe (aucun test cassé sauf le pré-existant)
- [ ] `uv run ruff check src/adapters/cli/commands/import_commands.py src/main.py` propre
- [ ] `link-movies --dry-run` montre la passe storage
- [ ] `enrich-tech --dry-run --limit 5` liste les films à enrichir
- [ ] `enrich-episode-titles --dry-run --limit 2` liste les épisodes à enrichir
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Données comblées (films associés, métadonnées extraites, titres épisodes enrichis)
</success_criteria>

<output>
After completion, create `.paul/phases/12-dette-technique-donnees/12-02-SUMMARY.md`
</output>
