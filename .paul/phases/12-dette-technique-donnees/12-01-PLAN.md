---
phase: 12-dette-technique-donnees
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/library.py
  - src/utils/helpers.py
  - src/services/organizer.py
autonomous: false
---

<objective>
## Goal
Corriger le tri alphabétique de la bibliothèque web pour gérer correctement les accents, caractères spéciaux, articles, et caractères invisibles. Nettoyer les titres existants en base de données.

## Purpose
Le tri actuel place les titres accentués en fin de liste (É après Z) et ne retire pas les articles (Les, The, etc.). Les caractères invisibles dans certains titres faussent aussi le classement. Ce fix améliore directement la navigation bibliothèque pour l'utilisateur.

## Output
- Tri bibliothèque normalisé (accents, articles, caractères invisibles)
- Fonction `strip_invisible_chars` déplacée dans `helpers.py` (réutilisable)
- Titres en BDD nettoyés des caractères invisibles
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Source Files
@src/web/routes/library.py (ligne 324 : tri par title.lower())
@src/utils/helpers.py (normalize_accents, strip_article existants)
@src/services/organizer.py (_strip_invisible_chars à déplacer)
@src/utils/constants.py (IGNORED_ARTICLES)
</context>

<acceptance_criteria>

## AC-1: Tri alphabétique normalisé
```gherkin
Given la bibliothèque contient des titres avec accents ("Élève", "Ôtez-moi d'un doute")
When l'utilisateur trie par titre
Then "Élève" apparaît parmi les E, "Ôtez-moi d'un doute" parmi les O
And les articles sont ignorés ("Les Évadés" trié sous E, "The Matrix" sous M)
```

## AC-2: Caractères invisibles nettoyés
```gherkin
Given des titres en BDD contiennent des caractères Unicode invisibles (ex: "Zoé, mon amie morte")
When le script de nettoyage est exécuté
Then les caractères invisibles sont supprimés de tous les titres (MovieModel, SeriesModel, EpisodeModel)
And le tri n'est plus affecté par ces caractères
```

## AC-3: Nettoyage préventif à l'entrée
```gherkin
Given un nouveau titre est reçu de l'API TMDB avec un caractère invisible
When il est sauvegardé en base
Then le caractère invisible est supprimé avant la sauvegarde
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Normaliser le tri bibliothèque et déplacer strip_invisible_chars</name>
  <files>src/web/routes/library.py, src/utils/helpers.py, src/services/organizer.py</files>
  <action>
    1. **Déplacer `_strip_invisible_chars`** de `src/services/organizer.py` vers `src/utils/helpers.py` :
       - Renommer en `strip_invisible_chars` (sans underscore — API publique)
       - Mettre à jour l'import dans `organizer.py` pour utiliser `from src.utils.helpers import strip_invisible_chars`
       - Garder la même logique (filtrer catégories Cf et Cc)

    2. **Créer une fonction `sort_key`** dans `src/utils/helpers.py` :
       - `def title_sort_key(title: str) -> str:`
       - Applique dans l'ordre : `strip_invisible_chars` → `strip_article` → `normalize_accents` → `.lower()`
       - Cette fonction centralise la logique de tri

    3. **Mettre à jour les clés de tri** dans `src/web/routes/library.py` :
       - Import : `from src.utils.helpers import title_sort_key`
       - Ligne 324 (tri titre) : `items.sort(key=lambda x: title_sort_key(x["title"]), reverse=descending)`
       - Lignes 292-293 (tri année) : remplacer `x["title"].lower()` par `title_sort_key(x["title"])` dans le tuple
       - Lignes 296-297 (tri rating) : idem
       - Lignes 308-313 (tri codec_video) : idem
       - Lignes 316-321 (tri codec_audio) : idem
       - Garder `_resolution_pixels` inchangé pour le tri résolution
  </action>
  <verify>
    uv run python -c "
from src.utils.helpers import title_sort_key
tests = [('Élève libre', 'e'), ('Ôtez-moi', 'o'), ('Les Évadés', 'e'), ('The Matrix', 'm'), ('...Et pour quelques dollars', 'e')]
for t, expected in tests:
    result = title_sort_key(t)
    assert result[0] == expected, f'{t} -> {result} (expected starts with {expected})'
print('All sort key tests passed')
"
  </verify>
  <done>AC-1 satisfait : tri normalisé avec accents, articles et caractères invisibles</done>
</task>

<task type="auto">
  <name>Task 2: Nettoyage batch titres BDD + prévention à l'entrée</name>
  <files>src/utils/helpers.py, src/infrastructure/persistence/repositories/movie_repository.py, src/infrastructure/persistence/repositories/episode_repository.py</files>
  <action>
    1. **Script de nettoyage batch** (one-shot, exécuté une fois) :
       - Créer une commande CLI `clean-titles` dans `src/adapters/cli/commands/import_commands.py`
       - Itérer tous les `MovieModel`, `SeriesModel`, `EpisodeModel`
       - Pour chaque titre, appliquer `strip_invisible_chars(title)`
       - Si le titre nettoyé diffère de l'original, sauvegarder en base
       - Afficher le nombre de titres nettoyés avec un résumé Rich (ex: "3 titres nettoyés sur 4800")

    2. **Nettoyage préventif** :
       - Dans `src/utils/helpers.py`, créer `clean_title(title: str) -> str` qui applique `strip_invisible_chars` et strip()
       - Dans `movie_repository.py` méthode `save()` : avant le `session.add()`, appliquer `clean_title()` sur `movie.title` et `movie.original_title`
       - Dans les repositories séries et épisodes : idem pour les champs title
       - Note : ne PAS toucher aux autres champs (overview, etc.) — seulement les titres utilisés pour le tri

    3. **Exécuter la commande** `clean-titles` et vérifier les résultats
  </action>
  <verify>
    uv run python -c "
from src.utils.helpers import strip_invisible_chars
# Test avec un caractère invisible connu (LRM U+200E)
test = '\u200eZoé, mon amie morte'
result = strip_invisible_chars(test)
assert result == 'Zoé, mon amie morte', f'Got: {repr(result)}'
assert len(result) < len(test)
print('Clean title test passed')
"
    uv run ruff check src/utils/helpers.py src/web/routes/library.py
  </verify>
  <done>AC-2 et AC-3 satisfaits : titres BDD nettoyés + nettoyage préventif à l'entrée</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Tri bibliothèque normalisé avec gestion des accents, articles et caractères invisibles.
    Nettoyage batch des titres existants en base.
  </what-built>
  <how-to-verify>
    1. Démarrer : `uv run uvicorn src.web.app:app --reload`
    2. Accéder à http://192.168.1.15:8000/library
    3. Trier par titre (ascendant)
    4. Vérifier que "...Et pour quelques dollars de plus" est parmi les E (pas en fin de liste)
    5. Vérifier que "'Ohana" est parmi les O
    6. Vérifier que "Ôtez-moi d'un doute" est parmi les O
    7. Vérifier que "Les Évadés" est parmi les E
    8. Vérifier que "Zoé, mon amie morte" est parmi les Z (pas décalé)
    9. Vérifier que le tri par année/rating conserve un sous-tri titre normalisé
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- `src/services/association_checker.py` (stable)
- `src/web/templates/` (pas de changement template dans ce plan)
- `src/web/static/css/` (pas de changement CSS)
- Les routes existantes de library.py (ne changer que les clés de tri)
- Le mécanisme de cache qualité

## SCOPE LIMITS
- Pas de modification du tri côté SQL (le tri est fait en Python après fetch)
- Pas de refactoring de library.py (réservé Phase 13)
- Pas d'enrichissement batch file_path / métadonnées / épisodes (réservé Plan 02)
- Pas de modification de l'organisateur au-delà du refactoring import

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest tests/ -x` passe (aucun test cassé sauf le pré-existant test_auto_repair_multi_season)
- [ ] `uv run ruff check src/utils/helpers.py src/web/routes/library.py src/services/organizer.py` propre
- [ ] `title_sort_key` fonctionne pour accents, articles, caractères invisibles
- [ ] Commande `clean-titles` exécutée avec succès
- [ ] Tri bibliothèque visuellement correct
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Tri bibliothèque normalisé et fonctionnel
</success_criteria>

<output>
After completion, create `.paul/phases/12-dette-technique-donnees/12-01-SUMMARY.md`
</output>
