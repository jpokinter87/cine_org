---
phase: 07-enrichissement-series
plan: 01
type: execute
wave: 1
depends_on: ["06-01"]
files_modified:
  - src/adapters/api/tmdb_client.py
  - src/infrastructure/persistence/models.py
  - src/infrastructure/persistence/database.py
  - src/services/series_enricher.py
autonomous: false
---

<objective>
## Goal
Enrichir les séries avec les crédits manquants (director 86% → ~100%, cast 95% → ~100%) et ajouter les IMDB IDs (0% → ~95%+) via TMDB.

## Purpose
Les fiches séries dans l'interface web sont incomplètes : 130 séries sans réalisateur/créateur, 41 sans casting, et aucune ne possède de lien IMDB. L'enrichissement prépare la Phase 8 (fiches détaillées enrichies).

## Output
- Colonne `tmdb_id` ajoutée à SeriesModel (évite les recherches TMDB répétées)
- Méthode `get_tv_external_ids()` dans TMDBClient
- Service `series_enricher` enrichit aussi tmdb_id et imdb_id
- Couverture crédits et IMDB IDs vérifiée
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/06-enrichissement-films/06-01-SUMMARY.md (pattern enrichissement + progress bar)

## Source Files
@src/adapters/api/tmdb_client.py (get_external_ids existe pour movies, pas pour TV)
@src/services/series_enricher.py (enrichit poster/notes/genres/director/cast, mais pas tmdb_id/imdb_id)
@src/infrastructure/persistence/models.py (SeriesModel a tvdb_id et imdb_id mais pas tmdb_id)
@src/infrastructure/persistence/database.py (_run_migrations pour ajout colonnes)
@src/adapters/cli/commands/enrichment_commands.py (commande enrich-series avec progress bar)
</context>

<acceptance_criteria>

## AC-1: tmdb_id persisté
```gherkin
Given une série enrichie avec succès depuis TMDB
When l'enrichissement se termine
Then la série a son tmdb_id sauvegardé en base (non null)
```

## AC-2: imdb_id récupéré
```gherkin
Given une série avec un tmdb_id valide
When l'enrichisseur appelle get_tv_external_ids()
Then l'imdb_id est récupéré et sauvegardé (si disponible sur TMDB)
```

## AC-3: Couverture crédits améliorée
```gherkin
Given les 940 séries en base
When enrich-series est exécuté
Then director >= 95% et cast >= 98%
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Ajouter tmdb_id + get_tv_external_ids + enrichir imdb_id</name>
  <files>
    src/infrastructure/persistence/models.py,
    src/infrastructure/persistence/database.py,
    src/adapters/api/tmdb_client.py,
    src/services/series_enricher.py
  </files>
  <action>
    1. **SeriesModel** : ajouter champ `tmdb_id: int | None = Field(default=None, index=True)` (entre tvdb_id et imdb_id)

    2. **database.py** `_run_migrations()` : ajouter migration pour colonne `tmdb_id INTEGER` sur table `series` si manquante

    3. **TMDBClient** : ajouter méthode `get_tv_external_ids(tv_id: str) -> Optional[dict]`
       - Appelle `/tv/{tv_id}/external_ids`
       - Retourne dict avec imdb_id, etc. (même pattern que `get_external_ids` pour movies mais endpoint `/tv/`)

    4. **series_enricher.py** `_enrich_one()` :
       - Après `get_tv_details()`, sauvegarder le `tmdb_id` sur la série (`series.tmdb_id = int(best.id)` — utiliser l'ID du SearchResult `best`)
       - Appeler `get_tv_external_ids(best.id)` pour récupérer l'imdb_id
       - Si imdb_id trouvé, le sauvegarder sur la série
       - Note : l'entité Series n'a pas tmdb_id — passer par `_series_repo` directement ou ajouter le champ à l'entité

    5. **Entité Series** (src/core/entities/media.py) : ajouter champ `tmdb_id: Optional[int] = None`

    6. **Repository** : vérifier que `_to_entity` et `_to_model` gèrent tmdb_id correctement (le SeriesRepository fait probablement un mapping automatique via les champs communs)

    Éviter :
    - Ne PAS toucher à l'enrichissement des épisodes (hors scope)
    - Ne PAS modifier la commande CLI (la progress bar existe déjà)
    - Ne PAS modifier le flow de matching (_pick_best_match reste identique)
  </action>
  <verify>
    uv run python -c "from src.infrastructure.persistence.models import SeriesModel; assert hasattr(SeriesModel, 'tmdb_id')"
    uv run python -c "from src.adapters.api.tmdb_client import TMDBClient; assert hasattr(TMDBClient, 'get_tv_external_ids')"
    uv run ruff check src/infrastructure/persistence/models.py src/adapters/api/tmdb_client.py src/services/series_enricher.py
  </verify>
  <done>AC-1 et AC-2 prêts : code modifié pour persister tmdb_id et récupérer imdb_id</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-to-do>
    Exécuter l'enrichissement des séries :
    1. `uv run python -m src.main enrich-series` (sans --force, cible les 130 séries sans director)
    2. Puis `uv run python -m src.main enrich-series --force --limit 940` pour enrichir tmdb_id et imdb_id de TOUTES les séries (celles déjà enrichies n'ont pas encore de tmdb_id)

    Temps estimé : ~5 min (130 séries × 0.3s) + ~5 min (940 × 0.3s)
  </what-to-do>
  <resume-signal>Tapez "done" quand l'enrichissement est terminé</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Vérifier la couverture enrichissement</name>
  <files>aucun (vérification uniquement)</files>
  <action>
    Exécuter des requêtes SQL pour vérifier la couverture :
    - tmdb_id : % de séries avec tmdb_id non null
    - imdb_id : % de séries avec imdb_id non null
    - director : % de séries avec director non null
    - cast : % de séries avec cast_json non null et non vide
    - poster_path, vote_average : vérifier stabilité

    Comparer avec les valeurs avant enrichissement :
    - director : 86.2% → objectif >= 95%
    - cast : 95.6% → objectif >= 98%
    - imdb_id : 0% → objectif >= 90%
  </action>
  <verify>Requêtes SQL directes sur la base</verify>
  <done>AC-3 satisfait : couverture crédits et IMDB IDs vérifiée et rapportée</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/adapters/cli/commands/enrichment_commands.py (commande enrich-series déjà fonctionnelle avec progress bar)
- src/services/ratings_enricher.py (enrichissement films — phase 6 close)
- src/services/movies_enricher.py (enrichissement crédits films — stable)
- Logique de matching `_pick_best_match` (algorithme de priorité validé)

## SCOPE LIMITS
- Pas d'enrichissement des titres d'épisodes (plan 07-02 si nécessaire)
- Pas de modification de l'interface web (Phase 8)
- Pas de nouveau endpoint TMDB pour les épisodes

</boundaries>

<verification>
Avant de déclarer le plan complet :
- [ ] `uv run ruff check` passe sans erreur sur les fichiers modifiés
- [ ] tmdb_id présent comme colonne dans SeriesModel
- [ ] Migration automatique fonctionne (tmdb_id ajouté à la table existante)
- [ ] get_tv_external_ids() existe et fonctionne dans TMDBClient
- [ ] Couverture director >= 95%, imdb_id >= 90%
- [ ] Tous les critères d'acceptation vérifiés
</verification>

<success_criteria>
- Tous les tasks complétés
- Couverture enrichissement séries significativement améliorée
- tmdb_id et imdb_id persistés pour les séries enrichies
- Aucune régression sur les données existantes
</success_criteria>

<output>
Après complétion, créer `.paul/phases/07-enrichissement-series/07-01-SUMMARY.md`
</output>
