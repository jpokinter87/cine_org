---
phase: 08-fiches-detaillees-enrichies
plan: 01
type: execute
wave: 1
depends_on: ["06-01", "07-01"]
files_modified:
  - src/web/routes/library.py
  - src/web/templates/library/movie_detail.html
  - src/web/templates/library/series_detail.html
  - src/web/templates/library/_grid.html
  - src/web/templates/library/_filters.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Enrichir les fiches détaillées web avec liens externes cliquables (IMDb/TMDB), crédits cliquables filtrants (réalisateur/acteurs), et label source rating dans la grille.

## Purpose
Les données sont enrichies (phases 6-7) mais l'interface web ne les exploite pas pleinement. Les utilisateurs doivent pouvoir naviguer vers IMDb/TMDB, filtrer par personne, et voir la source du rating dans la grille.

## Output
- Liens IMDb/TMDB/TVDB cliquables sur les fiches détaillées
- Réalisateur et acteurs cliquables → filtre bibliothèque par personne
- Label source (IMDb/TMDB) sur les badges rating de la grille
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/07-enrichissement-series/07-01-SUMMARY.md (tmdb_id + imdb_id disponibles)

## Source Files
@src/web/routes/library.py (routes library_index, movie_detail, series_detail)
@src/web/templates/library/movie_detail.html (détail film — badges rating déjà OK)
@src/web/templates/library/series_detail.html (détail série — badges rating déjà OK)
@src/web/templates/library/_grid.html (grille avec badge rating sans label source)
@src/web/templates/library/_filters.html (filtres HTMX — pas de filtre personne)
@src/web/static/css/style.css (design system sombre, Instrument Serif + DM Sans)
</context>

<acceptance_criteria>

## AC-1: Liens externes cliquables
```gherkin
Given une fiche détaillée film/série avec imdb_id et tmdb_id
When l'utilisateur consulte la page
Then des boutons/liens vers IMDb et TMDB sont visibles et s'ouvrent dans un nouvel onglet
```

## AC-2: Crédits cliquables avec filtre
```gherkin
Given une fiche détaillée affichant réalisateur et acteurs
When l'utilisateur clique sur un nom (réalisateur ou acteur)
Then la bibliothèque s'ouvre filtrée par cette personne (films + séries)
```

## AC-3: Label source rating dans la grille
```gherkin
Given la grille bibliothèque affichant des cartes avec badge rating
When l'utilisateur parcourt la grille
Then chaque badge indique la source du rating (IMDb ou TMDB)
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Liens externes + label source rating grille</name>
  <files>
    src/web/templates/library/movie_detail.html,
    src/web/templates/library/series_detail.html,
    src/web/templates/library/_grid.html,
    src/web/static/css/style.css
  </files>
  <action>
    **1. Liens externes sur les fiches détaillées :**

    Sur `movie_detail.html` — dans la zone des badges (à côté des badges rating existants), ajouter des boutons-liens :
    - Si `movie.imdb_id` : lien `https://www.imdb.com/title/{{ movie.imdb_id }}/` avec icône/label "IMDb"
    - Si `movie.tmdb_id` : lien `https://www.themoviedb.org/movie/{{ movie.tmdb_id }}` avec label "TMDB"
    - Attributs : `target="_blank" rel="noopener"`

    Sur `series_detail.html` — même pattern :
    - Si `series.imdb_id` : lien IMDb
    - Si `series.tmdb_id` : lien `https://www.themoviedb.org/tv/{{ series.tmdb_id }}`
    - Attributs : `target="_blank" rel="noopener"`

    Note : les données tmdb_id sont disponibles côté template seulement si le route passe le model. Vérifier dans `library.py` que `tmdb_id` est accessible dans le contexte template. Si l'entité ne le porte pas, passer le model directement ou ajouter un champ au contexte.

    **2. Label source rating dans la grille :**

    Sur `_grid.html` — le badge rating affiche déjà la valeur numérique. Ajouter un petit label textuel :
    - Si la source est IMDb : afficher "IMDb" en petit dans le badge
    - Si la source est TMDB : afficher "TMDB" en petit
    - La source est déjà calculée par `_best_rating()` dans `library.py` — vérifier qu'elle est passée au template, sinon l'ajouter.

    **3. CSS :**
    - Ajouter styles pour les boutons liens externes (`.lib-external-link`) : petit bouton discret, hover accent
    - Ajuster le badge rating grille pour inclure le label source (texte plus petit sous la note)

    Éviter :
    - Ne PAS modifier le HTML de la section dépliable "Informations fichier" (elle peut garder les IDs en texte)
    - Ne PAS changer la logique de `_best_rating()`
  </action>
  <verify>
    Lancer le serveur dev et vérifier visuellement :
    - uv run uvicorn src.web.app:app --reload
    - Page détail film : liens IMDb + TMDB visibles
    - Page détail série : liens IMDb + TMDB visibles
    - Grille : badge rating avec label source
  </verify>
  <done>AC-1 et AC-3 satisfaits : liens externes cliquables et label source dans la grille</done>
</task>

<task type="auto">
  <name>Task 2: Crédits cliquables avec filtre par personne</name>
  <files>
    src/web/routes/library.py,
    src/web/templates/library/movie_detail.html,
    src/web/templates/library/series_detail.html,
    src/web/templates/library/_filters.html,
    src/web/static/css/style.css
  </files>
  <action>
    **1. Backend — filtre personne dans `library.py` :**

    Dans la route `library_index`, ajouter un query param `person: Optional[str] = None` :
    - Si `person` est fourni, filtrer les résultats : `WHERE director LIKE %person% OR cast_json LIKE %person%`
    - Appliquer ce filtre sur les deux tables (movies ET series) si type="all"
    - Le filtre doit fonctionner en combinaison avec les autres filtres existants (genre, year, q, sort)

    Passer `person` au contexte template pour que `_filters.html` puisse l'afficher.

    **2. Templates détail — crédits cliquables :**

    Sur `movie_detail.html` :
    - Réalisateur : transformer `{{ movie.director }}` en `<a href="/library/?person={{ movie.director | urlencode }}" class="lib-credit-link">{{ movie.director }}</a>`
    - Acteurs : boucler sur `movie.cast` au lieu de `join(', ')`, chaque acteur devient un `<a>` cliquable

    Sur `series_detail.html` :
    - Même transformation pour `series.director` (créateurs)
    - Même transformation pour `series.cast`

    **3. Tag filtre actif dans `_filters.html` :**

    Ajouter un tag "personne" dans la zone des filtres actifs quand `person` est défini :
    - Afficher `<span class="filter-tag">Personne: {{ person }} <button>×</button></span>`
    - Le bouton × supprime le paramètre `person` de l'URL
    - Ajouter un `<input type="hidden" name="person" value="{{ person }}">` dans le formulaire pour préserver le filtre pendant les changements de genre/tri

    **4. CSS :**
    - `.lib-credit-link` : style lien discret, underline on hover, couleur accent
    - Les acteurs cliquables séparés par des virgules visuelles (via CSS `::after` ou séparateur inline)

    Éviter :
    - Ne PAS créer de page dédiée "personne" — le filtre bibliothèque suffit
    - Ne PAS faire de full-text search complexe — un simple LIKE sur director + cast_json est suffisant
  </action>
  <verify>
    - Naviguer vers une fiche film, cliquer sur le réalisateur → la bibliothèque s'ouvre filtrée
    - Cliquer sur un acteur → même comportement
    - Le tag filtre actif "Personne: X" apparait et le × le supprime
    - Combiner filtre personne + genre + tri → fonctionne
  </verify>
  <done>AC-2 satisfait : crédits cliquables avec filtre par personne fonctionnel</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Fiches détaillées enrichies avec :
    - Liens IMDb/TMDB cliquables en haut de page
    - Réalisateur et acteurs cliquables → filtre bibliothèque
    - Label source rating (IMDb/TMDB) dans la grille
  </what-built>
  <how-to-verify>
    1. Lancer : `uv run uvicorn src.web.app:app --reload`
    2. Ouvrir http://localhost:8000/library/
    3. Vérifier un badge rating dans la grille : label "IMDb" ou "TMDB" visible
    4. Cliquer sur un film → page détail
    5. Vérifier les boutons liens IMDb et TMDB (ouvrir dans nouvel onglet)
    6. Cliquer sur le réalisateur → bibliothèque filtrée par cette personne
    7. Cliquer sur un acteur → bibliothèque filtrée par cet acteur
    8. Vérifier le tag filtre actif "Personne: X" et le bouton × pour le supprimer
    9. Tester sur une série aussi
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/services/ (services d'enrichissement — phases 6-7 closes)
- src/infrastructure/persistence/ (modèles et repos — stables)
- src/adapters/cli/ (commandes CLI — pas d'impact)
- Logique de calcul `_best_rating()` dans library.py (le résultat est correct)
- Design system existant (couleurs, fonts, variables CSS)

## SCOPE LIMITS
- Pas de page dédiée "personne" ou "acteur" — le filtre bibliothèque suffit
- Pas de refactoring des templates existants au-delà des modifications demandées
- Pas d'enrichissement supplémentaire (données déjà complètes)
- Pas de recherche full-text avancée — LIKE suffit pour le filtre personne

</boundaries>

<verification>
Avant de déclarer le plan complet :
- [ ] Liens IMDb/TMDB visibles et fonctionnels sur fiches film et série
- [ ] Crédits cliquables → filtre bibliothèque par personne
- [ ] Label source rating visible dans la grille
- [ ] Tag filtre actif "Personne" avec bouton suppression
- [ ] uv run ruff check passe sans erreur sur les fichiers Python modifiés
- [ ] Vérification visuelle validée par l'utilisateur
</verification>

<success_criteria>
- Tous les tasks complétés
- Verification visuelle approuvée
- Aucune régression sur les pages existantes
</success_criteria>

<output>
Après complétion, créer `.paul/phases/08-fiches-detaillees-enrichies/08-01-SUMMARY.md`
</output>
