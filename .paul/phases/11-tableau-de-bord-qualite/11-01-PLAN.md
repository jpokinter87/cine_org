---
phase: 11-tableau-de-bord-qualite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/quality.py
  - src/web/templates/quality/dashboard.html
  - src/web/templates/quality/_coverage_stats.html
  - src/web/templates/quality/_correction_history.html
  - src/web/templates/base.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Créer un tableau de bord qualité web centralisant les métriques de couverture de l'enrichissement, le résumé des associations suspectes, et l'historique des corrections manuelles.

## Purpose
Donner à l'utilisateur une vue d'ensemble de la qualité de sa vidéothèque : quels champs sont bien remplis, combien d'associations sont suspectes, et quelles corrections ont été effectuées. C'est la dernière phase du milestone v1.2 Gestion Associations.

## Output
- Page `/quality` (dashboard) avec widgets de métriques
- Statistiques de couverture par type (films/séries) et par champ
- Historique des confirmations et ré-associations
- Navigation mise à jour : "Qualité" pointe vers le dashboard, lien vers la sous-page "Associations suspectes"
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/10-detection-automatique-erreurs/10-01-SUMMARY.md
- Phase 10 a créé : `quality.py` routes, `suspicious.html`, `_suspicious_list.html`, `AssociationChecker`, `ConfirmedAssociationModel`
- Le cache SSE et la page d'associations suspectes sont fonctionnels

## Source Files
@src/web/routes/quality.py
@src/web/templates/quality/suspicious.html
@src/web/templates/base.html
@src/infrastructure/persistence/models.py
</context>

<acceptance_criteria>

## AC-1: Page dashboard avec métriques de couverture
```gherkin
Given l'utilisateur accède à /quality
When la page se charge
Then il voit des widgets affichant la couverture par champ pour les films (poster, imdb_id, director, cast, file_path, resolution, overview, rating) et les séries (poster, tmdb_id, tvdb_id, overview, director, cast)
And chaque métrique affiche le nombre, le pourcentage, et une barre de progression visuelle
```

## AC-2: Résumé des associations suspectes
```gherkin
Given l'utilisateur est sur /quality
When des associations suspectes existent (cache ou scan)
Then il voit un widget résumé avec le nombre total, films suspects, séries suspectes
And un lien vers /quality/suspicious pour voir le détail
```

## AC-3: Historique des corrections
```gherkin
Given l'utilisateur est sur /quality
When des confirmations ou ré-associations ont eu lieu
Then il voit une section historique listant les dernières corrections (type, titre, date)
And les entrées sont triées par date décroissante
```

## AC-4: Navigation mise à jour
```gherkin
Given l'utilisateur clique sur "Qualité" dans la nav
When la page se charge
Then il arrive sur /quality (dashboard) et non plus directement sur /quality/suspicious
And la page dashboard contient un lien vers /quality/suspicious
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Backend — routes dashboard, métriques couverture, historique</name>
  <files>src/web/routes/quality.py, src/infrastructure/persistence/models.py</files>
  <action>
    1. **Route dashboard** `/quality` (GET) :
       - Requêter les comptages de couverture par champ depuis la DB
       - Films : COUNT total, COUNT WHERE poster_path IS NOT NULL, COUNT WHERE imdb_id IS NOT NULL, COUNT WHERE director IS NOT NULL, COUNT WHERE cast_json IS NOT NULL, COUNT WHERE file_path IS NOT NULL, COUNT WHERE resolution IS NOT NULL, COUNT WHERE overview IS NOT NULL, COUNT WHERE vote_average IS NOT NULL (ou > 0)
       - Séries : COUNT total, COUNT WHERE poster_path IS NOT NULL, COUNT WHERE tmdb_id IS NOT NULL, COUNT WHERE tvdb_id IS NOT NULL, COUNT WHERE overview IS NOT NULL, COUNT WHERE director IS NOT NULL, COUNT WHERE cast_json IS NOT NULL
       - Épisodes : COUNT total, COUNT WHERE file_path IS NOT NULL, COUNT WHERE resolution IS NOT NULL
       - Structurer sous forme de dicts : `{"label": "Poster", "field": "poster_path", "count": N, "total": T, "pct": P}`

    2. **Résumé associations suspectes** :
       - Lire le cache fichier existant (`_get_cache()`) pour obtenir le nombre de suspects sans relancer le scan
       - Si cache absent, indiquer "Aucun scan récent" avec bouton pour aller scanner

    3. **Historique corrections** :
       - Requêter `ConfirmedAssociationModel` triées par `id DESC` (pas de champ date, mais id est auto-increment donc ordre chronologique inverse)
       - Pour chaque confirmation, joindre le titre du film/série (lookup MovieModel/SeriesModel par entity_id)
       - Limiter aux 50 dernières

    4. **Mettre à jour la nav** : le lien "Qualité" dans `base.html` doit pointer vers `/quality` au lieu de `/quality/suspicious`

    5. Rendre le template `quality/dashboard.html` avec toutes ces données
  </action>
  <verify>
    uv run python -c "from src.web.routes.quality import router; print([r.path for r in router.routes])"
    Vérifier que /quality existe dans les routes.
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4 (backend) satisfaits : routes et données prêtes</done>
</task>

<task type="auto">
  <name>Task 2: Frontend — templates dashboard et styles</name>
  <files>src/web/templates/quality/dashboard.html, src/web/templates/base.html, src/web/static/css/style.css</files>
  <action>
    1. **Template `quality/dashboard.html`** :
       - Hérite de `base.html`, block `nav_quality` actif
       - Header : titre "Tableau de bord Qualité" avec icône
       - Section "Couverture enrichissement" :
         - Deux colonnes (films | séries) ou grille responsive
         - Pour chaque champ : label, barre de progression (div avec width en %), nombre/total, pourcentage
         - Couleur de la barre selon le pourcentage : vert >= 90%, jaune >= 70%, orange >= 50%, rouge < 50%
       - Section "Épisodes" : couverture file_path et résolution
       - Section "Associations suspectes" :
         - Widget résumé : nombre total, films, séries, avec pastille de couleur
         - Si cache présent : afficher les compteurs
         - Si cache absent : message "Aucun scan récent"
         - Bouton/lien "Voir les détails" → `/quality/suspicious`
         - Bouton "Rescanner" → `/quality/suspicious?force=true` (ou lien direct)
       - Section "Historique des corrections" :
         - Tableau ou liste des dernières confirmations avec type (film/série), titre, badge "Confirmé"
         - Si aucune correction : message "Aucune correction enregistrée"
       - Lien en pied vers la page détail `/quality/suspicious`

    2. **Mise à jour `base.html`** :
       - Changer `href="/quality/suspicious"` en `href="/quality"` dans la nav

    3. **CSS dans `style.css`** :
       - `.quality-dashboard` : layout grille responsive
       - `.quality-widget` : carte avec fond semi-transparent, border-radius, padding
       - `.quality-widget-title` : titre de section avec icône
       - `.coverage-grid` : grille de métriques (2 colonnes desktop, 1 mobile)
       - `.coverage-item` : ligne avec label + barre + pourcentage
       - `.coverage-bar` : fond gris, hauteur 8px, border-radius
       - `.coverage-bar-fill` : barre colorée avec transition
       - `.coverage-bar-fill.excellent` (>= 90%) : accent vert (#4ade80)
       - `.coverage-bar-fill.good` (>= 70%) : accent jaune (#facc15)
       - `.coverage-bar-fill.medium` (>= 50%) : accent orange (#fb923c)
       - `.coverage-bar-fill.poor` (< 50%) : accent rouge (#f87171)
       - `.suspect-summary` : widget compact avec compteurs et lien
       - `.correction-list` : liste stylée des corrections
       - Respecter le thème sombre existant (fond #0a0a0a, texte #e0e0e0, accent doré)
  </action>
  <verify>
    Démarrer `uv run uvicorn src.web.app:app --reload` et accéder à /quality
    Vérifier que les widgets s'affichent avec les bonnes données.
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4 satisfaits côté frontend</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Tableau de bord qualité avec :
    - Métriques de couverture enrichissement (films, séries, épisodes)
    - Résumé des associations suspectes (depuis le cache)
    - Historique des corrections (confirmations)
    - Navigation mise à jour (Qualité → dashboard)
  </what-built>
  <how-to-verify>
    1. Démarrer : `uv run uvicorn src.web.app:app --reload`
    2. Accéder à http://192.168.1.15:8000/quality
    3. Vérifier les métriques de couverture films (poster ~99.7%, imdb_id ~99.3%, file_path ~76.9%, resolution ~69.1%)
    4. Vérifier les métriques de couverture séries (poster ~98.8%, tmdb_id ~99.3%, tvdb_id ~98.0%)
    5. Vérifier le résumé des associations suspectes (compteur + lien vers /quality/suspicious)
    6. Vérifier l'historique des corrections (94 confirmations existantes)
    7. Cliquer sur "Qualité" dans la nav → doit aller sur /quality
    8. Cliquer le lien vers les associations suspectes → doit aller sur /quality/suspicious
    9. Responsive : vérifier sur mobile/tablette
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- `src/services/association_checker.py` (service de détection stable)
- `src/web/templates/quality/suspicious.html` (page suspectes existante)
- `src/web/templates/quality/_suspicious_list.html` (fragment existant)
- Le mécanisme de cache SSE existant
- Les routes CLI

## SCOPE LIMITS
- Pas de nouveau modèle de données (utiliser les données existantes)
- Pas de migration DB
- Pas de graphiques/charts JS complexes (barres CSS simples)
- Pas de système d'export des métriques
- Pas d'enrichissement batch automatique depuis le dashboard

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest tests/ -x` passe (aucun test cassé)
- [ ] `uv run ruff check src/web/routes/quality.py` propre
- [ ] Page /quality accessible et affiche les métriques
- [ ] Barres de couverture colorées selon les seuils
- [ ] Lien nav "Qualité" pointe vers /quality
- [ ] Lien vers /quality/suspicious fonctionne depuis le dashboard
- [ ] Historique des corrections affiché
- [ ] Responsive correct
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Dashboard qualité fonctionnel et intégré à la navigation
</success_criteria>

<output>
After completion, create `.paul/phases/11-tableau-de-bord-qualite/11-01-SUMMARY.md`
</output>
