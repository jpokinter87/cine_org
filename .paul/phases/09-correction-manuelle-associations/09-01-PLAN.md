---
phase: 09-correction-manuelle-associations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/library.py
  - src/web/templates/library/movie_detail.html
  - src/web/templates/library/series_detail.html
  - src/web/templates/library/_reassociate_overlay.html
  - src/web/templates/library/_reassociate_results.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Permettre la correction manuelle d'une association TMDB erronée depuis la fiche web d'un film ou d'une série, avec recherche TMDB, affichage des candidats enrichis (poster, année, synopsis, durée) et indicateurs de confiance sur la qualité de l'association.

## Purpose
Quand un film ou une série est mal identifié (ex: "1492: Christophe Colomb" associé au documentaire "1492"), l'utilisateur peut corriger directement depuis la fiche web sans passer par le CLI. L'affichage d'indicateurs de durée (films) et de nombre d'épisodes/saisons (séries) permet de confirmer visuellement la qualité de l'association choisie.

## Output
- Bouton "Corriger l'association" sur les fiches film et série
- Overlay de recherche TMDB avec champ modifiable et résultats enrichis
- Indicateur de comparaison durée (film local vs TMDB) pour les films
- Indicateur nombre de saisons/épisodes pour les séries
- Route POST de ré-association avec enrichissement complet
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/08-fiches-detaillees-enrichies/08-01-SUMMARY.md
  - Liens IMDb/TMDB, crédits cliquables — fiches détaillées enrichies en place

## Source Files
@src/web/routes/library.py
@src/web/templates/library/movie_detail.html
@src/web/templates/library/series_detail.html
@src/adapters/api/tmdb_client.py
@src/infrastructure/persistence/models.py

## Existing CLI Logic to Reuse
La logique de comparaison durée existe déjà dans le CLI :
- `_get_duration_color(file_duration, api_duration)` dans `src/adapters/cli/validation/candidate_display.py:154` — seuils : vert <5min, jaune <15min, rouge >=15min
- `render_enriched_candidate_card()` dans `candidate_display.py:183` — affiche durée fichier vs TMDB avec code couleur
- `MatcherService.score_results()` intègre la durée à 25% du score pour les films
- `interactive_loop.py:228` — recherche manuelle TMDB via `service.search_manual(query, is_series)`
- Transposer ces mêmes seuils et cette logique au web (mêmes codes couleur, mêmes indicateurs)
</context>

<skills>
## Required Skills

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | optional | Pour le style de l'overlay | ○ |

</skills>

<acceptance_criteria>

## AC-1: Bouton correction visible
```gherkin
Given une fiche film ou série avec un tmdb_id
When l'utilisateur consulte la fiche
Then un bouton "Corriger l'association" est visible dans la zone badges
```

## AC-2: Recherche TMDB dans overlay
```gherkin
Given l'utilisateur clique sur "Corriger l'association"
When l'overlay s'ouvre avec le titre pré-rempli
Then il peut modifier la recherche et voir les résultats TMDB (poster, titre, année, synopsis)
And pour un film, chaque candidat affiche sa durée TMDB et la durée locale pour comparaison
And pour une série, chaque candidat affiche le nombre de saisons depuis TMDB
```

## AC-3: Ré-association complète
```gherkin
Given l'utilisateur sélectionne un candidat TMDB
When il confirme la sélection
Then le film/série est ré-enrichi avec toutes les données TMDB (titre, genres, poster, crédits, ratings, IDs)
And la page se recharge avec les nouvelles informations
```

## AC-4: Indicateurs de confiance durée (films)
```gherkin
Given un film avec duration_seconds en DB
When les résultats de recherche TMDB s'affichent
Then chaque candidat film montre "Durée TMDB: Xh XXmin" et "Fichier local: Yh YYmin"
And les mêmes seuils que le CLI s'appliquent : vert <5min, jaune <15min, rouge >=15min
```

## AC-5: Indicateurs de confiance séries
```gherkin
Given une série en DB
When les résultats de recherche TMDB s'affichent
Then chaque candidat série affiche le nombre de saisons et épisodes totaux depuis TMDB
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Routes backend recherche et ré-association</name>
  <files>src/web/routes/library.py</files>
  <action>
    Ajouter 4 routes dans library.py :

    1. `GET /library/movies/{movie_id}/reassociate` — Retourne le fragment HTML de l'overlay de recherche
       - Récupère le film depuis la DB (MovieModel)
       - Passe `title`, `year`, `duration_seconds`, `movie_id` au template `_reassociate_overlay.html`
       - Template type="movie"

    2. `GET /library/movies/{movie_id}/reassociate/search?q=...` — Recherche TMDB films
       - Accède au container : `container = request.app.state.container`
       - Appelle `container.tmdb_client().search(q)` pour obtenir les SearchResult
       - Pour chaque résultat (max 8), appelle `container.tmdb_client().get_details(result.id)` pour récupérer poster, synopsis, durée TMDB
       - Retourne le fragment `_reassociate_results.html` avec les candidats enrichis
       - Passe aussi `local_duration_seconds` du film en DB pour comparaison

    3. `POST /library/movies/{movie_id}/reassociate` — Applique la ré-association
       - Paramètre form : `tmdb_id` (str)
       - Appelle `get_details(tmdb_id)` pour les données complètes
       - Appelle `get_external_ids(tmdb_id)` pour imdb_id
       - Met à jour le MovieModel : tmdb_id, imdb_id, title, original_title, year, genres_json, duration_seconds (TMDB), overview, poster_path, director, cast_json, vote_average, vote_count, updated_at
       - Conserve intacts : file_path, file_hash, codec_video, codec_audio, resolution, languages_json, file_size_bytes, imdb_rating
       - Retourne HX-Redirect vers `/library/movies/{movie_id}`

    4. Mêmes 3 routes pour séries (`/library/series/{series_id}/reassociate/...`)
       - Recherche via `search_tv(q)` + `get_tv_details(result.id)` pour poster, synopsis
       - TMDB API `/tv/{id}` retourne `number_of_seasons` et `number_of_episodes` — les extraire du JSON brut dans get_tv_details ou via un appel supplémentaire
       - POST : met à jour SeriesModel via `get_tv_details` + `get_tv_external_ids`
       - Met à jour : tmdb_id, imdb_id, title, original_title, year, genres_json, overview, poster_path, director, cast_json, vote_average, vote_count
       - Conserve tvdb_id (le mettre à None car l'association change)

    Important :
    - Utiliser `get_session()` pour l'accès DB direct (pattern existant dans library.py)
    - Utiliser `request.app.state.container` pour le TMDBClient (pattern validation.py)
    - Les routes GET search sont async (appels TMDB)
    - Les routes POST sont async (appels TMDB + DB)
    - Pour les séries, il faudra enrichir `get_tv_details` ou accéder au JSON brut pour `number_of_seasons`/`number_of_episodes` — option simple : ajouter ces champs à MediaDetails ou les passer en extra
  </action>
  <verify>
    Démarrer le serveur web et vérifier que les routes répondent :
    - GET /library/movies/1/reassociate → 200 avec HTML overlay
    - GET /library/movies/1/reassociate/search?q=1492 → 200 avec résultats
  </verify>
  <done>AC-2 (backend) et AC-3 satisfaits : recherche TMDB et ré-association fonctionnelles</done>
</task>

<task type="auto">
  <name>Task 2: Templates overlay et résultats avec indicateurs</name>
  <files>
    src/web/templates/library/movie_detail.html,
    src/web/templates/library/series_detail.html,
    src/web/templates/library/_reassociate_overlay.html,
    src/web/templates/library/_reassociate_results.html,
    src/web/static/css/style.css
  </files>
  <action>
    1. **Bouton "Corriger l'association"** dans movie_detail.html et series_detail.html :
       - Ajouter dans `div.lib-detail-badges` après les liens externes
       - Bouton avec icône crayon/edit, style discret (outline) : `hx-get="/library/movies/{id}/reassociate" hx-target="#reassociate-container"`
       - Ajouter un `<div id="reassociate-container"></div>` en fin de page (avant le lightbox)

    2. **Template `_reassociate_overlay.html`** (fragment HTMX) :
       - Overlay plein écran (même pattern que poster-lightbox + reject-overlay)
       - Champ de recherche pré-rempli avec le titre actuel
       - `hx-get="/library/{type}s/{id}/reassociate/search" hx-trigger="input changed delay:500ms, keyup[key=='Enter']" hx-target="#reassociate-results" hx-indicator="#reassociate-spinner"`
       - Zone résultats `#reassociate-results` avec spinner
       - Bouton Annuler qui ferme l'overlay
       - Paramètre `type` (movie/series) pour construire les URLs

    3. **Template `_reassociate_results.html`** (fragment HTMX) :
       - Pour chaque candidat : carte avec poster miniature, titre, titre original si différent, année, synopsis tronqué (~100 chars)
       - **Films** : afficher "Durée TMDB : Xh XXmin" et "Fichier local : Yh YYmin"
         - Réutiliser les mêmes seuils que le CLI (`_get_duration_color` dans `candidate_display.py`) :
           - Écart <5min → vert "✓ Durée cohérente"
           - Écart 5-15min → jaune/orange "⚠ Écart modéré"
           - Écart >=15min → rouge "✗ Durée très différente"
         - Si pas de durée locale ou TMDB : pas de badge
       - **Séries** : afficher "X saisons, Y épisodes" depuis TMDB (champs `number_of_seasons`/`number_of_episodes` du JSON TMDB)
       - Bouton "Sélectionner" sur chaque carte : `hx-post="/library/{type}s/{id}/reassociate" hx-vals='{"tmdb_id": "..."}'`
       - `hx-confirm="Confirmer la ré-association avec {title} ({year}) ?"` pour sécuriser
       - Le résultat actuel (même tmdb_id) est marqué visuellement comme "Association actuelle"

    4. **CSS** dans style.css :
       - `.reassociate-overlay` : position fixed, fond semi-transparent, z-index au dessus du contenu
       - `.reassociate-dialog` : panneau centré, scroll si beaucoup de résultats, largeur ~700px
       - `.reassociate-search-input` : champ texte stylé thème sombre
       - `.reassociate-card` : carte candidat avec poster à gauche, infos à droite (flexbox)
       - `.reassociate-duration-match` / `.reassociate-duration-warn` : badges vert/orange pour l'indicateur durée
       - `.reassociate-current` : bordure distinctive pour l'association actuelle
       - Responsive : sur mobile, les cartes passent en pleine largeur
  </action>
  <verify>
    Inspecter visuellement l'overlay sur une fiche film et une fiche série.
    Vérifier que l'indicateur de durée s'affiche correctement avec les bonnes couleurs.
  </verify>
  <done>AC-1, AC-2 (frontend) et AC-4 satisfaits : overlay fonctionnel avec indicateurs de confiance</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Correction manuelle des associations TMDB depuis les fiches web :
    - Bouton "Corriger l'association" sur fiches film et série
    - Overlay de recherche avec résultats enrichis
    - Indicateur de comparaison durée pour les films
    - Indicateur saisons/épisodes pour les séries
    - Ré-association complète avec rechargement de la fiche
  </what-built>
  <how-to-verify>
    1. Lancer : `uv run uvicorn src.web.app:app --reload`
    2. Aller sur la fiche du film "1492" mal associé
    3. Cliquer sur "Corriger l'association"
    4. Vérifier que l'overlay s'ouvre avec "1492" pré-rempli
    5. Modifier la recherche en "1492 Christophe Colomb"
    6. Vérifier les candidats avec poster, année, synopsis, **durée comparée**
    7. Sélectionner "1492 : Conquête du paradis" (Ridley Scott, 1992)
    8. Confirmer — la fiche doit se recharger avec les bonnes données
    9. Tester aussi sur une fiche série
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/adapters/api/tmdb_client.py — pas de modification de l'API client existant (sauf éventuellement pour exposer number_of_seasons/episodes)
- src/infrastructure/persistence/models.py — pas de modification du schéma DB
- src/core/entities/ — pas de modification des entités domaine
- Pattern CLI existant — cette feature est web uniquement

## SCOPE LIMITS
- Pas de renommage de fichier lors de la ré-association (seulement les métadonnées DB)
- Pas de détection automatique d'erreurs (Phase 10)
- Pas d'historique des corrections (Phase 11)
- Pas de modification du SearchResult ou MediaDetails (utiliser les données brutes si besoin)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Bouton visible sur fiche film et série
- [ ] Overlay s'ouvre et affiche les résultats de recherche TMDB
- [ ] Indicateur de durée film (comparaison local vs TMDB) avec code couleur
- [ ] Indicateur saisons/épisodes pour les séries
- [ ] Ré-association met à jour toutes les métadonnées TMDB
- [ ] Page se recharge correctement après ré-association
- [ ] Le film "1492" peut être correctement ré-associé à "1492: Conquest of Paradise"
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Film "1492" corrigé avec succès depuis la fiche web
- Indicateurs de confiance (durée, saisons) visibles et utiles
</success_criteria>

<output>
After completion, create `.paul/phases/09-correction-manuelle-associations/09-01-SUMMARY.md`
</output>
