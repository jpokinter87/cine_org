---
phase: 15-que-regarder-ce-soir
plan: 02
type: execute
wave: 1
depends_on: ["15-01"]
files_modified:
  - src/web/routes/library/suggest.py
  - src/web/routes/library/__init__.py
  - src/web/templates/library/suggest.html
  - src/web/templates/home.html
  - src/web/templates/base.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Créer une page "Surprends-moi" avec algorithme de suggestion intelligente, filtres optionnels (genre, durée dispo, humeur), et bouton d'accès rapide sur la page d'accueil + barre de navigation.

## Purpose
Proposer un film (ou série) à regarder parmi la bibliothèque en un clic, excluant les "déjà vus" (sauf bien notés), pour répondre au cas d'usage quotidien "que regarder ce soir ?".

## Output
- Nouveau module `suggest.py` avec route `/library/suggest`
- Template `suggest.html` avec filtres et affichage du résultat
- Bouton accueil "Surprends-moi" (4ème bouton actions rapides)
- Lien navigation vers la suggestion
- Version footer corrigée
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/15-que-regarder-ce-soir/15-01-SUMMARY.md
- Plan 01 a créé les colonnes `watched` et `personal_rating` sur MovieModel et SeriesModel
- Toggle "Déjà vu" et widget étoiles fonctionnels
- Filtre "Non-vus" en place sur la bibliothèque

## Source Files
@src/web/routes/library/__init__.py
@src/web/routes/library/browse.py
@src/web/routes/library/helpers.py
@src/web/routes/home.py
@src/web/templates/home.html
@src/web/templates/base.html
@src/infrastructure/persistence/models.py
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant création template suggest.html et styles CSS | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded (run command or confirm)
</skills>

<acceptance_criteria>

## AC-1: Algorithme de suggestion
```gherkin
Given la bibliothèque contient des films et séries avec des notes et tags "déjà vu"
When l'utilisateur demande une suggestion sans filtres
Then un film ou série est proposé aléatoirement parmi les non-vus
  And les films "déjà vus" avec note personnelle >= 4 sont éligibles (re-watch)
  And les films "déjà vus" sans bonne note sont exclus
```

## AC-2: Filtres optionnels
```gherkin
Given la page suggestion est affichée
When l'utilisateur sélectionne un genre et/ou une durée disponible
Then la suggestion est filtrée selon ces critères
  And le filtre durée exclut les films plus longs que le temps disponible
  And le filtre genre limite aux films/séries du genre choisi
```

## AC-3: Page suggestion avec résultat
```gherkin
Given l'utilisateur accède à /library/suggest
When une suggestion est calculée
Then la page affiche la jaquette, le titre, l'année, le genre, la note publique et le synopsis
  And un bouton "Autre suggestion" recharge avec les mêmes filtres
  And un lien "Voir la fiche" mène à la page détail du film/série
```

## AC-4: Bouton accueil et navigation
```gherkin
Given la page d'accueil est affichée
When l'utilisateur regarde les actions rapides
Then un 4ème bouton "Surprends-moi" est visible
  And il mène à /library/suggest
  And la barre de navigation contient un lien vers la page suggestion
```

## AC-5: Version footer corrigée
```gherkin
Given n'importe quelle page est affichée
When l'utilisateur regarde le footer
Then la version affichée est "v1.4" (pas "v0.1.0")
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Créer le module suggest.py avec algorithme de suggestion</name>
  <files>src/web/routes/library/suggest.py, src/web/routes/library/__init__.py</files>
  <action>
    Créer `src/web/routes/library/suggest.py` avec :

    **Route GET `/suggest`** :
    - Paramètres optionnels : `genre` (str), `max_duration` (int, minutes), `type` (all/movie/series)
    - Requête films : `watched == False` OU (`watched == True` ET `personal_rating >= 4`)
    - Requête séries : même logique watched/rating sur SeriesModel
    - Si `genre` fourni : filtrer `genres_json.contains(genre_escaped)`
    - Si `max_duration` fourni : filtrer `duration_seconds <= max_duration * 60` (films uniquement)
    - Si `type` fourni : limiter à movie ou series
    - Combiner films + séries dans une liste, choisir un élément aléatoire (`random.choice`)
    - Construire un dict résultat avec : id, type, title, year, genres, poster_url, rating, rating_source, overview, duration (formatée), watched, personal_rating
    - Si aucun candidat : résultat None
    - Passer la liste des genres distincts et le résultat au template

    **Intégrer dans le router** :
    - Importer et inclure `suggest.router` dans `library/__init__.py`
    - Le placer AVANT `detail.router` (sinon `/suggest` serait intercepté par `/movies/{id}`)

    Réutiliser les helpers existants : `_parse_genres`, `_poster_url`, `_best_rating`, `_genre_json_escaped`, `_format_duration`
  </action>
  <verify>uv run python -c "from src.web.routes.library.suggest import router; print('OK')"</verify>
  <done>AC-1 et AC-2 satisfaits : algorithme de suggestion avec filtres</done>
</task>

<task type="auto">
  <name>Task 2: Créer le template suggest.html et les styles CSS</name>
  <files>src/web/templates/library/suggest.html, src/web/static/css/style.css</files>
  <action>
    Créer `src/web/templates/library/suggest.html` :
    - Extends base.html, block title "Surprends-moi"
    - Section filtres en haut : select genre (dropdown), input durée dispo (minutes), select type (Tous/Films/Séries)
    - Les filtres soumettent en GET vers `/library/suggest` (pas HTMX, rechargement complet OK)
    - Si résultat trouvé :
      - Grande jaquette à gauche, infos à droite (titre, année, genres en badges, note publique, synopsis)
      - Bouton "Autre suggestion" = lien vers /library/suggest avec les mêmes paramètres filtres
      - Bouton "Voir la fiche" = lien vers /library/movies/{id} ou /library/series/{id}
    - Si aucun résultat :
      - Message "Aucun film ne correspond à vos critères" avec suggestion d'élargir les filtres

    Ajouter les styles CSS dans style.css :
    - Layout responsive : jaquette + infos side-by-side (flex), stack sur mobile
    - Cohérent avec le thème sombre existant (couleurs, polices, boutons)
    - Boutons stylés comme les action-btn existants

    **Important :** Le design sera affiné par /frontend-design au checkpoint. Fournir une base fonctionnelle propre.
  </action>
  <verify>Le template est syntaxiquement correct (extends base.html, blocks présents)</verify>
  <done>AC-3 satisfait : page suggestion avec résultat, boutons "Autre" et "Voir la fiche"</done>
</task>

<task type="auto">
  <name>Task 3: Bouton accueil, lien navigation, et version footer</name>
  <files>src/web/templates/home.html, src/web/templates/base.html</files>
  <action>
    **home.html** :
    - Ajouter un 4ème bouton dans la section `actions-row` :
      - Lien vers `/library/suggest`
      - Icône dé/shuffle (SVG inline, style cohérent avec les 3 boutons existants)
      - Texte "Surprends-moi"
      - Classe `action-btn action-primary` (comme les autres)

    **base.html** :
    - Footer : changer "CineOrg v0.1.0" en "CineOrg v1.4"
    - Navigation : pas de lien dédié — la page est accessible via le bouton accueil et la bibliothèque
  </action>
  <verify>Vérifier que le bouton est présent dans home.html et la version footer dans base.html</verify>
  <done>AC-4 et AC-5 satisfaits : bouton accueil + version footer</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Page "Surprends-moi" avec algorithme de suggestion, filtres, et bouton accueil</what-built>
  <how-to-verify>
    1. Lancer : `uv run uvicorn src.web.app:app --reload --host 0.0.0.0`
    2. Accueil (http://192.168.1.15:8000) : vérifier le 4ème bouton "Surprends-moi"
    3. Cliquer sur "Surprends-moi" : une suggestion s'affiche avec jaquette, titre, infos
    4. Tester "Autre suggestion" : un nouveau film/série est proposé
    5. Tester le filtre genre : sélectionner un genre, vérifier cohérence
    6. Tester le filtre durée : mettre 90 min, vérifier que les films > 90 min sont exclus
    7. Tester "Voir la fiche" : redirige vers la bonne fiche détail
    8. Vérifier le footer : "CineOrg v1.4"
    9. Vérifier le design : cohérent avec le thème sombre, responsive
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/infrastructure/persistence/models.py (schema déjà en place depuis plan 01)
- src/infrastructure/persistence/database.py (migrations stables)
- src/web/routes/library/detail.py (routes watched/rating stables)
- src/web/routes/library/browse.py (filtres bibliothèque stables)

## SCOPE LIMITS
- Pas de machine learning ni d'algorithme de recommandation complexe — random parmi les éligibles
- Pas de préférences utilisateur persistantes (historique de suggestions)
- Pas de suggestions basées sur l'humeur (hors scope — le filtre genre suffit)
- Les séries sont suggérées comme entité complète (pas par épisode)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest` — aucune régression
- [ ] `uv run ruff check src/web/routes/library/suggest.py` — pas d'erreur lint
- [ ] Page /library/suggest fonctionne sans erreur
- [ ] Suggestion exclut les "déjà vus" (sauf note >= 4)
- [ ] Filtres genre et durée fonctionnels
- [ ] Bouton accueil présent et fonctionnel
- [ ] Footer affiche v1.4
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Page suggestion accessible et fonctionnelle
- Algorithme respecte les règles d'exclusion watched/rating
</success_criteria>

<output>
After completion, create `.paul/phases/15-que-regarder-ce-soir/15-02-SUMMARY.md`
</output>
