---
phase: 18-reassociation-transfert
plan: 02
type: execute
wave: 1
depends_on: ["18-01"]
files_modified:
  - src/services/validation.py
  - src/web/routes/validation.py
  - src/web/templates/validation/list.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Afficher les fichiers auto-validés sur la page /validation avec possibilité de les remettre en validation manuelle.

## Purpose
Compléter la Phase 18 en offrant un second point d'accès à la ré-association : depuis la page validation elle-même. L'utilisateur voit les fichiers auto-validés et peut les "défaire" pour les revalider manuellement avec un meilleur candidat.

## Output
- Section "Auto-validés" sur la page /validation avec liste des fichiers auto-validés
- Bouton "Revalider" par fichier qui appelle reset_to_pending() (créé en plan 01)
- Le fichier revient en liste pending et peut être traité normalement
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Prior Work
@.paul/phases/18-reassociation-transfert/18-01-SUMMARY.md (fournit reset_to_pending)

## Source Files
@src/services/validation.py
@src/web/routes/validation.py
@src/web/templates/validation/list.html
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Modification template list.html | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Section auto-validés visible
```gherkin
Given la page /validation est affichée
When il existe des fichiers avec status=validated et auto_validated=True
Then une section "Auto-validés" apparaît sous la liste pending (ou à la place de l'état vide)
And chaque fichier affiche le nom du fichier, le candidat sélectionné et le score
```

## AC-2: Bouton revalider remet en pending
```gherkin
Given un fichier auto-validé affiché dans la section "Auto-validés"
When l'utilisateur clique sur "Revalider"
Then le fichier est remis en statut pending (via reset_to_pending du plan 01)
And la page se recharge
And le fichier apparaît maintenant dans la liste pending classique
```

## AC-3: Pas de section si aucun auto-validé
```gherkin
Given la page /validation est affichée
When aucun fichier n'a status=validated et auto_validated=True
Then la section "Auto-validés" n'apparaît pas
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Méthode list_auto_validated + route reset + données template</name>
  <files>src/services/validation.py, src/web/routes/validation.py</files>
  <action>
    1. Dans ValidationService (validation.py), ajouter :
       ```python
       def list_auto_validated(self) -> list[PendingValidation]:
           """Liste les fichiers auto-validés (candidats à la ré-association)."""
           return self._pending_repo.list_auto_validated()
       ```

    2. Dans le repository pending_validation_repository.py, ajouter :
       ```python
       def list_auto_validated(self) -> list[PendingValidation]:
           """Retourne les PendingValidation auto-validés."""
           # Query: validation_status == "validated" AND auto_validated == True
       ```

    3. Dans validation.py route GET /validation/, enrichir le contexte :
       - Appeler service.list_auto_validated() pour obtenir la liste
       - Pour chaque item auto-validé, préparer les données (id, filename, selected candidat title, score)
       - Passer `auto_validated_items` au template

    4. Dans validation.py, ajouter une route POST :
       ```python
       @router.post("/{pending_id}/reset", response_class=HTMLResponse)
       async def reset_to_pending(request, pending_id):
       ```
       - Récupérer le pending, appeler service.reset_to_pending()
       - HX-Redirect vers /validation
  </action>
  <verify>uv run pytest tests/unit/test_validation.py -v</verify>
  <done>AC-2 (logique back-end) satisfait</done>
</task>

<task type="auto">
  <name>Task 2: Template section auto-validés + CSS</name>
  <files>src/web/templates/validation/list.html, src/web/static/css/style.css</files>
  <action>
    1. Dans list.html, ajouter une section après la liste pending (avant l'empty-state) :
       - Condition : {% if auto_validated_items %}
       - Titre : "Auto-validés" avec compteur
       - Liste de cartes similaires aux pending-card mais avec style distinct (plus atténué)
       - Chaque carte affiche : nom du fichier, candidat choisi, score, badge "auto"
       - Bouton "Revalider" (hx-post="/validation/{id}/reset", hx-confirm)

    2. Adapter la logique empty-state :
       - Si items vide ET auto_validated_items non vide : ne PAS montrer l'état vide
       - Si items vide ET auto_validated_items vide ET has_validated : bouton transfert
       - Si tout vide : message standard

    3. CSS : styles pour la section auto-validés
       - .autovalidated-section, .autovalidated-card
       - Style atténué (opacité réduite ou bordure différente) pour distinguer du pending
       - Bouton revalider discret mais accessible
  </action>
  <verify>Vérification visuelle dans le navigateur</verify>
  <done>AC-1, AC-3 satisfaits</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Section "Auto-validés" sur la page /validation avec bouton Revalider</what-built>
  <how-to-verify>
    1. Visiter http://localhost:8111/validation
    2. Si des fichiers auto-validés existent, la section "Auto-validés" apparaît
    3. Cliquer "Revalider" sur un fichier → confirm → la page se recharge
    4. Le fichier apparaît maintenant dans la liste pending classique
    5. Si aucun auto-validé, la section n'apparaît pas
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/web/templates/validation/detail.html (page détail inchangée)
- src/web/templates/validation/_candidate_card.html
- Logique d'auto-validation existante (process_auto_validation)
- Routes de recherche manuelle

## SCOPE LIMITS
- Pas de modification de la logique de scoring ou matching
- La section auto-validés montre uniquement les auto-validés, pas les validés manuellement
- Pas de filtre/tri avancé sur la section auto-validés

</boundaries>

<verification>
Before declaring plan complete:
- [ ] uv run pytest tests/unit/test_validation.py -v
- [ ] uv run ruff check src/services/validation.py src/web/routes/validation.py
- [ ] uv run ruff format --check src/services/validation.py src/web/routes/validation.py
- [ ] Vérification visuelle (checkpoint human-verify)
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Section auto-validés visible et fonctionnelle
- Revalider remet effectivement un fichier en pending
</success_criteria>

<output>
After completion, create `.paul/phases/18-reassociation-transfert/18-02-SUMMARY.md`
</output>
