---
phase: 18-reassociation-transfert
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/validation.py
  - src/web/routes/transfer.py
  - src/web/templates/transfer/_batch_tree.html
  - src/web/templates/transfer/index.html
  - src/web/static/css/style.css
  - tests/unit/test_validation.py
autonomous: false
---

<objective>
## Goal
Permettre de renvoyer un fichier en validation depuis la page transfert quand l'auto-validation était erronée.

## Purpose
Actuellement, un fichier mal auto-validé (ex: Atiye/The Gift avec deux tvdb_id distincts) ne peut être corrigé qu'en intervenant en base. Ce plan ajoute un bouton "Renvoyer en validation" sur chaque fichier de la page transfert, permettant de corriger l'erreur directement depuis l'interface.

## Output
- Bouton par fichier dans l'arborescence de transfert
- Route POST /transfer/send-back/{pending_id}
- Méthode ValidationService.reset_to_pending()
- Le fichier renvoyé disparaît de la page transfert et réapparaît dans la page validation
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Source Files
@src/services/validation.py
@src/web/routes/transfer.py
@src/web/templates/transfer/_batch_tree.html
@src/web/templates/transfer/index.html
@src/adapters/cli/batch_builder.py
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Modification template _batch_tree.html | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Bouton renvoyer visible par fichier
```gherkin
Given la page /transfer affiche un batch de fichiers validés
When l'utilisateur consulte la liste
Then chaque fichier a un bouton "Renvoyer en validation" (icône) à côté de son nom
```

## AC-2: Renvoi d'un fichier en validation
```gherkin
Given un fichier validé affiché dans le batch de transfert
When l'utilisateur clique sur "Renvoyer en validation"
Then le fichier est remis en statut "pending" (validation_status=pending, selected_candidate_id=None, auto_validated=False)
And la ligne du fichier disparaît de l'arborescence (remplacement HTMX)
And un message de confirmation s'affiche brièvement
```

## AC-3: Rafraîchissement compteurs
```gherkin
Given un fichier vient d'être renvoyé en validation
When la ligne disparaît
Then le compteur total et le compteur par type (films/séries) se mettent à jour
```

## AC-4: Tests unitaires
```gherkin
Given le service ValidationService
When reset_to_pending() est appelé sur un PendingValidation validé
Then le statut revient à PENDING, selected_candidate_id est None, auto_validated est False
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Service reset_to_pending + route send-back + données pending_id</name>
  <files>src/services/validation.py, src/web/routes/transfer.py, src/adapters/cli/batch_builder.py (lecture seule pour comprendre), tests/unit/test_validation.py</files>
  <action>
    1. Dans ValidationService (validation.py), ajouter :
       ```python
       def reset_to_pending(self, pending: PendingValidation) -> PendingValidation:
           pending.validation_status = ValidationStatus.PENDING
           pending.selected_candidate_id = None
           pending.auto_validated = False
           return self._pending_repo.save(pending)
       ```

    2. Dans _build_tree_data() (transfer.py), ajouter `pending_id` à chaque entry dict :
       - Le transfer dict contient `t["pending"]` qui est un PendingValidation
       - Ajouter `entry["pending_id"] = t["pending"].id`

    3. Dans transfer.py, ajouter une route POST :
       ```python
       @router.post("/send-back/{pending_id}", response_class=HTMLResponse)
       async def send_back(request: Request, pending_id: int):
       ```
       - Récupérer le PendingValidation par ID via le repository
       - Appeler validation_service.reset_to_pending()
       - Recalculer le batch et tree_data (en reconstruisant via build_transfers_batch)
       - Retourner un fragment HTMX qui rafraîchit toute la section #transfer-area

       Note : plutôt que de reconstruire le batch (coûteux), on peut simplement retourner un fragment vide pour la ligne et utiliser hx-target sur la ligne. Mais les compteurs doivent aussi changer. Solution : la route retourne un redirect HX-Redirect vers /transfer qui recalcule tout.

    4. Dans test_validation.py, ajouter un test pour reset_to_pending :
       - Créer un PendingValidation avec status=VALIDATED et selected_candidate_id set
       - Appeler reset_to_pending()
       - Vérifier status=PENDING, selected_candidate_id=None, auto_validated=False
  </action>
  <verify>uv run pytest tests/unit/test_validation.py -v -k "reset_to_pending"</verify>
  <done>AC-2 (logique back-end), AC-4 satisfaits</done>
</task>

<task type="auto">
  <name>Task 2: Bouton renvoyer dans le template + CSS</name>
  <files>src/web/templates/transfer/_batch_tree.html, src/web/templates/transfer/index.html, src/web/static/css/style.css</files>
  <action>
    1. Dans _batch_tree.html, ajouter un bouton dans chaque .tree-leaf :
       - Bouton avec icône "undo" (flèche retour)
       - hx-post="/transfer/send-back/{{ item.pending_id }}"
       - hx-confirm="Renvoyer ce fichier en validation ?"
       - Utiliser HX-Redirect côté serveur pour recharger /transfer après le renvoi
       - Le bouton est positionné à droite de la ligne (flex)
       - Classes: "tree-leaf-sendback"
       - Title: "Renvoyer en validation"

    2. Dans style.css, ajouter les styles :
       - .tree-leaf-sendback : bouton discret, icône seule, hover en accent-warm
       - .tree-leaf-main : adapter le flex pour accommoder le bouton
       - Rester cohérent avec le thème sombre existant

    3. Pas besoin de modifier index.html sauf si nécessaire pour l'intégration HTMX
  </action>
  <verify>Vérification visuelle dans le navigateur</verify>
  <done>AC-1, AC-3 satisfaits</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Bouton "Renvoyer en validation" sur chaque fichier de la page transfert</what-built>
  <how-to-verify>
    1. Lancer le serveur : uv run uvicorn src.web.app:app --reload --port 8111
    2. S'assurer qu'il y a des fichiers validés (lancer un workflow si nécessaire)
    3. Visiter http://localhost:8111/transfer
    4. Vérifier : chaque fichier a un bouton icône de renvoi
    5. Cliquer sur le bouton d'un fichier → confirm dialog
    6. Confirmer → la page se recharge, le fichier n'est plus dans la liste
    7. Visiter http://localhost:8111/validation → le fichier renvoyé y apparaît
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/adapters/cli/batch_builder.py (ne pas modifier la logique de construction batch)
- src/services/workflow/ (pipeline workflow intact)
- src/web/templates/transfer/_progress.html (progression SSE intacte)
- Logique de transfert existante (POST /transfer/start)

## SCOPE LIMITS
- Pas de suppression des Movie/Episode créés par build_transfers_batch() — ils ont file_path=None donc n'apparaissent pas dans la bibliothèque
- Pas de sélection multiple (renvoi un par un, simple et suffisant)
- Pas de modification du workflow CLI
- Pas de ré-association TMDB/TVDB inline — le fichier retourne en validation standard

</boundaries>

<verification>
Before declaring plan complete:
- [ ] uv run pytest tests/unit/test_validation.py -v
- [ ] uv run ruff check src/services/validation.py src/web/routes/transfer.py
- [ ] uv run ruff format --check src/services/validation.py src/web/routes/transfer.py
- [ ] Vérification visuelle (checkpoint human-verify)
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Bouton fonctionnel : renvoi effectif d'un fichier en validation
</success_criteria>

<output>
After completion, create `.paul/phases/18-reassociation-transfert/18-01-SUMMARY.md`
</output>
