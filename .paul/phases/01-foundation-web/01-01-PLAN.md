---
phase: 01-foundation-web
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - src/web/__init__.py
  - src/web/app.py
  - src/web/routes/__init__.py
  - src/web/routes/home.py
  - src/web/templates/base.html
  - src/web/templates/home.html
  - src/web/static/css/style.css
  - src/main.py
autonomous: false
---

<objective>
## Goal
Mettre en place l'application FastAPI avec intégration du Container DI existant, un layout Jinja2 de base incluant HTMX, et une page d'accueil fonctionnelle affichant les statistiques de la vidéothèque.

## Purpose
Poser les fondations web sur lesquelles toutes les phases suivantes (validation visuelle, workflow, transfert, bibliothèque) s'appuieront. Sans cette base, aucune interface web n'est possible.

## Output
- Application FastAPI fonctionnelle accessible via `python -m src.main serve`
- Layout Jinja2 responsive avec navigation et HTMX intégré
- Page d'accueil avec statistiques (nombre de films, séries, fichiers en attente)
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Source Files
@src/main.py
@src/container.py
@src/config.py
@src/adapters/__init__.py
@requirements.txt
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Task 2 : création du layout HTML/CSS | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds on Task 2.

## Skill Invocation Checklist
- [ ] /frontend-design loaded (run command or confirm)
</skills>

<acceptance_criteria>

## AC-1: Application FastAPI démarre et répond
```gherkin
Given les dépendances web sont installées
When l'utilisateur lance `python -m src.main serve`
Then le serveur FastAPI démarre sur le port 8000
And GET / retourne HTTP 200 avec la page d'accueil HTML
```

## AC-2: Container DI intégré dans FastAPI
```gherkin
Given l'application FastAPI est démarrée
When une route accède aux services via le container
Then les repositories et services sont instanciés correctement
And la base de données SQLite existante est utilisée
```

## AC-3: Layout de base avec navigation et HTMX
```gherkin
Given l'utilisateur accède à la page d'accueil
When la page est rendue
Then le layout contient une navigation (Accueil, Validation, Bibliothèque)
And HTMX est chargé via CDN
And la page est responsive (mobile-friendly)
```

## AC-4: Page d'accueil avec statistiques
```gherkin
Given la vidéothèque contient des films et séries en base
When l'utilisateur accède à GET /
Then la page affiche le nombre de films, séries et fichiers en attente
And les statistiques sont lues via les repositories existants
```

## AC-5: CLI préservé
```gherkin
Given la nouvelle commande `serve` est ajoutée
When l'utilisateur lance `python -m src.main --help`
Then toutes les commandes CLI existantes sont toujours présentes
And `serve` apparaît comme commande supplémentaire
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Setup FastAPI app + Container DI + dépendances</name>
  <files>requirements.txt, src/web/__init__.py, src/web/app.py, src/web/routes/__init__.py, src/web/routes/home.py, src/main.py</files>
  <action>
    1. Décommenter les dépendances web dans requirements.txt (fastapi, uvicorn, jinja2) et les installer
    2. Créer src/web/__init__.py (vide)
    3. Créer src/web/app.py :
       - Instancier FastAPI avec titre "CineOrg"
       - Lifespan async : initialiser le Container au startup, le fermer au shutdown
       - Stocker le container dans app.state.container
       - Monter les fichiers statiques (src/web/static/)
       - Configurer Jinja2Templates pointant sur src/web/templates/
       - Inclure les routers
    4. Créer src/web/routes/__init__.py (vide)
    5. Créer src/web/routes/home.py :
       - GET / : récupérer le container depuis request.app.state.container
       - Compter films, séries, pending via les repositories
       - Rendre le template home.html avec ces stats
    6. Ajouter la commande `serve` dans src/main.py :
       - Décorateur @app.command()
       - Options : --host (défaut 0.0.0.0), --port (défaut 8000), --reload (flag)
       - Lance uvicorn.run() sur src.web.app:app
    Avoid: Ne pas modifier les commandes CLI existantes. Ne pas créer de dépendance circulaire avec le container.
  </action>
  <verify>
    source .venv/bin/activate && pip install -r requirements.txt
    source .venv/bin/activate && python -m src.main serve --help
    source .venv/bin/activate && python -c "from src.web.app import app; print(app.title)"
  </verify>
  <done>AC-1, AC-2, AC-5 satisfied: FastAPI app démarre, container intégré, CLI préservé</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Application FastAPI avec Container DI, routes de base et commande serve</what-built>
  <how-to-verify>
    1. Run: source .venv/bin/activate && python -m src.main serve
    2. Visit: http://localhost:8000/
    3. Confirm: la page répond (même si le template est minimal à ce stade)
    4. Run: python -m src.main --help → vérifier que toutes les commandes CLI sont présentes + serve
    5. Ctrl+C pour arrêter le serveur
  </how-to-verify>
  <resume-signal>Type "approved" to continue to Task 2, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Layout Jinja2 + HTMX + page d'accueil avec statistiques</name>
  <files>src/web/templates/base.html, src/web/templates/home.html, src/web/static/css/style.css</files>
  <action>
    1. Créer src/web/static/ et src/web/static/css/
    2. Créer src/web/templates/base.html :
       - DOCTYPE HTML5, charset UTF-8, viewport meta
       - Charger HTMX via CDN (unpkg.com/htmx.org)
       - Charger le CSS local (style.css)
       - Navigation : liens Accueil (/), Validation (/validation — placeholder), Bibliothèque (/library — placeholder)
       - Bloc content pour les pages enfants
       - Footer avec "CineOrg" et version
    3. Créer src/web/templates/home.html :
       - Étend base.html
       - Affiche les statistiques : nombre de films, séries, épisodes, fichiers en attente
       - Cartes visuelles pour chaque stat
       - Liens rapides vers les actions principales (Lancer le workflow, Voir les en attente)
    4. Créer src/web/static/css/style.css :
       - Utiliser /frontend-design pour un design soigné
       - Thème sombre adapté à une application média
       - Layout responsive (flexbox/grid)
       - Styles pour la navigation, les cartes stats, les boutons
    Avoid: Ne pas utiliser de framework CSS lourd (Bootstrap, Tailwind). CSS custom pour garder le projet léger. Ne pas ajouter de JavaScript au-delà de HTMX.
  </action>
  <verify>
    source .venv/bin/activate && python -m src.main serve &
    sleep 2
    curl -s http://localhost:8000/ | grep -q "CineOrg" && echo "OK: page contains CineOrg"
    curl -s http://localhost:8000/ | grep -q "htmx" && echo "OK: HTMX loaded"
    kill %1
  </verify>
  <done>AC-3, AC-4 satisfied: Layout responsive avec navigation, HTMX chargé, stats affichées</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/adapters/cli/* (ne pas modifier le CLI existant sauf ajout de `serve`)
- src/services/* (les services restent intacts)
- src/core/* (le domaine ne change pas)
- src/infrastructure/* (la persistence reste identique)
- tests/* (pas de modification des tests existants)

## SCOPE LIMITS
- Pas de routes API REST au-delà de GET / (page d'accueil)
- Pas de fonctionnalité de validation — c'est Phase 2
- Pas de WebSocket ou SSE — c'est Phase 3
- Les liens de navigation (Validation, Bibliothèque) sont des placeholders (404 ou page vide)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `source .venv/bin/activate && python -m src.main serve` démarre sans erreur
- [ ] GET http://localhost:8000/ retourne 200 avec le layout complet
- [ ] La page affiche les statistiques de la vidéothèque
- [ ] HTMX est chargé dans le HTML
- [ ] `python -m src.main --help` montre toutes les commandes CLI + serve
- [ ] `source .venv/bin/activate && pytest` — aucun test existant ne casse
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- FastAPI app fonctionnelle avec Container DI
- Layout responsive et HTMX intégré
- CLI entièrement préservé
</success_criteria>

<output>
After completion, create `.paul/phases/01-foundation-web/01-01-SUMMARY.md`
</output>
