---
phase: 06-enrichissement-films
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/ratings_enricher.py
  - src/adapters/cli/commands/enrichment_commands.py
autonomous: false
---

<objective>
## Goal
Compléter l'enrichissement des données films : combler les 1258 ratings manquants (77% → ~100%), vérifier la couverture globale et corriger les éventuels problèmes rencontrés lors de l'exécution batch.

## Purpose
Les fiches détaillées films dans l'interface web affichent des données incomplètes (ratings manquants pour 22% des films). L'enrichissement complet est nécessaire pour une expérience de navigation satisfaisante et pour la phase 8 (fiches enrichies).

## Output
- 1258 films enrichis avec leurs ratings TMDB
- Couverture vérifiée : ratings ≥ 95%, director ≥ 99%, imdb_id ≥ 99%
- Corrections éventuelles si le service rencontre des erreurs récurrentes
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Source Files
@src/services/ratings_enricher.py
@src/adapters/cli/commands/enrichment_commands.py
@src/infrastructure/persistence/repositories/movie_repository.py
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

No UI/template work in this plan — /frontend-design not required.
</skills>

<acceptance_criteria>

## AC-1: Ratings films enrichis
```gherkin
Given 1258 films sans vote_average en base
When la commande enrich-ratings est exécutée avec un limit suffisant
Then le nombre de films sans rating diminue significativement (≤ 5% du total)
And les films enrichis ont vote_average et vote_count renseignés
```

## AC-2: Progression et rapport
```gherkin
Given la commande enrich-ratings s'exécute sur un grand nombre de films
When l'exécution est en cours
Then une barre de progression affiche l'avancement
And le résumé final montre enrichis/échecs/ignorés
```

## AC-3: Couverture globale vérifiée
```gherkin
Given toutes les commandes d'enrichissement ont été exécutées
When on vérifie les statistiques en base
Then ratings ≥ 95%, director ≥ 99%, imdb_id ≥ 99%, poster ≥ 99%
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Améliorer enrich-ratings pour grands volumes</name>
  <files>src/services/ratings_enricher.py, src/adapters/cli/commands/enrichment_commands.py</files>
  <action>
    Le service RatingsEnricherService fonctionne mais manque de progression visible pour les grands volumes (1258 films × 0.25s = ~5 minutes).

    **Ajouter un callback de progression** au service (comme MoviesEnricherService) :
    - Ajouter un paramètre `on_progress` callback au service
    - Créer un dataclass ProgressInfo avec current, total, movie_title, movie_year, result
    - Dans la commande CLI, afficher une barre Rich Progress avec le titre du film en cours

    **Augmenter le limit par défaut** de 100 à 2000 pour `enrich-ratings` (les ratings sont légers, pas besoin de batch petit).

    **Pattern de référence** : la commande `enrich-movies-credits` dans le même fichier implémente déjà ce pattern exactement.
  </action>
  <verify>
    - `source .venv/bin/activate && python -m src.main enrich-ratings --help` affiche l'aide
    - `source .venv/bin/activate && python -m src.main enrich-ratings --limit 5` enrichit 5 films avec progression
  </verify>
  <done>AC-2 satisfied : progression visible pendant l'enrichissement</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>
    Exécuter l'enrichissement complet des ratings :
    ```bash
    source .venv/bin/activate && python -m src.main enrich-ratings --limit 2000
    ```
    Durée estimée : ~5 minutes (1258 films × 0.25s rate limit).
    Confirmer quand l'exécution est terminée.
  </action>
  <resume-signal>Type "done" when enrichment is complete, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Vérifier la couverture et documenter</name>
  <files>aucun fichier modifié — vérification uniquement</files>
  <action>
    Exécuter des requêtes SQL pour vérifier la couverture post-enrichissement :
    - Nombre de films avec/sans vote_average
    - Nombre de films avec/sans director
    - Nombre de films avec/sans imdb_id
    - Nombre de films avec/sans poster_path

    Si la couverture ratings est < 95%, analyser les échecs :
    - Films sans tmdb_id (impossibles à enrichir)
    - Erreurs API récurrentes
    - Proposer des corrections si nécessaire
  </action>
  <verify>
    - Requête SQL confirmant les pourcentages de couverture
    - Couverture ratings ≥ 95%
  </verify>
  <done>AC-1, AC-3 satisfied : couverture vérifiée et documentée</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/core/ (entités domaine)
- src/infrastructure/persistence/models.py (schéma DB stable)
- src/web/ (interface web — phase 8)
- src/services/movies_enricher.py (service crédits déjà fonctionnel)
- src/services/imdb_id_enricher.py (service IMDB ID déjà fonctionnel)

## SCOPE LIMITS
- Enrichissement films uniquement (séries = phase 7)
- Pas de modification du schéma DB
- Pas de modification de l'interface web (phase 8)
- Pas de nouvelle commande CLI (les commandes existantes suffisent)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `enrich-ratings` affiche une barre de progression
- [ ] Couverture ratings ≥ 95%
- [ ] Couverture director ≥ 99%
- [ ] Couverture imdb_id ≥ 99%
- [ ] Pas d'erreurs ruff
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Couverture enrichissement films documentée
</success_criteria>

<output>
After completion, create `.paul/phases/06-enrichissement-films/06-01-SUMMARY.md`
</output>
