---
phase: 02-validation-visuelle
plan: 01
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - src/web/app.py
  - src/web/routes/validation.py
  - src/web/templates/validation/list.html
  - src/web/templates/validation/detail.html
  - src/web/templates/validation/_candidate_card.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Créer les routes et templates de validation visuelle : liste des fichiers en attente et page de détail affichant les candidats enrichis (jaquette, synopsis, score, acteurs, durée).

## Purpose
Reproduire et dépasser le flux de validation CLI en version web, avec un avantage clé : l'affichage visuel des jaquettes TMDB/TVDB pour lever les ambiguïtés de titres. C'est la raison d'être du milestone v1.0.

## Output
- Page /validation listant les fichiers pending avec aperçu (titre, type, nombre de candidats, meilleur score)
- Page /validation/{id} affichant les candidats enrichis avec jaquette, synopsis, acteurs, score coloré, comparaison de durée
- Templates HTMX-ready pour les interactions du plan 02-02
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/01-foundation-web/01-01-SUMMARY.md
  - Patterns: lifespan-di, deps-module, routes/{domain}.py, templates héritage base.html
  - CSS: thème sombre cinéma avec variables (--accent-amber, --bg-card, etc.)

## Source Files
@src/web/app.py
@src/web/deps.py
@src/web/routes/home.py
@src/web/static/css/style.css
@src/services/validation.py
@src/services/matcher.py
@src/adapters/api/tmdb_client.py
@src/adapters/api/tvdb_client.py
@src/core/entities/video.py
@src/infrastructure/persistence/models.py
@src/utils/helpers.py
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Création des templates validation (detail + cards) | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds on Task 2.

## Skill Invocation Checklist
- [ ] /frontend-design loaded (run command or confirm)
</skills>

<acceptance_criteria>

## AC-1: Liste des fichiers en attente
```gherkin
Given des fichiers ont le statut "pending" en base de données
When l'utilisateur accède à GET /validation
Then la page affiche la liste des fichiers en attente
And chaque entrée montre : nom de fichier, type (film/série), nombre de candidats, meilleur score
And la liste est triée par date de création (plus récent en premier)
```

## AC-2: Page vide quand aucun pending
```gherkin
Given aucun fichier n'a le statut "pending"
When l'utilisateur accède à GET /validation
Then la page affiche un message "Aucun fichier en attente de validation"
And propose un lien vers l'accueil
```

## AC-3: Détail avec candidats enrichis
```gherkin
Given un fichier pending a des candidats
When l'utilisateur accède à GET /validation/{id}
Then la page affiche les infos du fichier (nom, taille, durée si disponible)
And chaque candidat affiche : jaquette TMDB/TVDB, titre, année, score coloré, synopsis, acteurs
And le score est coloré (vert >= 85, jaune >= 60, rouge < 60)
And la durée fichier vs durée API est comparée avec code couleur
```

## AC-4: Candidat non trouvé
```gherkin
Given un ID de pending inexistant
When l'utilisateur accède à GET /validation/{id}
Then la page retourne 404 avec un message explicite
```

## AC-5: Navigation cohérente
```gherkin
Given l'utilisateur est sur la page de validation
When il regarde la navigation
Then le lien "Validation" est marqué actif dans la navbar
And un lien retour vers la liste est présent sur la page détail
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Routes validation + templates liste et détail</name>
  <files>src/web/routes/validation.py, src/web/app.py, src/web/templates/validation/list.html, src/web/templates/validation/detail.html, src/web/templates/validation/_candidate_card.html</files>
  <action>
    1. Créer src/web/routes/validation.py :
       - GET /validation : liste des pending
         - Récupérer le container depuis request.app.state.container
         - Appeler container.validation_service().list_pending()
         - Pour chaque pending, extraire : filename (depuis video_file), type (détecter film/série via source des candidats ou pattern SxxExx dans le filename), nombre de candidats, meilleur score parmi les candidats
         - Trier par created_at décroissant
         - Rendre validation/list.html
       - GET /validation/{pending_id} : détail avec candidats enrichis
         - Récupérer le pending par ID via container.validation_service().get_pending_by_id()
         - Si introuvable : retourner 404
         - Déterminer si série (source="tvdb" ou pattern SxxExx)
         - Pour chaque candidat (limité aux 10 premiers) : appeler get_details() via le client TMDB ou TVDB approprié pour obtenir MediaDetails (jaquette, synopsis, acteurs, durée)
         - Rendre validation/detail.html avec les candidats enrichis

    2. Modifier src/web/app.py :
       - Importer et inclure le router validation

    3. Créer src/web/templates/validation/list.html :
       - Étend base.html, bloc nav_validation active
       - Titre "Validation"
       - Si pas de pending : message "Aucun fichier en attente" avec lien accueil
       - Sinon : grille/liste de cartes, chaque carte cliquable vers /validation/{id}
       - Chaque carte : nom de fichier (tronqué si long), badge film/série, nombre de candidats, score du meilleur candidat (couleur)

    4. Créer src/web/templates/validation/detail.html :
       - Étend base.html, bloc nav_validation active
       - En-tête : nom du fichier, taille formatée, durée fichier si disponible
       - Lien retour vers /validation
       - Grille de candidats (1 ou 2 colonnes)
       - Chaque candidat via include _candidate_card.html
       - Zone d'actions (placeholder pour plan 02-02) : boutons Valider, Rejeter, Rechercher (désactivés ou marqués "Bientôt")

    5. Créer src/web/templates/validation/_candidate_card.html :
       - Jaquette (img avec poster_url, fallback si None)
       - Titre + année
       - Score avec badge coloré (vert/jaune/rouge)
       - Source badge (TMDB/TVDB)
       - Synopsis (tronqué 200 chars)
       - Réalisateur (si disponible, films)
       - Acteurs (4 premiers, si disponible)
       - Comparaison durée fichier vs API (vert si ±10%, jaune ±25%, rouge sinon)
       - Attributs data-candidate-id et data-source pour le plan 02-02

    Avoid: Ne pas implémenter les actions validate/reject/search — c'est le plan 02-02. Ne pas modifier les services existants. Ne pas ajouter de dépendances.
  </action>
  <verify>
    source .venv/bin/activate && python -c "from src.web.routes.validation import router; print(f'Routes: {len(router.routes)}')"
    source .venv/bin/activate && python -c "from src.web.app import app; print([r.path for r in app.routes])"
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4, AC-5 satisfied: routes fonctionnelles, templates rendus, navigation cohérente</done>
</task>

<task type="auto">
  <name>Task 2: Styles CSS pour les pages de validation</name>
  <files>src/web/static/css/style.css</files>
  <action>
    Utiliser /frontend-design pour concevoir les styles :

    1. Style de la liste de validation :
       - Cartes cliquables avec hover (élévation)
       - Badge film/série (couleur différente)
       - Score en badge arrondi (vert >= 85, jaune >= 60, rouge < 60)
       - Layout responsive (1 colonne mobile, 2-3 colonnes desktop)

    2. Style de la page détail :
       - En-tête fichier avec métadonnées
       - Grille de candidats (cartes avec jaquette à gauche, infos à droite)
       - Jaquette : aspect ratio 2:3, placeholder si manquante (couleur unie avec icône)
       - Score badge large et lisible
       - Synopsis en gris atténué
       - Acteurs et réalisateur en sous-texte
       - Comparaison durée : indicateur visuel (barre ou pastille colorée)
       - Boutons d'action en bas de chaque carte (préparés pour 02-02)

    3. Cohérence avec le thème existant :
       - Utiliser les variables CSS existantes (--bg-card, --accent-amber, etc.)
       - Mêmes transitions et animations que la page d'accueil
       - Responsive identique (breakpoints 768px, 480px)

    Avoid: Ne pas modifier les styles existants de la page d'accueil. Ajouter les nouveaux styles après les sections existantes.
  </action>
  <verify>
    source .venv/bin/activate && python -c "
    from src.web.app import app
    from fastapi.testclient import TestClient
    client = TestClient(app)
    r = client.get('/validation')
    assert r.status_code == 200
    assert 'validation' in r.text.lower()
    print('OK: validation page renders')
    "
  </verify>
  <done>AC-3 CSS satisfied: candidats affichés avec design soigné, scores colorés, jaquettes, responsive</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pages de validation : liste des pending et détail avec candidats enrichis (jaquettes, scores, synopsis)</what-built>
  <how-to-verify>
    1. Run: uv run python -m src.main serve
    2. Visit: http://localhost:8000/validation
    3. Si des fichiers pending existent : vérifier la liste avec badges et scores
    4. Cliquer sur un fichier pour voir le détail
    5. Vérifier : jaquettes visibles, scores colorés, synopsis, acteurs
    6. Tester la navigation : lien retour, navbar active
    7. Redimensionner : vérifier responsive
    8. Tester /validation/99999 → 404
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/services/* (les services restent intacts — pas de modification)
- src/core/* (le domaine ne change pas)
- src/infrastructure/* (la persistence reste identique)
- src/adapters/api/* (les clients API ne changent pas)
- src/adapters/cli/* (le CLI ne change pas)
- tests/* (pas de modification des tests existants)
- src/web/routes/home.py (page d'accueil stable)
- src/web/templates/home.html (template accueil stable)

## SCOPE LIMITS
- Lecture seule : ce plan AFFICHE les candidats mais ne les valide/rejette PAS
- Pas d'actions POST (valider, rejeter, rechercher) — c'est le plan 02-02
- Pas de pagination côté serveur — la liste pending est rarement > 100 items
- Pas de WebSocket ni SSE — simple rendu de page
- Les boutons d'action sont des placeholders visuels (désactivés)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] GET /validation retourne 200 avec la liste des pending
- [ ] GET /validation/{id} retourne 200 avec les candidats enrichis
- [ ] GET /validation/99999 retourne 404
- [ ] Les jaquettes s'affichent (img src vers TMDB/TVDB)
- [ ] Les scores sont colorés (vert/jaune/rouge)
- [ ] La navigation marque "Validation" comme active
- [ ] Le layout est responsive
- [ ] `uv run --extra dev pytest` — aucun test existant ne casse
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Candidats affichés avec jaquettes, scores et métadonnées enrichies
- Design cohérent avec le thème Phase 1
- CLI entièrement préservé
</success_criteria>

<output>
After completion, create `.paul/phases/02-validation-visuelle/02-01-SUMMARY.md`
</output>
