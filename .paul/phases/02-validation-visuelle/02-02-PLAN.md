---
phase: 02-validation-visuelle
plan: 02
type: execute
wave: 1
depends_on: ["02-01"]
files_modified:
  - src/web/routes/validation.py
  - src/web/templates/validation/detail.html
  - src/web/templates/validation/_candidate_card.html
  - src/web/templates/validation/_search_results.html
  - src/web/templates/validation/_search_form.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Ajouter les interactions HTMX sur la page de détail validation : valider un candidat, rejeter un fichier, recherche manuelle par titre, et recherche par ID externe.

## Purpose
Compléter le flux de validation visuelle en permettant à l'utilisateur d'agir sur les candidats affichés. C'est la deuxième moitié de la Phase 2 : le plan 02-01 affiche, ce plan 02-02 agit.

## Output
- Boutons Valider sur chaque candidate card (HTMX POST)
- Bouton Rejeter sur la page détail (HTMX POST)
- Formulaire de recherche manuelle par titre (HTMX GET, résultats inline)
- Formulaire de recherche par ID externe TMDB/TVDB/IMDB (HTMX GET)
- Feedback visuel après chaque action (message de succès/erreur)
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/02-validation-visuelle/02-01-SUMMARY.md
  - Patterns: candidate card avec data-candidate-id et data-source
  - Routes GET existantes: /validation/ et /validation/{id}
  - CSS: thème sombre avec score-badge, source-badge, candidate-card

## Source Files
@src/web/routes/validation.py
@src/web/templates/validation/detail.html
@src/web/templates/validation/_candidate_card.html
@src/services/validation.py
  - validate_candidate(pending, candidate) → MediaDetails
  - reject_pending(pending) → PendingValidation
  - search_manual(query, is_series, year) → list[SearchResult]
  - search_by_external_id(id_type, id_value) → Optional[MediaDetails]
  - get_pending_by_id(pending_id) → Optional[PendingValidation]
@src/services/matcher.py
  - score_results(results, query_title, ...) → list[SearchResult]
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Styles des boutons d'action, formulaire recherche, feedback | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds on Task 2.

## Skill Invocation Checklist
- [ ] /frontend-design loaded (run command or confirm)
</skills>

<acceptance_criteria>

## AC-1: Valider un candidat
```gherkin
Given l'utilisateur est sur la page détail d'un fichier pending
And plusieurs candidats sont affichés
When il clique sur le bouton "Valider" d'un candidat
Then une requête HTMX POST est envoyée avec candidate_id et source
And le fichier passe en statut "validated" en base
And la page affiche un message de succès avec le titre validé
And l'utilisateur est redirigé vers la liste (ou la page se met à jour)
```

## AC-2: Rejeter un fichier
```gherkin
Given l'utilisateur est sur la page détail d'un fichier pending
When il clique sur le bouton "Rejeter"
Then une requête HTMX POST est envoyée
And le fichier passe en statut "rejected" en base
And un message de confirmation s'affiche
And l'utilisateur est redirigé vers la liste
```

## AC-3: Recherche manuelle par titre
```gherkin
Given l'utilisateur est sur la page détail d'un fichier pending
When il saisit un titre dans le formulaire de recherche et soumet
Then une requête HTMX GET est envoyée avec le query
And les résultats s'affichent inline sous forme de candidate cards
And chaque résultat a un bouton "Valider" fonctionnel
And si aucun résultat : message "Aucun résultat"
```

## AC-4: Recherche par ID externe
```gherkin
Given l'utilisateur est sur la page détail d'un fichier pending
When il saisit un ID TMDB, TVDB ou IMDB dans le formulaire dédié
Then une requête HTMX GET est envoyée
And si trouvé : le résultat s'affiche comme candidate card avec bouton Valider
And si non trouvé : message "ID introuvable"
```

## AC-5: Feedback visuel
```gherkin
Given une action est déclenchée (valider, rejeter, recherche)
When l'action est en cours
Then un indicateur de chargement est visible (htmx-indicator)
And après l'action : un message de feedback s'affiche (succès ou erreur)
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Routes POST/GET pour les actions HTMX</name>
  <files>src/web/routes/validation.py, src/web/templates/validation/_search_results.html, src/web/templates/validation/_search_form.html</files>
  <action>
    Ajouter les routes suivantes dans src/web/routes/validation.py :

    1. POST /validation/{pending_id}/validate
       - Récupérer candidate_id et source depuis le form data (request.form())
       - Récupérer le pending via get_pending_by_id()
       - Trouver le SearchResult correspondant dans les candidats du pending (parse candidates_json, filtrer par id et source)
       - Appeler validation_service.validate_candidate(pending, candidate)
       - Retourner un fragment HTML de succès (pas de page complète) avec HX-Trigger header pour notification
       - Si erreur : retourner un fragment HTML d'erreur

    2. POST /validation/{pending_id}/reject
       - Récupérer le pending via get_pending_by_id()
       - Appeler validation_service.reject_pending(pending)
       - Retourner un fragment HTML avec HX-Redirect vers /validation ou message de succès

    3. GET /validation/{pending_id}/search?q={query}&year={year}
       - Récupérer query (obligatoire) et year (optionnel) depuis query params
       - Déterminer is_series via le pending (même logique que detail)
       - Appeler validation_service.search_manual(query, is_series, year)
       - Scorer les résultats via matcher_service.score_results() si le pending a des infos de durée
       - Enrichir les résultats top-10 avec get_details() (même pattern que validation_detail)
       - Retourner le template partiel _search_results.html avec les candidats enrichis
       - Le pending_id est passé au template pour que les boutons Valider pointent vers le bon endpoint

    4. GET /validation/{pending_id}/search-id?type={tmdb|tvdb|imdb}&id={value}
       - Appeler validation_service.search_by_external_id(id_type, id_value)
       - Si trouvé : retourner _search_results.html avec un seul résultat enrichi
       - Si non trouvé : retourner un fragment HTML "ID introuvable"

    5. Créer src/web/templates/validation/_search_results.html :
       - Réutiliser _candidate_card.html pour chaque résultat (avec include)
       - Chaque card inclut le bouton Valider (car le pending_id est connu)
       - Si aucun résultat : message "Aucun résultat pour cette recherche"
       - Ce template est un fragment (pas de extends base.html)

    6. Créer src/web/templates/validation/_search_form.html :
       - Formulaire recherche par titre : input text + année optionnelle + bouton
       - hx-get="/validation/{pending_id}/search" hx-target="#search-results" hx-indicator
       - Formulaire recherche par ID : select type (TMDB/TVDB/IMDB) + input ID + bouton
       - hx-get="/validation/{pending_id}/search-id" hx-target="#search-results" hx-indicator
       - Ce template est un fragment inclus dans detail.html

    Avoid: Ne pas modifier les services existants. Ne pas modifier les routes GET existantes (list/detail). Utiliser les services tels quels. Ne pas ajouter de dépendances.
  </action>
  <verify>
    source .venv/bin/activate && python -c "
    from src.web.routes.validation import router
    routes = [(r.methods, r.path) for r in router.routes if hasattr(r, 'methods')]
    print(f'Routes: {len(routes)}')
    for m, p in routes: print(f'  {m} {p}')
    assert len(routes) >= 6, 'Expected at least 6 routes'
    print('OK')
    "
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4 satisfied: routes POST valider/rejeter et GET recherche fonctionnelles, templates partiels créés</done>
</task>

<task type="auto">
  <name>Task 2: Templates HTMX et styles des interactions</name>
  <files>src/web/templates/validation/detail.html, src/web/templates/validation/_candidate_card.html, src/web/static/css/style.css</files>
  <action>
    Utiliser /frontend-design pour le design des interactions.

    1. Modifier _candidate_card.html :
       - Ajouter un bouton "Valider" dans chaque carte candidat
       - Le bouton utilise hx-post="/validation/{{ pending_id }}/validate"
       - Inclure les champs hidden : candidate_id (data-candidate-id) et source (data-source)
       - hx-target="#action-feedback" (zone de feedback en haut de page)
       - hx-indicator=".htmx-indicator" pour le spinner
       - Le bouton doit être visuellement intégré au design existant (accent vert/ambre)
       - Note : le pending_id doit être passé au template (modifier l'include dans detail.html)

    2. Modifier detail.html :
       - Ajouter une zone #action-feedback en haut (pour les messages HTMX)
       - Ajouter un bouton "Rejeter ce fichier" dans le header
         - hx-post="/validation/{{ pending.id }}/reject"
         - hx-confirm="Rejeter ce fichier ? Cette action est irréversible."
         - Style : bouton rouge discret
       - Ajouter la zone de recherche :
         - Include _search_form.html (formulaires titre et ID)
         - Zone #search-results pour les résultats inline
       - Ajouter un indicateur de chargement HTMX (.htmx-indicator)

    3. Ajouter les styles CSS :
       - .action-btn-validate : bouton vert/ambre dans chaque card
       - .action-btn-reject : bouton rouge discret dans le header
       - .search-section : conteneur des formulaires de recherche
       - .search-form : formulaire inline avec input + bouton
       - .search-results : zone d'affichage des résultats
       - .action-feedback : zone de notification (succès vert, erreur rouge)
       - .htmx-indicator : spinner/loading animation
       - Animations d'apparition pour les résultats de recherche
       - Responsive cohérent avec le thème existant

    Avoid: Ne pas modifier les styles existants de la page d'accueil ou de la liste. Ajouter les nouveaux styles en fin de fichier. Ne pas modifier les routes — uniquement les templates et CSS.
  </action>
  <verify>
    source .venv/bin/activate && python -c "
    from src.web.app import app
    from fastapi.testclient import TestClient
    with TestClient(app) as client:
        r = client.get('/validation')
        assert r.status_code == 200
        print('OK: list page renders')
    "
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4, AC-5 CSS satisfied: boutons d'action, formulaires recherche, feedback visuel, indicateurs chargement</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactions HTMX complètes : valider un candidat, rejeter un fichier, recherche manuelle par titre, recherche par ID externe, feedback visuel</what-built>
  <how-to-verify>
    1. Run: uv run python -m src.main serve
    2. Visit: http://localhost:8000/validation
    3. Cliquer sur un fichier pending pour accéder au détail
    4. Tester "Valider" sur un candidat → message de succès, fichier disparaît de la liste
    5. Sur un autre fichier : tester "Rejeter" → confirmation, fichier disparaît
    6. Sur un autre fichier : utiliser la recherche par titre → résultats inline
    7. Valider un résultat de recherche → succès
    8. Tester la recherche par ID (ex: TMDB ID 19995 pour Avatar)
    9. Vérifier les indicateurs de chargement pendant les requêtes
    10. Vérifier le responsive (mobile)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/services/* (les services restent intacts)
- src/core/* (le domaine ne change pas)
- src/infrastructure/* (la persistence reste identique)
- src/adapters/api/* (les clients API ne changent pas)
- src/adapters/cli/* (le CLI ne change pas)
- tests/* (pas de modification des tests existants)
- src/web/routes/home.py (page d'accueil stable)
- src/web/templates/home.html (template accueil stable)
- src/web/templates/base.html (layout stable)
- src/web/templates/validation/list.html (liste stable — modifiée en 02-01)
- src/web/templates/validation/not_found.html (404 stable)

## SCOPE LIMITS
- Pas de pagination côté serveur pour la recherche (top-10 suffisant)
- Pas de WebSocket ni SSE
- Pas de gestion du transfert post-validation (c'est Phase 4)
- Le skip est implicite (naviguer ailleurs = laisser en pending)
- Les résultats de recherche réutilisent le même _candidate_card.html

</boundaries>

<verification>
Before declaring plan complete:
- [ ] POST /validation/{id}/validate retourne un fragment de succès et met à jour la DB
- [ ] POST /validation/{id}/reject retourne un fragment de succès et met à jour la DB
- [ ] GET /validation/{id}/search?q=... retourne des candidats enrichis
- [ ] GET /validation/{id}/search-id?type=tmdb&id=... retourne un résultat ou "introuvable"
- [ ] Les boutons HTMX fonctionnent sans rechargement complet de page
- [ ] Les indicateurs de chargement sont visibles
- [ ] Le feedback (succès/erreur) s'affiche correctement
- [ ] `uv run --extra dev pytest` — aucun test existant ne casse
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Actions valider/rejeter fonctionnelles via HTMX
- Recherche manuelle et par ID fonctionnelles
- Design cohérent avec le thème Phase 1/Plan 02-01
- CLI entièrement préservé
</success_criteria>

<output>
After completion, create `.paul/phases/02-validation-visuelle/02-02-SUMMARY.md`
</output>
