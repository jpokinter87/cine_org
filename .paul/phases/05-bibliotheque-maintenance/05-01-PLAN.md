---
phase: 05-bibliotheque-maintenance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/library.py
  - src/web/templates/library/index.html
  - src/web/templates/library/movie_detail.html
  - src/web/templates/library/series_detail.html
  - src/web/templates/library/_movie_card.html
  - src/web/templates/library/_series_card.html
  - src/web/templates/library/_filters.html
  - src/web/app.py
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Creer la page de navigation de la bibliotheque (films et series) avec filtres, pagination, et pages de detail pour chaque film/serie.

## Purpose
La page d'accueil affiche 940 series et 17341 episodes mais il n'existe aucun moyen de les parcourir. Le lien "Bibliotheque" dans la navbar pointe vers `/library` qui n'existe pas encore. Cette page est le coeur de l'interface de consultation.

## Output
- Route `/library` avec liste films/series, filtres (type, genre, annee, recherche texte), tri et pagination
- Route `/library/movies/{id}` detail d'un film (metadonnees, jaquette, fichier associe)
- Route `/library/series/{id}` detail d'une serie (metadonnees, liste des saisons/episodes)
- Templates Jinja2 avec design coherent (theme sombre existant)
- CSS pour les nouvelles pages
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/04-transfert-conflits/04-01-SUMMARY.md
- Pattern SSE et templates HTMX etablis
- Navbar avec lien /library deja present dans base.html

## Source Files
@src/web/app.py
@src/web/deps.py
@src/web/routes/home.py
@src/web/templates/base.html
@src/web/templates/home.html
@src/web/static/css/style.css
@src/core/entities/media.py
@src/infrastructure/persistence/models.py
@src/infrastructure/persistence/repositories/series_repository.py
@src/infrastructure/persistence/repositories/episode_repository.py
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant creation des templates HTML et CSS | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Page bibliotheque avec liste et filtres
```gherkin
Given la base contient des films et des series
When l'utilisateur visite /library
Then une grille de cartes affiche films et series melangees, triees par titre
And un panneau de filtres permet de filtrer par type (film/serie), genre, annee, recherche texte
And la pagination affiche 24 elements par page avec navigation
```

## AC-2: Filtrage HTMX sans rechargement
```gherkin
Given l'utilisateur est sur /library
When il selectionne un filtre (type, genre, annee) ou saisit du texte dans la recherche
Then la grille se met a jour via HTMX (swap partiel) sans rechargement complet
And les filtres actifs sont affiches sous forme de tags cliquables pour les retirer
```

## AC-3: Detail d'un film
```gherkin
Given un film existe en base avec tmdb_id et metadonnees
When l'utilisateur clique sur la carte du film
Then la page /library/movies/{id} affiche : titre, annee, genres, jaquette (poster TMDB), synopsis, notes (TMDB + IMDb si disponibles), duree, fichier associe (file_path)
```

## AC-4: Detail d'une serie avec episodes
```gherkin
Given une serie existe en base avec des episodes
When l'utilisateur visite /library/series/{id}
Then la page affiche : titre, annee, nombre de saisons/episodes
And les saisons sont listees avec leurs episodes (numero, titre si connu)
And les episodes sont repliables par saison (toggle HTMX ou CSS)
```

## AC-5: Navigation active dans la navbar
```gherkin
Given l'utilisateur est sur /library ou une page de detail
When la page s'affiche
Then le lien "Bibliotheque" dans la navbar a la classe active
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Route library et templates liste/filtres/detail</name>
  <files>src/web/routes/library.py, src/web/app.py, src/web/templates/library/index.html, src/web/templates/library/_movie_card.html, src/web/templates/library/_series_card.html, src/web/templates/library/_filters.html, src/web/templates/library/movie_detail.html, src/web/templates/library/series_detail.html</files>
  <action>
    Creer le module de routes library avec :

    **GET /library** — Page principale
    - Query params : type (all/movie/series), genre, year, q (recherche texte), sort (title/year/rating), page
    - Requete SQL unifiee : joindre MovieModel et SeriesModel en deux queries separees, fusionner les resultats en une liste de dicts normalises {id, type, title, year, genres, poster_path, vote_average, imdb_rating}
    - Pagination : 24 items par page, calcul offset/limit
    - Extraire la liste des genres distincts et des annees pour les filtres
    - Si header HX-Request present : retourner uniquement le fragment _filters.html + grille de cartes (pas le layout complet)
    - Template index.html : panneau filtres a gauche (sidebar ou top bar), grille responsive de cartes a droite

    **GET /library/movies/{movie_id}** — Detail film
    - Charger MovieModel par ID
    - Construire l'URL poster TMDB : https://image.tmdb.org/t/p/w500{poster_path}
    - Template movie_detail.html : jaquette, titre, annee, genres, synopsis, notes TMDB/IMDb, duree formatee, fichier associe (file_path tronque)

    **GET /library/series/{series_id}** — Detail serie
    - Charger SeriesModel par ID
    - Charger tous les EpisodeModel pour cette serie, groupes par saison
    - Template series_detail.html : titre, annee, nb saisons/episodes, liste saisons repliables avec episodes

    **Integration :**
    - Enregistrer library_router dans app.py (include_router)
    - Les cartes film/serie utilisent des templates partiels _movie_card.html / _series_card.html
    - Filtres dans _filters.html avec hx-get="/library" hx-target="#library-grid" hx-push-url="true"
    - Recherche texte avec hx-trigger="keyup changed delay:300ms"

    **Pattern existant a suivre :**
    - Meme structure que home.py : session = next(get_session()), try/finally
    - Import templates depuis deps.py
    - APIRouter() avec prefix dans app.py

    **Eviter :**
    - Ne pas appeler les APIs TMDB/TVDB depuis ces pages (tout est deja en base)
    - Ne pas creer de service layer supplementaire (queries directes sur les models suffisent)
  </action>
  <verify>
    - uvicorn src.web.app:app --reload
    - Visiter /library : la page affiche une grille de cartes films/series
    - Filtrer par type "series" : seules les series s'affichent
    - Rechercher "breaking" : resultats filtres
    - Cliquer sur une serie : page detail avec episodes groupes par saison
    - Cliquer sur un film : page detail avec jaquette et metadonnees
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4, AC-5 satisfied</done>
</task>

<task type="auto">
  <name>Task 2: CSS pour les pages bibliotheque</name>
  <files>src/web/static/css/style.css</files>
  <action>
    Ajouter les styles CSS pour les nouvelles pages :

    **Grille bibliotheque :**
    - .library-grid : CSS Grid responsive (auto-fill, minmax ~220px)
    - .library-card : carte cliquable avec poster/placeholder, titre, annee, badge type, note
    - .library-card:hover : elevation/glow subtil

    **Filtres :**
    - .filters-bar : barre horizontale ou sidebar avec selects et input recherche
    - .filter-tag : badge cliquable pour retirer un filtre actif
    - .filter-select : select stylise coherent avec le theme sombre

    **Detail film/serie :**
    - .detail-header : layout flex (poster + infos principales)
    - .detail-poster : image avec border-radius et ombre
    - .detail-meta : badges genres, annee, notes
    - .rating-badge : badge note avec couleur selon la valeur (vert >7, jaune >5, rouge <=5)
    - .season-accordion : saisons repliables (details/summary natif HTML ou toggle CSS)
    - .episode-list : table ou liste compacte des episodes

    **Pagination :**
    - .pagination : centree, boutons prev/next + numeros de pages

    Respecter le design system existant : variables CSS (--bg-card, --accent-amber, etc.), polices DM Sans / Instrument Serif, theme sombre.
  </action>
  <verify>
    - Les pages sont visuellement coherentes avec le reste de l'application
    - La grille est responsive (1-4 colonnes selon la largeur)
    - Les cartes ont un aspect ratio correct pour les posters
  </verify>
  <done>AC-1, AC-3, AC-4 satisfied visuellement</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pages bibliotheque : liste avec filtres HTMX, detail film avec jaquette, detail serie avec episodes par saison</what-built>
  <how-to-verify>
    1. Lancer : uvicorn src.web.app:app --reload
    2. Visiter : http://localhost:8000/library
    3. Verifier : grille de cartes films/series, filtres fonctionnels, pagination
    4. Tester : filtrer par type "Serie", rechercher un titre, changer de page
    5. Cliquer sur un film : verifier jaquette, synopsis, notes, duree
    6. Cliquer sur une serie : verifier liste des saisons/episodes, toggle saisons
    7. Verifier : le lien "Bibliotheque" est actif dans la navbar
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/web/routes/home.py (page d'accueil stable)
- src/web/routes/validation.py (validation stable)
- src/web/routes/workflow.py (workflow stable)
- src/web/routes/transfer.py (transfert stable)
- src/core/ (entites domaine)
- src/infrastructure/persistence/ (repositories et models)
- Templates existants (home.html, validation/, workflow/, transfer/)

## SCOPE LIMITS
- Pas d'appels API externes (TMDB/TVDB) — tout depuis la base
- Pas d'outils de maintenance dans ce plan (repair, cleanup, check → plan 05-02)
- Pas de modification/suppression de films/series depuis l'interface (lecture seule)
- Pas de streaming video

</boundaries>

<verification>
Before declaring plan complete:
- [ ] /library affiche films et series avec filtres et pagination
- [ ] /library/movies/{id} affiche le detail d'un film
- [ ] /library/series/{id} affiche le detail d'une serie avec episodes
- [ ] Les filtres fonctionnent via HTMX sans rechargement complet
- [ ] La navbar marque "Bibliotheque" comme active
- [ ] Le serveur demarre sans erreur
- [ ] Tests existants toujours verts (pytest)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Pages visuellement coherentes avec le theme sombre existant
- Navigation fluide entre liste et details
</success_criteria>

<output>
After completion, create `.paul/phases/05-bibliotheque-maintenance/05-01-SUMMARY.md`
</output>
