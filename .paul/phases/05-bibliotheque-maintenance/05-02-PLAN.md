---
phase: 05-bibliotheque-maintenance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/config.py
  - src/web/templates/config/index.html
  - src/web/templates/base.html
  - src/web/app.py
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Créer une page de configuration web permettant de visualiser et modifier les paramètres de l'application (répertoires, clés API, seuils de traitement, logging).

## Purpose
Actuellement, la configuration n'est modifiable qu'en éditant manuellement le fichier `.env`. Une page web permet de voir et modifier les paramètres sans accès terminal, et de valider visuellement que les chemins existent et les clés API sont renseignées.

## Output
- Route `/config` avec formulaire de configuration
- Template affichant les paramètres actuels groupés par catégorie
- Sauvegarde vers le fichier `.env` avec validation
- Indicateurs visuels (chemins existants, clés renseignées)
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/05-bibliotheque-maintenance/05-01-SUMMARY.md

## Source Files
@src/config.py
@src/web/app.py
@src/web/templates/base.html
@src/web/static/css/style.css
@.env
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant création du template config | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Affichage de la configuration actuelle
```gherkin
Given l'application est démarrée avec un fichier .env
When l'utilisateur visite /config
Then la page affiche tous les paramètres groupés en sections (Répertoires, Base de données, API, Traitement, Logging)
And chaque champ affiche sa valeur actuelle
And les chemins de répertoires affichent un indicateur vert/rouge selon leur existence sur le filesystem
And les clés API sont masquées (affichent "••••" + 4 derniers caractères si renseignées, "Non configurée" sinon)
```

## AC-2: Modification et sauvegarde
```gherkin
Given l'utilisateur est sur /config
When il modifie un ou plusieurs paramètres et clique "Enregistrer"
Then les modifications sont écrites dans le fichier .env
And la page recharge avec les nouvelles valeurs
And un message de succès s'affiche
```

## AC-3: Validation des entrées
```gherkin
Given l'utilisateur modifie un paramètre
When la valeur est invalide (seuil négatif, chemin vide)
Then un message d'erreur s'affiche pour le champ concerné
And la sauvegarde n'est pas effectuée
```

## AC-4: Navigation active
```gherkin
Given l'utilisateur est sur /config
When la page s'affiche
Then un lien "Configuration" est visible dans la navbar avec la classe active
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Route config et template formulaire</name>
  <files>src/web/routes/config.py, src/web/templates/config/index.html, src/web/app.py, src/web/templates/base.html</files>
  <action>
    **Route GET /config :**
    - Charger les Settings actuels depuis le Container
    - Vérifier l'existence des répertoires (downloads_dir, storage_dir, video_dir) via Path.exists()
    - Préparer les données pour le template : valeurs actuelles, statuts des chemins, masquage des clés API
    - Rendre le template config/index.html

    **Route POST /config :**
    - Recevoir les données du formulaire
    - Valider les entrées (min_file_size_mb > 0, match_score_threshold 0-100, etc.)
    - Écrire le fichier .env en préservant les commentaires (lire le .env actuel, remplacer les valeurs modifiées)
    - Redirect vers GET /config avec message flash (via query param ?saved=1)

    **Template config/index.html :**
    - Étend base.html avec block nav_config active
    - Formulaire groupé en sections avec fieldsets :
      1. Répertoires (downloads_dir, storage_dir, video_dir) — inputs type text avec indicateur existence (pastille verte/rouge)
      2. Base de données (database_url) — input readonly (information seulement)
      3. Clés API (tmdb_api_key, tvdb_api_key) — inputs type password avec toggle visibilité
      4. Traitement (min_file_size_mb, max_files_per_subdir, match_score_threshold) — inputs type number avec min/max
      5. Logging (log_level select, log_file, log_rotation_size, log_retention_count)
    - Bouton "Enregistrer" en POST
    - Message succès si ?saved=1
    - Messages erreur par champ si validation échoue

    **Intégration :**
    - Ajouter config_router dans app.py (include_router)
    - Ajouter lien "Config" dans base.html navbar (icône engrenage, après Bibliothèque)
    - Utiliser hx-post pour soumission HTMX si souhaité, sinon form POST classique

    **Pattern .env écriture :**
    - Lire le fichier .env ligne par ligne
    - Pour chaque ligne CINEORG_XXX=valeur, remplacer la valeur si modifiée
    - Préserver commentaires et lignes vides
    - Si une clé n'existe pas dans le .env mais est soumise, l'ajouter à la fin de la section appropriée

    **Masquage des clés API :**
    - En lecture : afficher "••••" + 4 derniers chars (ex: "••••3c3a")
    - Le champ password contient la vraie valeur pour l'envoi
    - Si le POST reçoit une valeur commençant par "••••", ne pas modifier cette clé (l'utilisateur n'a pas touché)

    **Éviter :**
    - Ne pas recharger les Settings en mémoire après sauvegarde (nécessiterait un restart du serveur, le mentionner dans un bandeau)
    - Ne pas stocker les clés API en clair dans le template HTML (utiliser type=password)
  </action>
  <verify>
    - uvicorn src.web.app:app --reload
    - Visiter /config : la page affiche les paramètres actuels groupés par section
    - Les répertoires affichent une pastille verte (existants) ou rouge
    - Les clés API sont masquées
    - Modifier un seuil et enregistrer : le .env est mis à jour
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4 satisfied</done>
</task>

<task type="auto">
  <name>Task 2: CSS pour la page configuration</name>
  <files>src/web/static/css/style.css</files>
  <action>
    Ajouter les styles CSS pour la page configuration :

    **Layout formulaire :**
    - .config-page : container centré, max-width ~800px
    - .config-section : fieldset groupé avec titre de section et bordure subtile
    - .config-section-title : titre de section (Répertoires, API, etc.)

    **Champs :**
    - .config-field : row flex (label + input + indicateur)
    - .config-label : label avec description courte
    - .config-input : input stylisé cohérent avec le thème sombre
    - .config-input-number : variante pour inputs numériques (largeur réduite)
    - .config-select : select stylisé (pour log_level)

    **Indicateurs :**
    - .config-status : pastille avec état (vert = existant, rouge = absent)
    - .config-api-status : indicateur clé API (configurée/non configurée)

    **Actions :**
    - .config-actions : bouton Enregistrer centré
    - .config-message-success : bandeau vert pour confirmation sauvegarde
    - .config-message-warning : bandeau info pour avertissement restart
    - .config-field-error : bordure rouge + message erreur inline

    Respecter le design system existant : variables CSS, DM Sans, thème sombre.
  </action>
  <verify>
    - La page config est visuellement cohérente avec le reste de l'application
    - Les sections sont clairement séparées
    - Les indicateurs de statut sont visibles
  </verify>
  <done>AC-1 satisfait visuellement, cohérence visuelle avec le thème</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Page de configuration web avec formulaire, sauvegarde .env, indicateurs de statut des chemins et clés API</what-built>
  <how-to-verify>
    1. Lancer : uvicorn src.web.app:app --reload
    2. Visiter : http://localhost:8000/config
    3. Vérifier : les paramètres actuels sont affichés correctement par section
    4. Vérifier : les répertoires ont une pastille verte/rouge selon existence
    5. Vérifier : les clés API sont masquées
    6. Tester : modifier un seuil (ex: min_file_size_mb), enregistrer, vérifier le .env
    7. Tester : saisir une valeur invalide (seuil négatif), vérifier le message d'erreur
    8. Vérifier : le lien "Config" est actif dans la navbar
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/config.py (classe Settings — structure existante conservée)
- src/web/routes/home.py, validation.py, workflow.py, transfer.py, library.py (routes stables)
- src/core/ (entités domaine)
- src/infrastructure/persistence/ (repositories et models)

## SCOPE LIMITS
- Lecture seule pour database_url (changement de DB nécessite restart et migration)
- Pas de test de connexion API (juste vérifier si la clé est renseignée)
- Pas de reload automatique des Settings en mémoire (mentionner le besoin de restart)
- Pas de gestion multi-environnement (.env.local, .env.production)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] /config affiche les paramètres groupés par section
- [ ] Les indicateurs de statut des chemins fonctionnent
- [ ] Les clés API sont masquées
- [ ] La sauvegarde modifie le fichier .env
- [ ] La validation rejette les entrées invalides
- [ ] Le lien Config est actif dans la navbar
- [ ] Le serveur démarre sans erreur
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Page visuellement cohérente avec le thème sombre existant
- Sauvegarde .env fiable et préservant les commentaires
</success_criteria>

<output>
After completion, create `.paul/phases/05-bibliotheque-maintenance/05-02-SUMMARY.md`
</output>
