---
phase: 05-bibliotheque-maintenance
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/maintenance.py
  - src/web/templates/maintenance/index.html
  - src/web/templates/maintenance/_check_results.html
  - src/web/templates/maintenance/_cleanup_results.html
  - src/web/app.py
  - src/web/templates/base.html
  - src/web/static/css/style.css
autonomous: false
---

<objective>
## Goal
Créer une page de maintenance web affichant les résultats des diagnostics d'intégrité (check) et de nettoyage (cleanup) de la vidéothèque, en mode lecture seule.

## Purpose
Les outils de maintenance (repair, check, cleanup) ne sont accessibles que via le CLI. Une page web permet de visualiser l'état de santé de la vidéothèque sans ouvrir un terminal. Les actions correctives restent dans le CLI (opérations destructives nécessitant confirmation interactive).

## Output
- Route `/maintenance` avec tableau de bord de santé
- Diagnostic d'intégrité : entrées fantômes, fichiers orphelins, symlinks cassés
- Analyse cleanup : symlinks cassés, mal placés, doublons, répertoires surdimensionnés, répertoires vides
- Exécution asynchrone des analyses (bouton "Lancer l'analyse" → résultats via HTMX)
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/05-bibliotheque-maintenance/05-01-SUMMARY.md

## Source Files
@src/services/integrity.py
@src/services/cleanup/cleanup_service.py
@src/services/cleanup/dataclasses.py
@src/services/repair/repair_service.py
@src/web/app.py
@src/web/templates/base.html
@src/container.py
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Avant création des templates maintenance | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Page maintenance avec tableau de bord
```gherkin
Given l'utilisateur visite /maintenance
When la page s'affiche
Then un tableau de bord montre deux sections : "Intégrité" et "Nettoyage"
And chaque section a un bouton "Lancer l'analyse"
And la navbar marque la page comme active (icône outil)
```

## AC-2: Diagnostic d'intégrité
```gherkin
Given l'utilisateur clique "Lancer l'analyse" dans la section Intégrité
When l'analyse est en cours
Then un spinner s'affiche pendant l'exécution
When l'analyse est terminée
Then les résultats s'affichent : nombre d'entrées fantômes, fichiers orphelins, symlinks cassés
And chaque catégorie liste les éléments concernés (chemins tronqués)
And un résumé indique "Aucun problème" ou "N problèmes détectés"
```

## AC-3: Analyse cleanup
```gherkin
Given l'utilisateur clique "Lancer l'analyse" dans la section Nettoyage
When l'analyse est terminée
Then les résultats s'affichent : symlinks cassés (avec score meilleur candidat), symlinks mal placés, doublons, répertoires surdimensionnés, répertoires vides
And un résumé global indique le nombre total de problèmes
And un message indique d'utiliser le CLI pour appliquer les corrections
```

## AC-4: Navigation active
```gherkin
Given l'utilisateur est sur /maintenance
When la page s'affiche
Then un lien "Maintenance" est visible dans la navbar avec la classe active
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Routes maintenance et templates</name>
  <files>src/web/routes/maintenance.py, src/web/templates/maintenance/index.html, src/web/templates/maintenance/_check_results.html, src/web/templates/maintenance/_cleanup_results.html, src/web/app.py, src/web/templates/base.html</files>
  <action>
    **Route GET /maintenance :**
    - Page principale avec deux sections (intégrité et nettoyage)
    - Chaque section a un bouton hx-get pour déclencher l'analyse

    **Route GET /maintenance/check :**
    - Instancier IntegrityChecker via le Container (ou directement avec les repos/config)
    - Appeler checker.check(verify_hash=False)
    - Retourner le fragment _check_results.html avec le rapport

    **Route GET /maintenance/cleanup :**
    - Instancier CleanupService et RepairService
    - Construire l'index fichier (build_file_index)
    - Appeler cleanup_svc.analyze(video_dir, max_per_dir)
    - Retourner le fragment _cleanup_results.html avec le rapport

    **Templates :**
    - index.html : page principale avec hero, deux cartes (Intégrité / Nettoyage), chaque carte a un bouton et une zone #check-results / #cleanup-results
    - _check_results.html : fragment avec résultat IntegrityReport (3 catégories : ghost_entries, orphan_files, broken_symlinks)
    - _cleanup_results.html : fragment avec résultat CleanupReport (5 catégories : broken, misplaced, duplicates, oversized, empty)

    **Intégration :**
    - Enregistrer maintenance_router dans app.py
    - Ajouter lien "Maintenance" dans base.html navbar (icône outil, après Config)
    - Les boutons utilisent hx-get + hx-target + hx-indicator pour afficher un spinner

    **Pattern HTMX :**
    - Bouton : hx-get="/maintenance/check" hx-target="#check-results" hx-indicator="#check-spinner"
    - Le spinner est un élément htmx-indicator qui s'affiche pendant la requête
    - Les analyses cleanup peuvent être longues (>10s) — utiliser un timeout HTMX adapté

    **Instanciation des services :**
    - Accéder au Container via request.app.state.container
    - IntegrityChecker : container.integrity_checker() si câblé, sinon instancier manuellement avec :
      - file_system = container.file_system()
      - video_file_repo = container.video_file_repository()
      - storage_dir, video_dir depuis Settings
    - CleanupService : instancier avec repair_service, organizer, repos depuis le container
    - Vérifier si ces services sont câblés dans container.py, sinon les instancier dans la route

    **Affichage des résultats :**
    - Chaque catégorie : icône + nombre + liste repliable (details/summary) des éléments
    - Chemins tronqués pour lisibilité (afficher juste les 2-3 derniers segments)
    - Badge couleur : vert "OK" si 0 problème, orange/rouge sinon
    - Message en bas de chaque rapport : "Pour corriger : cineorg check / cineorg cleanup --fix"

    **Éviter :**
    - Pas d'actions correctives depuis le web (repair, fix, delete)
    - Pas de verify_hash (trop lent pour le web)
  </action>
  <verify>
    - uvicorn src.web.app:app --reload
    - Visiter /maintenance : page avec deux sections
    - Cliquer "Lancer l'analyse" intégrité : résultats affichés
    - Cliquer "Lancer l'analyse" nettoyage : résultats affichés
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4 satisfied</done>
</task>

<task type="auto">
  <name>Task 2: CSS pour la page maintenance</name>
  <files>src/web/static/css/style.css</files>
  <action>
    Ajouter les styles pour la page maintenance :

    **Layout :**
    - .maintenance-page : container centré, max-width ~900px
    - .maintenance-cards : grille 2 colonnes (1 colonne sur mobile)

    **Cartes section :**
    - .maint-card : carte avec titre, description, bouton et zone résultats
    - .maint-card-header : icône + titre de section
    - .maint-analyze-btn : bouton "Lancer l'analyse" avec spinner htmx-indicator

    **Résultats :**
    - .maint-summary : bandeau résumé (vert OK / orange avertissement / rouge erreurs)
    - .maint-category : section par type de problème avec compteur
    - .maint-issue-list : liste repliable des éléments détectés
    - .maint-issue-path : chemin de fichier tronqué (code monospace)
    - .maint-cli-hint : message "utiliser le CLI pour corriger"

    **Spinner :**
    - .htmx-indicator : masqué par défaut, affiché pendant la requête HTMX
    - Animation de chargement (spinner CSS)

    Respecter le design system existant : variables CSS, DM Sans, thème sombre.
  </action>
  <verify>
    - Cohérence visuelle avec le thème sombre
    - Cartes bien alignées en grille
    - Spinner visible pendant l'analyse
  </verify>
  <done>AC-1, AC-2, AC-3 satisfaits visuellement</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Page maintenance web avec diagnostics intégrité et nettoyage en lecture seule, résultats via HTMX</what-built>
  <how-to-verify>
    1. Lancer : uvicorn src.web.app:app --reload
    2. Visiter : http://localhost:8000/maintenance
    3. Vérifier : deux sections avec boutons "Lancer l'analyse"
    4. Cliquer : bouton intégrité → spinner puis résultats (ghost, orphans, broken)
    5. Cliquer : bouton nettoyage → spinner puis résultats (5 catégories)
    6. Vérifier : icône outil dans la navbar, active sur /maintenance
    7. Vérifier : message CLI hint en bas des résultats
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/services/repair/ (service repair stable)
- src/services/integrity.py (service intégrité stable)
- src/services/cleanup/ (service cleanup stable)
- src/web/routes/home.py, validation.py, workflow.py, transfer.py, library.py, config.py (routes stables)
- src/core/ (entités domaine)
- src/infrastructure/persistence/ (repositories et models)

## SCOPE LIMITS
- Lecture seule : aucune action corrective depuis le web
- Pas de verify_hash (trop lent pour une requête web)
- Pas de rapport en cache (analyses à la demande uniquement)
- Les corrections se font via le CLI (repair-links, cleanup --fix)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] /maintenance affiche deux sections avec boutons d'analyse
- [ ] L'analyse intégrité retourne les 3 catégories de problèmes
- [ ] L'analyse nettoyage retourne les 5 catégories
- [ ] Le spinner s'affiche pendant l'analyse
- [ ] La navbar affiche un lien maintenance actif
- [ ] Le serveur démarre sans erreur
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Page visuellement cohérente avec le thème sombre existant
- Analyses fonctionnelles sans effets de bord
</success_criteria>

<output>
After completion, create `.paul/phases/05-bibliotheque-maintenance/05-03-SUMMARY.md`
</output>
