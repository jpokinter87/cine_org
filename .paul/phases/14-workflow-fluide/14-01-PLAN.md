---
phase: 14-workflow-fluide
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/routes/workflow.py
  - src/web/routes/validation.py
  - src/web/templates/workflow/_progress.html
  - src/web/templates/validation/list.html
  - src/web/templates/home.html
autonomous: false
---

<objective>
## Goal
Fluidifier l'enchaînement scan → validation → transfert en faisant apparaître un bouton d'accès rapide à l'étape suivante quand une étape se termine.

## Purpose
Aujourd'hui l'utilisateur doit naviguer manuellement entre les étapes du workflow (menu, breadcrumbs). Phase 14 ajoute des boutons contextuels bien visibles qui guident vers l'étape logique suivante, sans forcer de redirection automatique.

## Output
- Bouton "Passer au transfert" ou "Passer à la validation" apparaissant dans les résultats post-workflow
- Message + bouton "Passer au transfert" sur la page validation quand tous les fichiers sont traités
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Source Files
@src/web/routes/workflow.py
@src/web/routes/validation.py
@src/web/templates/workflow/_progress.html
@src/web/templates/validation/list.html
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Modification templates HTMX/CSS | ○ |

**BLOCKING:** /frontend-design MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Bouton accès rapide post-workflow — tout auto-validé
```gherkin
Given le workflow (scan → matching → auto-validation) vient de se terminer
When tous les fichiers ont été auto-validés (pending_remaining == 0)
Then un bouton proéminent "Passer au transfert →" apparaît dans les résultats
And ce bouton mène à /transfer
```

## AC-2: Bouton accès rapide post-workflow — pending restants
```gherkin
Given le workflow vient de se terminer
When des fichiers restent en attente de validation manuelle (pending_remaining > 0)
Then un bouton proéminent "Valider les fichiers en attente →" apparaît dans les résultats
And ce bouton mène à /validation
```

## AC-3: Message + bouton quand validation complète
```gherkin
Given l'utilisateur valide ou rejette le dernier fichier pending
When il est redirigé vers la liste de validation (qui est maintenant vide)
Then la page affiche un message "Tous les fichiers sont validés" avec un bouton "Passer au transfert →"
And ce bouton mène à /transfer
```

## AC-4: Navigation manuelle préservée
```gherkin
Given l'utilisateur est sur n'importe quelle page du workflow
When il utilise la navigation habituelle (menu, breadcrumbs, bouton retour)
Then la navigation fonctionne normalement — les boutons d'accès rapide sont un complément, pas un remplacement
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Bouton accès rapide dans les résultats post-workflow</name>
  <files>src/web/templates/workflow/_progress.html</files>
  <action>
    Dans le template `_progress.html`, modifier le handler JS de l'événement SSE `complete` :

    1. Dans la construction du HTML des résultats (après les compteurs scanned/auto_validated/pending) :
       - Si `pending_remaining == 0` : ajouter un bouton `<a href="/transfer" class="action-btn action-primary">Passer au transfert →</a>`
       - Si `pending_remaining > 0` : ajouter un bouton `<a href="/validation" class="action-btn action-primary">Valider les fichiers en attente →</a>`
    2. Le bouton doit être visuellement proéminent (class `action-primary` existante ou équivalent)
    3. Vérifier que le champ `pending_remaining` est bien envoyé dans les données SSE `complete` (déjà présent dans workflow.py)

    Note: Un lien "Valider les fichiers en attente" existe probablement déjà — le remplacer par un bouton plus visible et mieux positionné (en haut des résultats, pas en bas). Conserver le lien existant si différent.

    Avoid: Ne pas ajouter de timer ni de redirection automatique. C'est un bouton que l'utilisateur clique quand il est prêt.
  </action>
  <verify>
    Lancer le serveur, exécuter un workflow :
    - Cas 1 : Si tous auto-validés → vérifier présence bouton "Passer au transfert →" pointant vers /transfer
    - Cas 2 : Si pending restants → vérifier présence bouton "Valider les fichiers en attente →" pointant vers /validation
    - Vérifier que le bouton est bien visible et cliquable
  </verify>
  <done>AC-1 et AC-2 satisfaits : bouton d'accès rapide contextuel post-workflow</done>
</task>

<task type="auto">
  <name>Task 2: Message et bouton quand validation complète</name>
  <files>src/web/routes/validation.py, src/web/templates/validation/list.html</files>
  <action>
    1. Dans `validation.py`, route GET `/validation/` :
       - Quand la liste des pending est vide, passer `all_validated=True` au template
       - Vérifier aussi s'il y a des fichiers validés récents (validated_count > 0) pour distinguer "rien à valider car pas de scan" de "tout est validé"

    2. Dans le template `validation/list.html` :
       - Quand `all_validated` est True et que des fichiers validés existent :
         - Afficher un bloc de succès : "Tous les fichiers sont validés ✓"
         - Ajouter un bouton proéminent : `<a href="/transfer" class="action-btn action-primary">Passer au transfert →</a>`
       - Ce bloc remplace ou complète l'état vide existant (pas de doublon)

    Avoid: Ne pas modifier le comportement quand il reste des pending — le bouton n'apparaît QUE quand la liste est vide et qu'il y a des fichiers validés prêts au transfert.
  </action>
  <verify>
    - Valider le dernier fichier pending → retour sur /validation → vérifier message succès + bouton transfert
    - Accéder à /validation sans aucun pending ni validé → vérifier pas de bouton transfert (état vide normal)
    - Accéder à /validation avec des pending → vérifier affichage normal de la liste
  </verify>
  <done>AC-3 satisfait : message de succès et bouton transfert quand validation complète</done>
</task>

<task type="auto">
  <name>Task 3: Harmoniser le bouton bibliothèque sur la page d'accueil</name>
  <files>src/web/templates/home.html</files>
  <action>
    Sur la page d'accueil (`home.html`), le bouton "Parcourir la bibliothèque" utilise `action-secondary` (gris) alors que les boutons workflow et validation utilisent `action-primary` (jaune).

    Changer `action-secondary` → `action-primary` sur le lien bibliothèque (ligne 54) pour que les trois boutons d'accès rapide soient visuellement cohérents.

    Avoid: Ne toucher à rien d'autre dans home.html.
  </action>
  <verify>Ouvrir http://192.168.1.15:8000/ et vérifier que le bouton bibliothèque est jaune comme les deux autres</verify>
  <done>Bouton bibliothèque harmonisé en jaune (action-primary) avec les autres boutons d'accès rapide</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Boutons d'accès rapide post-workflow et post-validation guidant vers l'étape suivante</what-built>
  <how-to-verify>
    1. Lancer le serveur : `uv run uvicorn src.web.app:app --reload --host 0.0.0.0`
    2. Aller sur http://192.168.1.15:8000/workflow
    3. Lancer un workflow (scan)
    4. À la fin, observer le bouton d'accès rapide (vers /validation ou /transfer selon le résultat)
    5. Cliquer le bouton, vérifier la navigation
    6. Si des fichiers sont en attente : valider manuellement un par un
    7. Après le dernier, vérifier le message "Tous les fichiers sont validés" + bouton transfert
    8. Vérifier que la navigation normale (menu, retour) fonctionne toujours
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/services/workflow/ (logique métier workflow)
- src/adapters/cli/ (CLI ne doit pas être impacté)
- src/web/routes/library/ (package bibliothèque)
- src/web/routes/transfer.py (pas de modification du transfert)
- Logique d'auto-validation (seuil 85%, cascade séries)

## SCOPE LIMITS
- Pas de modification de la logique métier (scan, matching, validation, transfert)
- Pas de nouvelles pages — uniquement des ajouts dans les pages/templates existants
- Pas de redirection automatique ni de timer — uniquement des boutons cliquables
- Pas de modification du SSE transfer (hors scope)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] Workflow complet : bouton accès rapide vers /validation ou /transfer
- [ ] Validation complète : message succès + bouton vers /transfer
- [ ] Bouton bibliothèque jaune (action-primary) sur la page d'accueil
- [ ] Navigation manuelle préservée (menu, breadcrumbs, retour)
- [ ] `uv run pytest` — aucune régression
- [ ] `uv run ruff check src/web/routes/` — pas d'erreur lint
</verification>

<success_criteria>
- Toutes les tâches complétées
- Toutes les vérifications passent
- Pas d'erreurs ni d'avertissements introduits
- L'enchaînement workflow → validation → transfert est guidé par des boutons contextuels
- La navigation manuelle reste fonctionnelle
</success_criteria>

<output>
After completion, create `.paul/phases/14-workflow-fluide/14-01-SUMMARY.md`
</output>
