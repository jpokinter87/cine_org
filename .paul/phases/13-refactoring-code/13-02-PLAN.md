---
phase: 13-refactoring-code
plan: 02
type: execute
wave: 1
depends_on: ["13-01"]
files_modified:
  - src/web/routes/library.py (supprimé)
  - src/web/routes/library/__init__.py
  - src/web/routes/library/helpers.py
  - src/web/routes/library/browse.py
  - src/web/routes/library/detail.py
  - src/web/routes/library/player.py
  - src/web/routes/library/reassociate.py
autonomous: true
---

<objective>
## Goal
Découper `library.py` (1250 lignes) en un package `library/` de 6 modules spécialisés.

## Purpose
Un fichier de 1250 lignes est difficile à naviguer et maintenir. Le découpage en modules cohérents (helpers, browse, detail, player, reassociate) améliore la lisibilité sans changer le comportement.

## Output
- Package `src/web/routes/library/` avec 6 fichiers
- `library.py` supprimé
- Aucun changement de comportement
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/13-refactoring-code/13-01-SUMMARY.md (pending_factory extrait)

## Source Files
@src/web/routes/library.py (1250 lignes — le fichier à découper)
@src/web/app.py (ligne 18 : import du router)
</context>

<acceptance_criteria>

## AC-1: Package library/ fonctionnel
```gherkin
Given library.py est un fichier monolithique de 1250 lignes
When il est découpé en package library/ avec 6 modules
Then app.py importe toujours `from .routes.library import router as library_router` sans modification
And toutes les routes existantes fonctionnent identiquement
```

## AC-2: Aucune régression
```gherkin
Given le code est restructuré en modules séparés
When on exécute la suite de tests complète
Then tous les tests passent (875+)
And ruff check ne signale aucune erreur sur les nouveaux fichiers
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Créer le package library/ et distribuer le code</name>
  <files>
    src/web/routes/library/__init__.py,
    src/web/routes/library/helpers.py,
    src/web/routes/library/browse.py,
    src/web/routes/library/detail.py,
    src/web/routes/library/player.py,
    src/web/routes/library/reassociate.py
  </files>
  <action>
    1. **Créer `library/helpers.py`** (~120 lignes) :
       - Déplacer : `_title_search_filter`, `_parse_genres`, `_get_storage_genre_info`, `_genre_json_escaped`, `_format_duration`, `_resolution_label`, `_resolution_pixels`, `_poster_url`, `_best_rating`
       - Imports nécessaires : json, sqlmodel, models, constants, utils.helpers

    2. **Créer `library/browse.py`** (~280 lignes) :
       - Créer un `router = APIRouter()` (sans prefix, sera inclus par __init__)
       - Déplacer : `library_index` (route `GET /`)
       - Importer les helpers depuis `helpers.py`

    3. **Créer `library/detail.py`** (~215 lignes) :
       - Créer un `router = APIRouter()`
       - Déplacer : `_find_movie_file`, `movie_detail` (`GET /movies/{movie_id}`), `series_detail` (`GET /series/{series_id}`)
       - Importer helpers depuis `helpers.py` et player helpers depuis `player.py`

    4. **Créer `library/player.py`** (~240 lignes) :
       - Créer un `router = APIRouter()`
       - Déplacer : `_resolve_video_path`, `_launch_player`, `_play_button_html`, `_playing_html`, `play_status` (`GET /play-status/{pid}`), `movie_play` (`POST /movies/{movie_id}/play`), `episode_play` (`POST /episodes/{episode_id}/play`), `_get_file_duration`, `_duration_indicator`, `_series_indicator`, `_get_local_series_counts`

    5. **Créer `library/reassociate.py`** (~360 lignes) :
       - Créer un `router = APIRouter()`
       - Déplacer : les 6 routes reassociate (movie overlay/search/apply + series overlay/search/apply)
       - Importer `_remove_from_quality_cache` depuis quality.py (ajuster le chemin relatif)

    6. **Créer `library/__init__.py`** :
       - Créer un `router = APIRouter(prefix="/library")`
       - Inclure les sous-routers : `router.include_router(browse.router)`, etc.
       - Exporter `router` pour que `app.py` fonctionne sans modification

    7. **Supprimer `library.py`** (l'ancien fichier monolithique)

    **Points d'attention :**
    - Les imports relatifs changent : `from ...infrastructure` devient `from ....infrastructure` (un niveau de plus)
    - Chaque sous-module a ses propres imports (ne pas tout importer dans __init__)
    - `templates` est importé depuis `..deps` → `...deps` dans les sous-modules
    - Les fonctions privées partagées entre modules (ex: helpers utilisés par detail et browse) vont dans `helpers.py`
    - Les indicateurs (`_duration_indicator`, `_series_indicator`, `_get_local_series_counts`) sont utilisés par `detail.py` mais définis logiquement avec le player → les mettre dans `helpers.py` si partagés, sinon dans le module consommateur
  </action>
  <verify>
    uv run pytest tests/ -x -q
    uv run ruff check src/web/routes/library/
    python -c "from src.web.routes.library import router; print('OK:', len(router.routes), 'routes')"
  </verify>
  <done>AC-1 et AC-2 satisfaits : package fonctionnel, tests passent, lint propre</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/web/app.py (l'import `from .routes.library import router` ne doit pas changer)
- src/web/routes/quality.py (stable)
- src/web/routes/workflow.py (refactoré en Plan 01)
- src/services/ (stable)
- tests/ (aucun test ne devrait changer — le refactoring est transparent)

## SCOPE LIMITS
- Pas de nouveau comportement — refactoring pur
- Pas de modification des templates HTML
- Pas de renommage de routes ou endpoints
- Pas de modification de la logique métier

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run pytest tests/ -x` passe (tous les tests)
- [ ] `uv run ruff check src/web/routes/library/` propre
- [ ] `from src.web.routes.library import router` fonctionne
- [ ] `library.py` supprimé
- [ ] Toutes les routes existantes préservées
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- 875+ tests passent (0 échecs)
</success_criteria>

<output>
After completion, create `.paul/phases/13-refactoring-code/13-02-SUMMARY.md`
</output>
