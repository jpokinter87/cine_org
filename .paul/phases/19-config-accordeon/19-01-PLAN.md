---
phase: 19-config-accordeon
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/web/templates/config/index.html
  - src/web/templates/base.html
  - src/web/static/css/style.css
  - src/web/app.py
autonomous: false
---

<objective>
## Goal
Restructurer la page /config avec des sections pliables (accordéon) pour réduire le scroll et améliorer la lisibilité.

## Purpose
La page config a 6 sections empilées verticalement qui nécessitent beaucoup de scroll. Un accordéon permet de n'afficher que la section active, réduisant la charge visuelle.

## Output
- Sections config pliables/dépliables au clic sur le titre
- Première section ouverte par défaut, les autres fermées
- Animation fluide d'ouverture/fermeture
- Bouton "Enregistrer" toujours visible
- Version dynamique dans le footer (lue depuis pyproject.toml, plus de hardcode)
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md

## Source Files
@src/web/templates/config/index.html
@src/web/templates/base.html
@src/web/routes/config.py
@src/web/app.py
@src/web/static/css/style.css
@pyproject.toml
</context>

<skills>
## Required Skills (from SPECIAL-FLOWS.md)

| Skill | Priority | When to Invoke | Loaded? |
|-------|----------|----------------|---------|
| /frontend-design | required | Modification template + CSS | ○ |

**BLOCKING:** Required skills MUST be loaded before APPLY proceeds.

## Skill Invocation Checklist
- [ ] /frontend-design loaded
</skills>

<acceptance_criteria>

## AC-1: Sections pliables
```gherkin
Given la page /config est affichée
When l'utilisateur arrive sur la page
Then la première section (Répertoires) est ouverte
And les 5 autres sections sont fermées (titre visible, contenu masqué)
```

## AC-2: Toggle au clic
```gherkin
Given une section fermée sur la page /config
When l'utilisateur clique sur le titre de la section
Then la section s'ouvre avec une animation fluide
And les autres sections restent dans leur état actuel
```

## AC-3: Contenu préservé
```gherkin
Given les sections en accordéon
When l'utilisateur ouvre une section et modifie un champ
Then la valeur est préservée quand la section est refermée puis rouverte
And le formulaire POST /config envoie toutes les valeurs (sections ouvertes ou fermées)
```

## AC-4: Section Lecteur intégrée
```gherkin
Given la section Lecteur (profils, hors formulaire principal)
When la page /config est affichée en accordéon
Then la section Lecteur est aussi pliable
And les interactions HTMX des profils fonctionnent normalement
```

## AC-5: Version dynamique dans le footer
```gherkin
Given le footer de l'application web
When n'importe quelle page est affichée
Then le numéro de version affiché correspond à celui de pyproject.toml
And il n'y a plus de version hardcodée dans base.html
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Transformer les sections en accordéon (template + CSS)</name>
  <files>src/web/templates/config/index.html, src/web/static/css/style.css</files>
  <action>
    1. Dans index.html, transformer chaque `<fieldset class="config-section">` en accordéon :
       - Ajouter un élément cliquable sur le `<legend>` pour toggle
       - Envelopper le contenu des champs dans un conteneur collapsible
       - La première section (Répertoires) a le conteneur visible par défaut
       - Les autres sections ont le conteneur masqué par défaut
       - La section Lecteur (hors formulaire) doit suivre le même pattern

    2. Approche recommandée : JS minimal avec classes CSS
       - Classe `.config-section-collapsed` pour masquer le contenu
       - Toggle via onclick sur la légende
       - Le `<legend>` reçoit un chevron indicateur d'état (▸/▾)
       - IMPORTANT : ne PAS utiliser `<details>/<summary>` car le fieldset est dans un form et le comportement natif peut interférer

    3. CSS : animation d'ouverture/fermeture
       - max-height transition pour l'animation fluide
       - Rotation du chevron en transition
       - Légende cliquable avec curseur pointer et feedback hover

    4. CRITIQUE : les inputs dans les sections fermées doivent rester dans le DOM
       - Ne PAS retirer les éléments du DOM (display:none OK, remove() interdit)
       - Le formulaire POST doit envoyer TOUTES les valeurs
  </action>
  <verify>
    Vérification visuelle dans le navigateur :
    - Section Répertoires ouverte par défaut
    - Clic sur une légende ouvre/ferme la section
    - Les inputs restent fonctionnels
    - Le formulaire envoie toutes les valeurs
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4 satisfaits</done>
</task>

<task type="auto">
  <name>Task 2: Version dynamique dans le footer</name>
  <files>src/web/app.py, src/web/templates/base.html, pyproject.toml</files>
  <action>
    1. Lire la version depuis pyproject.toml au démarrage de l'app :
       - Utiliser `importlib.metadata.version("cine-org")` (standard library, lit pyproject.toml)
       - OU lire pyproject.toml avec tomllib (Python 3.11+)
       - Stocker dans une variable globale ou un context processor Jinja2

    2. Passer la version au template via un global Jinja2 :
       - Dans app.py, ajouter `app_version` aux globals Jinja2 (templates.env.globals)
       - Ainsi la variable est disponible dans tous les templates sans modifier chaque route

    3. Dans base.html, remplacer le "CineOrg v1.4" hardcodé par `{{ app_version }}`

    4. Mettre à jour pyproject.toml : version = "1.5.0" (version actuelle du milestone)
  </action>
  <verify>uv run python -c "from importlib.metadata import version; print(version('cine-org'))"</verify>
  <done>AC-5 satisfait</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Page /config avec sections en accordéon + version dynamique footer</what-built>
  <how-to-verify>
    1. Visiter http://localhost:8111/config
    2. Seule la section "Répertoires" est ouverte, les autres fermées
    3. Cliquer sur "Clés API" → la section s'ouvre avec animation
    4. Cliquer sur "Répertoires" → la section se ferme
    5. Modifier un champ dans une section, fermer/rouvrir → valeur préservée
    6. Enregistrer → toutes les valeurs sont envoyées (pas de régression)
    7. Section Lecteur pliable et fonctionnelle (ajout/édition/suppression profils)
    8. Vérifier le footer : affiche "CineOrg v1.5.0" (lu depuis pyproject.toml)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/web/routes/config.py (route et logique back-end inchangées)
- Logique de sauvegarde .env
- Structure des profils lecteur (player_profiles.html)

## SCOPE LIMITS
- Pas de réorganisation des sections (ordre conservé)
- Pas de nouvelles fonctionnalités config
- Pas de modification des champs existants

</boundaries>

<verification>
Before declaring plan complete:
- [ ] uv run pytest --tb=short -q (pas de régression)
- [ ] Vérification visuelle (checkpoint human-verify)
- [ ] Formulaire POST envoie toutes les valeurs
- [ ] All acceptance criteria met
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Sections config pliables avec animation
- Aucune régression sur la sauvegarde
- Version footer lue dynamiquement depuis pyproject.toml
</success_criteria>

<output>
After completion, create `.paul/phases/19-config-accordeon/19-01-SUMMARY.md`
</output>
